<!DOCTYPE html><html lang="en-US" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="MTCNN Joint Face Detection and Alignment using Multi-task Cascaded Convolutional Networks" /><meta name="author" content="darkknightzh" /><meta property="og:locale" content="en_US" /><meta name="description" content="仅供学习交流使用，错误之处在所难免，欢迎指正." /><meta property="og:description" content="仅供学习交流使用，错误之处在所难免，欢迎指正." /><link rel="canonical" href="https://darkknightzh.github.io/posts/MTCNN/" /><meta property="og:url" content="https://darkknightzh.github.io/posts/MTCNN/" /><meta property="og:site_name" content="darkknightzh" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-24T16:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="MTCNN Joint Face Detection and Alignment using Multi-task Cascaded Convolutional Networks" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"darkknightzh"},"dateModified":"2021-09-10T16:13:24+08:00","datePublished":"2021-08-24T16:00:00+08:00","description":"仅供学习交流使用，错误之处在所难免，欢迎指正.","headline":"MTCNN Joint Face Detection and Alignment using Multi-task Cascaded Convolutional Networks","mainEntityOfPage":{"@type":"WebPage","@id":"https://darkknightzh.github.io/posts/MTCNN/"},"url":"https://darkknightzh.github.io/posts/MTCNN/"}</script><title>MTCNN Joint Face Detection and Alignment using Multi-task Cascaded Convolutional Networks | darkknightzh</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] }, // chtml: { displayAlign: 'left' } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">darkknightzh</a></div><div class="site-subtitle font-italic">忘记一个人，从忘记那个声音开始</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>主页</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>时间轴</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/darkknightzh" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>MTCNN Joint Face Detection and Alignment using Multi-task Cascaded Convolutional Networks</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>MTCNN Joint Face Detection and Alignment using Multi-task Cascaded Convolutional Networks</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> darkknightzh </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Aug 24, 2021, 4:00 PM +0800" prep="on" > Aug 24, 2021 <i class="unloaded">2021-08-24T16:00:00+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Sep 10, 2021, 4:13 PM +0800" prefix="Updated " > Sep 10, 2021 <i class="unloaded">2021-09-10T16:13:24+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5886 words">32 min</span></div></div><div class="post-content"><style> h1 { border-bottom: none }</style><p>转载请注明出处：</p><p><a href="https://darkknightzh.github.io/posts/MTCNN">https://darkknightzh.github.io/posts/MTCNN</a></p><p>论文：</p><p><a href="https://arxiv.org/abs/1604.02878">https://arxiv.org/abs/1604.02878</a></p><p>第三方pytorch代码：</p><p><a href="https://github.com/timesler/facenet-pytorch">https://github.com/timesler/facenet-pytorch</a></p><h1 id="p1-摘要">P1. 摘要</h1><p>该文提出MTCNN，一个级联的CNN结构，能检测人脸并得到人脸关键点信息。其包括三个阶段。第一阶段通过若干层CNN网络得到候选人脸框。第二阶段通过更复杂的CNN网络，优化候选框，去除大量非人脸窗。第三阶段，通过更强大的CNN网络进一步优化检测结果并输出人脸面部关键点信息。</p><h1 id="p2-mtcnn">P2. MTCNN</h1><h2 id="p21-整体结构">P2.1 整体结构</h2><p>图1显示了整体结构，给定输入图像，首先将其缩放到不同大小，得到图像金字塔，该金字塔为下属三阶段级联结构的输入：</p><p><strong>第一阶段（stage 1</strong>）：使用全卷积网络的P-Net（Proposal Network，候选窗网络）得到候选窗和bbox回归向量，并使用bbox回归向量矫正候选框。再使用nms抑制重合度过高的候选框。</p><p><strong>第二阶段（stage 2）</strong>：所有候选框通过R-Net（Refinement Network，优化网络），进一步抑制大量非人脸，并使用bbox回归来矫正bbox、使用nms抑制候选框。</p><p><strong>第三阶段（stage 3）</strong>：和第二阶段差不多，此步骤主要是通过O-net（Output Network，输出网络）输出最终的人脸框和5个面部关键点位置。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-24-MTCNN/1mtcnn.png" alt="1" /> <em>图1</em></p><h2 id="p22-cnn结构">P2.2 CNN结构</h2><p>文献<a href="http://users.eecs.northwestern.edu/~xsh835/assets/cvpr2015_cascnn.pdf">http://users.eecs.northwestern.edu/~xsh835/assets/cvpr2015_cascnn.pdf</a>中使用了多个CNN结构进行人脸检测，但以下原因可能会限制其性能：① 一些滤波器缺乏多样性的权重，限制模型得到更具判别性的特征。② 相比于其他目标检测和分类任务，人脸检测是二分类任务，需要更少数量的滤波器，同时需要滤波器更具有判别性。因而本文降低了滤波器数量，并且将5*5卷积换成3*3卷积，来降低计算量，同时增加网络深度，来得到更好的性能。本文的CNN结构如图2所示。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-24-MTCNN/2cnn.png" alt="2" /> <em>图2</em></p><h2 id="p23-训练">P2.3 训练</h2><p>本文通过三个子任务来训练CNN网络：人脸/非人脸分类、边界框拟合、面部关键点定位。</p><p><strong>人脸检测</strong>：人脸检测为二分类问题，对每个样本 \({ {x}_{i}}\) ，使用交叉熵损失：</p>\[L_{i}^{det}=-\left( y_{i}^{det}\log \left( { {p}_{i}} \right)+\left( 1-y_{i}^{det} \right)\left( 1-\log \left( { {p}_{i}} \right) \right) \right) \tag{1}\]<p>其中 \({ {p}_{i}}\) 为通过网络得到的该样本是人脸的概率。 \(y_{i}^{det}\in \left\{ 0,1 \right\}\) 代表GT标签。</p><p><strong>边界框拟合</strong>：预测每个候选框和最近的GT框（如框的左上角坐标、宽、高）的偏移。其为拟合问题，对每个样本 \({ {x}_{i}}\) ，损失函数如下：</p>\[L_{i}^{box}=\left\| \hat{y}_{i}^{box}-y_{i}^{box} \right\|_{2}^{2} \tag{2}\]<p>其中 \(\hat{y}_{i}^{box}\)为网络拟合的目标框， \(y_{i}^{box}\)为人脸的GT坐标。此处有左上角xy坐标、宽、高共4个值，因而 \(y_{i}^{box}\in { {\mathbb{R}}^{4}}\) 。</p><p><strong>人脸关键点定位</strong>：和边界框拟合的任务类似，面部关键点定位也是拟合问题，损失函数如下：</p>\[L_{i}^{landmark}=\left\| \hat{y}_{i}^{landmark}-y_{i}^{landmark} \right\|_{2}^{2} \tag{3}\]<p>其中 \(\hat{y}_{i}^{landmark}\) 为网络拟合的关键点坐标， \(y_{i}^{landmark}\) 为人脸关键点的GT坐标。此处有左眼、右眼、鼻子、左嘴角、右嘴角共5组值，因而 \(y_{i}^{landmark}\in { {\mathbb{R}}^{10}}\) 。</p><p><strong>多源训练（Multi-source training）</strong>：由于每个CNN中使用不同的任务进行训练，训练阶段有不同类型的图像，比如人脸、非人脸、部分对齐的人脸，因而部分损失函数（公式1-3）未使用。比如，对于背景区域的图像，只计算 \(L_{i}^{det}\) ，其他两个损失都设置为0。这可以通过样本类型指示器完成。因而最终的目标函数为：</p>\[\min \sum\nolimits_{i=1}^{N}{\sum\nolimits_{j\in \left\{ det,box,landmark \right\}}{ { {\alpha }_{j}}\beta _{i}^{j}L_{i}^{j}}} \tag{4}\]<p>其中N为训练样本的数量， \({ {\alpha }_{j}}\) 为任务的重要程度。本文在P-Net和R-Net中使用 \(\left( { {\alpha }_{det}}=1,{ {\alpha }_{box}}=0.5,{ {\alpha }_{landmark}}=0.5 \right)\) ；在O-Net中为了保证人脸关键点定位的准确性，使用 \(\left( { {\alpha }_{det}}=1,{ {\alpha }_{box}}=0.5,{ {\alpha }_{landmark}}=1 \right)\) 。 \(\beta _{i}^{j}\in \left\{ 0,1 \right\}\) 为样本类型指示器。本文使用sgd训练模型。</p><p><strong>在线难例挖掘</strong>：本文在人脸检测任务中使用在线难例挖掘。在每个batch中，对所有样本前向计算得到的损失进行排序，取前70%的作为困难样本。反向传播时只计算困难样本的梯度。</p><h1 id="p3-代码">P3. 代码</h1><h2 id="p31-检测结果">P3.1 检测结果</h2><p>使用如下代码可检测人脸，并显示。</p><h3 id="代码折叠">代码折叠</h3><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="n">models.mtcnn</span> <span class="kn">import</span> <span class="n">MTCNN</span>
<span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="sh">'</span><span class="s">data/multiface.jpg</span><span class="sh">'</span><span class="p">)</span>
<span class="n">mtcnn</span> <span class="o">=</span> <span class="nc">MTCNN</span><span class="p">(</span><span class="n">keep_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>      <span class="c1"># 初始化MTCNN类
</span><span class="n">batch_boxes</span><span class="p">,</span> <span class="n">batch_probs</span><span class="p">,</span> <span class="n">batch_points</span> <span class="o">=</span> <span class="n">mtcnn</span><span class="p">.</span><span class="nf">detect</span><span class="p">(</span><span class="n">img</span><span class="p">[...,::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">landmarks</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># 返回检测到的bbox[K,4]、是人脸的得分[K]、人脸关键点坐标[K,5,2]
</span><span class="n">batch_boxes</span> <span class="o">=</span> <span class="n">batch_boxes</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int32</span><span class="p">)</span>   <span class="c1"># 检测到的bbox[K,4]  k为检测到的人脸数量
</span><span class="n">batch_points</span> <span class="o">=</span> <span class="n">batch_points</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int32</span><span class="p">)</span>  <span class="c1"># 检测到的人脸关键点坐标[K,5,2]
</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">batch_probs</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>   <span class="c1"># 依次遍历每个检测到的人脸
</span>    <span class="n">_rect</span> <span class="o">=</span> <span class="n">batch_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="c1"># 当前人脸框  [4]
</span>    <span class="n">cv2</span><span class="p">.</span><span class="nf">rectangle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">_rect</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">_rect</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">_rect</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">facial</span> <span class="o">=</span> <span class="n">batch_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    <span class="c1"># 当前人脸关键点  [5,2]
</span>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">cv2</span><span class="p">.</span><span class="nf">circle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">facial</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">facial</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
 
<span class="n">cv2</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="sh">'</span><span class="s">img</span><span class="sh">'</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
<span class="n">cv2</span><span class="p">.</span><span class="nf">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cv2</span><span class="p">.</span><span class="nf">destroyAllWindows</span><span class="p">()</span>
</pre></table></code></div></div></details><p>检测结果如图3：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-24-MTCNN/3result.png" alt="2" /> <em>图3</em></p><p>上述代码调用models/mtcnn.py中的MTCNN类，该类可使用forward函数得到裁剪的人脸，或者使用detect函数得到检测到的bbox、是人脸的得分、人脸关键点坐标等信息。下面进行介绍。</p><h2 id="p32-mtcnn类">P3.2 MTCNN类</h2><p>MTCNN初始化如下，主要用于初始化pnet，rnet，onet三个网络。</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MTCNN</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">MTCNN face detection module.

    This class loads pretrained P-, R-, and O-nets and returns images cropped to include the face
    only, given raw input images of one of the following types:
        - PIL image or list of PIL images
        - numpy.ndarray (uint8) representing either a single image (3D) or a batch of images (4D).
    Cropped faces can optionally be saved to file
    also.
    
    Keyword Arguments:
        image_size {int} -- Output image size in pixels. The image will be square. (default: {160})
        margin {int} -- Margin to add to bounding box, in terms of pixels in the final image. Note that the application of the margin differs slightly from the davidsandberg/facenet
            repo, which applies the margin to the original image before resizing, making the margin dependent on the original image size (this is a bug in davidsandberg/facenet).
            (default: {0})
        min_face_size {int} -- Minimum face size to search for. (default: {20})
        thresholds {list} -- MTCNN face detection thresholds (default: {[0.6, 0.7, 0.7]})
        factor {float} -- Factor used to create a scaling pyramid of face sizes. (default: {0.709})
        post_process {bool} -- Whether or not to post process images tensors before returning.
            (default: {True})
        select_largest {bool} -- If True, if multiple faces are detected, the largest is returned.
            If False, the face with the highest detection probability is returned.
            (default: {True})
        selection_method {string} -- Which heuristic to use for selection. Default None. If
            specified, will override select_largest:
                    </span><span class="sh">"</span><span class="s">probability</span><span class="sh">"</span><span class="s">: highest probability selected
                    </span><span class="sh">"</span><span class="s">largest</span><span class="sh">"</span><span class="s">: largest box selected
                    </span><span class="sh">"</span><span class="s">largest_over_threshold</span><span class="sh">"</span><span class="s">: largest box over a certain probability selected
                    </span><span class="sh">"</span><span class="s">center_weighted_size</span><span class="sh">"</span><span class="s">: box size minus weighted squared offset from image center
                (default: {None})
        keep_all {bool} -- If True, all detected faces are returned, in the order dictated by the
            select_largest parameter. If a save_path is specified, the first face is saved to that
            path and the remaining faces are saved to &lt;save_path&gt;1, &lt;save_path&gt;2 etc.
            (default: {False})
        device {torch.device} -- The device on which to run neural net passes. Image tensors and
            models are copied to this device before running forward passes. (default: {None})
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">image_size</span><span class="o">=</span><span class="mi">160</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_face_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">thresholds</span><span class="o">=</span><span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.709</span><span class="p">,</span> <span class="n">post_process</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">select_largest</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                 <span class="n">selection_method</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">keep_all</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">image_size</span> <span class="o">=</span> <span class="n">image_size</span>
        <span class="n">self</span><span class="p">.</span><span class="n">margin</span> <span class="o">=</span> <span class="n">margin</span>
        <span class="n">self</span><span class="p">.</span><span class="n">min_face_size</span> <span class="o">=</span> <span class="n">min_face_size</span>
        <span class="n">self</span><span class="p">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="n">thresholds</span>   <span class="c1"># p-net, R-net, O-net的三个阈值
</span>        <span class="n">self</span><span class="p">.</span><span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span>    <span class="c1"># 创建人脸金字塔时缩放比例
</span>        <span class="n">self</span><span class="p">.</span><span class="n">post_process</span> <span class="o">=</span> <span class="n">post_process</span>
        <span class="n">self</span><span class="p">.</span><span class="n">select_largest</span> <span class="o">=</span> <span class="n">select_largest</span>
        <span class="n">self</span><span class="p">.</span><span class="n">keep_all</span> <span class="o">=</span> <span class="n">keep_all</span>
        <span class="n">self</span><span class="p">.</span><span class="n">selection_method</span> <span class="o">=</span> <span class="n">selection_method</span>   <span class="c1"># 默认None
</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pnet</span> <span class="o">=</span> <span class="nc">PNet</span><span class="p">()</span>   <span class="c1"># 三个检测网络
</span>        <span class="n">self</span><span class="p">.</span><span class="n">rnet</span> <span class="o">=</span> <span class="nc">RNet</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">onet</span> <span class="o">=</span> <span class="nc">ONet</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">device</span><span class="p">(</span><span class="sh">'</span><span class="s">cpu</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">selection_method</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">selection_method</span> <span class="o">=</span> <span class="sh">'</span><span class="s">largest</span><span class="sh">'</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">select_largest</span> <span class="k">else</span> <span class="sh">'</span><span class="s">probability</span><span class="sh">'</span>
</pre></table></code></div></div></details><h2 id="p33-p-net">P3.3 P-Net</h2><p>该函数和图2中pnet不同，没有人脸关键点坐标。网络如图4。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-24-MTCNN/4pnet.png" alt="4" /> <em>图4 pnet</em></p><p>代码如下:</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">PNet</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>  <span class="c1"># 该函数和论文不一样，未预测人脸关键点坐标
</span>    <span class="sh">"""</span><span class="s">MTCNN PNet.
    
    Keyword Arguments:
        pretrained {bool} -- Whether or not to load saved pretrained weights (default: {True})
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prelu1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">PReLU</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pool1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ceil_mode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prelu2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">PReLU</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prelu3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">PReLU</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv4_1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">softmax4_1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv4_2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">training</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">pretrained</span><span class="p">:</span>
            <span class="n">state_dict_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="sh">'</span><span class="s">../data/pnet.pt</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">state_dict_path</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prelu1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pool1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prelu2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prelu3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv4_1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>    <span class="c1"># 是否人脸
</span>        <span class="n">a</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">softmax4_1</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>   <span class="c1"># 是否人脸的概率
</span>        <span class="n">b</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv4_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>   <span class="c1"># bbox预测
</span>        <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>   <span class="c1"># 返回预测的bbox，是否人脸的概率
</span></pre></table></code></div></div></details><h2 id="p34-r-net">P3.4 R-Net</h2><p>该函数和图2中rnet不同，没有人脸关键点坐标。网络如图5。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-24-MTCNN/5rnet.png" alt="5" /> <em>图5 rnet</em></p><p>代码如下：</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">RNet</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">MTCNN RNet.
    
    Keyword Arguments:
        pretrained {bool} -- Whether or not to load saved pretrained weights (default: {True})
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prelu1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">PReLU</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pool1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">MaxPool2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ceil_mode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prelu2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">PReLU</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pool2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">MaxPool2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ceil_mode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prelu3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">PReLU</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dense4</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="mi">576</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prelu4</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">PReLU</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dense5_1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">softmax5_1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dense5_2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">training</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">pretrained</span><span class="p">:</span>
            <span class="n">state_dict_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="sh">'</span><span class="s">../data/rnet.pt</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">state_dict_path</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prelu1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pool1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prelu2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pool2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prelu3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>   <span class="c1"># BCHW
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="nf">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">contiguous</span><span class="p">()</span>   <span class="c1"># BHWC
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">dense4</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>   <span class="c1"># [B,HWC]
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prelu4</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>    <span class="c1"># [B,HWC]
</span>        <span class="n">a</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">dense5_1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>   <span class="c1"># 是否人脸
</span>        <span class="n">a</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">softmax5_1</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># 是否人脸的概率
</span>        <span class="n">b</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">dense5_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># bbox预测
</span>        <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>  <span class="c1"># 返回预测的bbox，是否人脸的概率
</span></pre></table></code></div></div></details><h2 id="p35-o-net">P3.5 O-Net</h2><p>该函数和图2中onet相同。网络如图6。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-24-MTCNN/6onet.png" alt="6" /> <em>图6 onet</em></p><p>代码如下：</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ONet</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">MTCNN ONet.
    
    Keyword Arguments:
        pretrained {bool} -- Whether or not to load saved pretrained weights (default: {True})
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prelu1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">PReLU</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pool1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">MaxPool2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ceil_mode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prelu2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">PReLU</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pool2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">MaxPool2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ceil_mode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prelu3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">PReLU</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pool3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ceil_mode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv4</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prelu4</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">PReLU</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dense5</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="mi">1152</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prelu5</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">PReLU</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dense6_1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">softmax6_1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dense6_2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dense6_3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">training</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">pretrained</span><span class="p">:</span>
            <span class="n">state_dict_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="sh">'</span><span class="s">../data/onet.pt</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">state_dict_path</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prelu1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pool1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prelu2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pool2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prelu3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pool3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv4</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prelu4</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>     <span class="c1"># BCHW
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="nf">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">contiguous</span><span class="p">()</span>   <span class="c1"># BHWC
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">dense5</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># [B,HWC]
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">prelu5</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>     <span class="c1"># [B,HWC]
</span>        <span class="n">a</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">dense6_1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>     <span class="c1"># 是否人脸
</span>        <span class="n">a</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">softmax6_1</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>    <span class="c1"># 是否人脸的概率
</span>        <span class="n">b</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">dense6_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>    <span class="c1"># bbox预测
</span>        <span class="n">c</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">dense6_3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>   <span class="c1"># 人脸关键点预测
</span>        <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span>  <span class="c1"># 返回预测的bbox，预测的人脸关键点，是否人脸的概率
</span></pre></table></code></div></div></details><h2 id="p36-detect函数">P3.6 detect函数</h2><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">detect</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">landmarks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>  <span class="c1"># 检测PIL图像的人脸，返回bbox和可选的面部关键点
</span>        <span class="sh">"""</span><span class="s">Detect all faces in PIL image and return bounding boxes and optional facial landmarks.

        This method is used by the forward method and is also useful for face detection tasks that require lower-level handling of bounding boxes and facial 
        landmarks (e.g., face tracking). The functionality of the forward function can be emulated by using this method followed by the extract_face() function.
        
        Arguments:
            img {PIL.Image, np.ndarray, or list} -- A PIL image, np.ndarray, torch.Tensor, or list.

        Keyword Arguments:
            landmarks {bool} -- Whether to return facial landmarks in addition to bounding boxes. (default: {False})
        
        Returns:
            tuple(numpy.ndarray, list) -- For N detected faces, a tuple containing an Nx4 array of bounding boxes and a length N list of detection probabilities.
                Returned boxes will be sorted in descending order by detection probability if self.select_largest=False, otherwise the largest face will be returned first.
                If `img` is a list of images, the items returned have an extra dimension (batch) as the first dimension. Optionally, a third item, the facial landmarks,
                are returned if `landmarks=True`.

        Example:
</span><span class="gp">        &gt;&gt;&gt;</span> <span class="kn">from</span> <span class="n">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
        <span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="n">facenet_pytorch</span> <span class="kn">import</span> <span class="n">MTCNN</span><span class="p">,</span> <span class="n">extract_face</span>
        <span class="o">&gt;&gt;&gt;</span> <span class="n">mtcnn</span> <span class="o">=</span> <span class="nc">MTCNN</span><span class="p">(</span><span class="n">keep_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="o">&gt;&gt;&gt;</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">points</span> <span class="o">=</span> <span class="n">mtcnn</span><span class="p">.</span><span class="nf">detect</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">landmarks</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="o">&gt;&gt;&gt;</span> <span class="c1"># Draw boxes and save faces
</span>        <span class="o">&gt;&gt;&gt;</span> <span class="n">img_draw</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
        <span class="o">&gt;&gt;&gt;</span> <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="p">.</span><span class="nc">Draw</span><span class="p">(</span><span class="n">img_draw</span><span class="p">)</span>
        <span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">points</span><span class="p">)):</span>
        <span class="p">...</span>     <span class="n">draw</span><span class="p">.</span><span class="nf">rectangle</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="nf">tolist</span><span class="p">(),</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">...</span>     <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">point</span><span class="p">:</span>
        <span class="p">...</span>         <span class="n">draw</span><span class="p">.</span><span class="nf">rectangle</span><span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="mi">10</span><span class="p">).</span><span class="nf">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">10</span><span class="p">).</span><span class="nf">tolist</span><span class="p">(),</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="p">...</span>     <span class="nf">extract_face</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="sh">'</span><span class="s">detected_face_{}.png</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="o">&gt;&gt;&gt;</span> <span class="n">img_draw</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sh">'</span><span class="s">annotated_faces.png</span><span class="sh">'</span><span class="p">)</span>
        <span class="sh">"""</span>

        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
            <span class="n">batch_boxes</span><span class="p">,</span> <span class="n">batch_points</span> <span class="o">=</span> <span class="nf">detect_face</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">min_face_size</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">pnet</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">rnet</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">onet</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">factor</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>   <span class="c1">#  最终检测的box[B,K,5]和人脸关键点[B,K,5,2]  
</span>
        <span class="n">boxes</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">points</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">box</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">batch_boxes</span><span class="p">,</span> <span class="n">batch_points</span><span class="p">):</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">box</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">boxes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
                <span class="n">probs</span><span class="p">.</span><span class="nf">append</span><span class="p">([</span><span class="bp">None</span><span class="p">])</span>
                <span class="n">points</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">select_largest</span><span class="p">:</span>
                <span class="n">box_order</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">argsort</span><span class="p">((</span><span class="n">box</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">box</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 人脸面积从大到小的索引
</span>                <span class="n">box</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="n">box_order</span><span class="p">]</span>
                <span class="n">point</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="n">box_order</span><span class="p">]</span>
                <span class="n">boxes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">box</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">probs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">box</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">])</span>
                <span class="n">points</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">boxes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">box</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">probs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">box</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">])</span>
                <span class="n">points</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>  <span class="c1"># [B,K,4]
</span>        <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>  <span class="c1"># [B,K]
</span>        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>  <span class="c1"># [B,K,5,2]  
</span>
        <span class="nf">if </span><span class="p">(</span><span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nf">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="nf">len</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)):</span> <span class="c1"># 去掉batch
</span>            <span class="n">boxes</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [K,4]
</span>            <span class="n">probs</span> <span class="o">=</span> <span class="n">probs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [K]
</span>            <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [K,5,2]  
</span>
        <span class="k">if</span> <span class="n">landmarks</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">points</span>  <span class="c1"># 返回检测到的bbox[K,4]、是人脸的得分[K]、人脸关键点坐标[K,5,2]
</span>
        <span class="k">return</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">probs</span>  <span class="c1"># 返回检测到的bbox[K,4]、是人脸的得分[K]
</span></pre></table></code></div></div></details><h2 id="p37-detect_face函数">P3.7 detect_face函数</h2><p>detect函数调用detect_face，其流程如图如7所示。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-24-MTCNN/7facedetect.png" alt="7" /> <em>图7</em></p><p>代码如下：</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">detect_face</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">minsize</span><span class="p">,</span> <span class="n">pnet</span><span class="p">,</span> <span class="n">rnet</span><span class="p">,</span> <span class="n">onet</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">imgs</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">as_tensor</span><span class="p">(</span><span class="n">imgs</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span><span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">imgs</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">as_tensor</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>   <span class="c1"># HWC转BHWC
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">imgs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">"</span><span class="s">MTCNN batch processing only compatible with equal-dimension images.</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">stack</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="nf">uint8</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">])</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">as_tensor</span><span class="p">(</span><span class="n">imgs</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="n">model_dtype</span> <span class="o">=</span> <span class="nf">next</span><span class="p">(</span><span class="n">pnet</span><span class="p">.</span><span class="nf">parameters</span><span class="p">()).</span><span class="n">dtype</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">.</span><span class="nf">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nf">type</span><span class="p">(</span><span class="n">model_dtype</span><span class="p">)</span>   <span class="c1"># BCHW
</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mf">12.0</span> <span class="o">/</span> <span class="n">minsize</span>   <span class="c1"># minsize默认20，m=0.6
</span>    <span class="n">minl</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>   <span class="c1"># 图像宽高的最小值
</span>    <span class="n">minl</span> <span class="o">=</span> <span class="n">minl</span> <span class="o">*</span> <span class="n">m</span>
    
    <span class="n">scale_i</span> <span class="o">=</span> <span class="n">m</span>  
    <span class="n">scales</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># 图像金字塔的缩放比例 Create scale pyramid
</span>    <span class="k">while</span> <span class="n">minl</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">:</span>
        <span class="n">scales</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">scale_i</span><span class="p">)</span>
        <span class="n">scale_i</span> <span class="o">=</span> <span class="n">scale_i</span> <span class="o">*</span> <span class="n">factor</span>
        <span class="n">minl</span> <span class="o">=</span> <span class="n">minl</span> <span class="o">*</span> <span class="n">factor</span>   <span class="c1"># minl按照factor依次缩小，直到不超过12为止
</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># First stage
</span>    <span class="n">image_inds</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">scale_picks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">all_i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">scale</span> <span class="ow">in</span> <span class="n">scales</span><span class="p">:</span>
        <span class="n">im_data</span> <span class="o">=</span> <span class="nf">imresample</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nf">int</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>  <span class="c1"># 将图像缩放到指定大小
</span>        <span class="n">im_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_data</span> <span class="o">-</span> <span class="mf">127.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0078125</span>   <span class="c1"># 缩放图像像素
</span>        <span class="n">reg</span><span class="p">,</span> <span class="n">probs</span> <span class="o">=</span> <span class="nf">pnet</span><span class="p">(</span><span class="n">im_data</span><span class="p">)</span>   <span class="c1"># 得到pnet预测的bbox、是否人脸的概率
</span>        
        <span class="c1"># 9=2（起点坐标）+2（终点坐标）+1（分值）+4（回归的归一化坐标偏移）
</span>        <span class="n">boxes_scale</span><span class="p">,</span> <span class="n">image_inds_scale</span> <span class="o">=</span> <span class="nf">generateBoundingBox</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">probs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">scale</span><span class="p">,</span> <span class="n">threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>   <span class="c1"># [k,9]的bbox, [k]的图像在当前batch中的索引，probs[:, 1]为人脸的概率（0为背景的概率）
</span>        <span class="n">boxes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">boxes_scale</span><span class="p">)</span>
        <span class="n">image_inds</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">image_inds_scale</span><span class="p">)</span>

        <span class="n">pick</span> <span class="o">=</span> <span class="nf">batched_nms</span><span class="p">(</span><span class="n">boxes_scale</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">boxes_scale</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">image_inds_scale</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>   <span class="c1"># boxes_scale[:, :4]为x1,y1,x2,y2格式。pick为nms后保留的box的索引
</span>        <span class="n">scale_picks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">pick</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="n">boxes_scale</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">boxes</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   <span class="c1"># [k,9]
</span>    <span class="n">image_inds</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">image_inds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   <span class="c1"># [k]
</span>
    <span class="n">scale_picks</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">scale_picks</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   <span class="c1"># [k2]   k2&lt;=k
</span>    
    <span class="n">boxes</span><span class="p">,</span> <span class="n">image_inds</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">scale_picks</span><span class="p">],</span> <span class="n">image_inds</span><span class="p">[</span><span class="n">scale_picks</span><span class="p">]</span>   <span class="c1"># [k2,9]  [k2]   nms抑制之后的bbox和当前batch中的图像索引  # NMS within each scale + image
</span>
    <span class="n">pick</span> <span class="o">=</span> <span class="nf">batched_nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">image_inds</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>   <span class="c1"># 再一次nms   # NMS within each image
</span>    <span class="n">boxes</span><span class="p">,</span> <span class="n">image_inds</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">pick</span><span class="p">],</span> <span class="n">image_inds</span><span class="p">[</span><span class="n">pick</span><span class="p">]</span>  <span class="c1"># [k3,9]  [k3]   k3&lt;=k2
</span>
    <span class="n">regw</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>   <span class="c1"># 预测的框的宽高
</span>    <span class="n">regh</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">qq1</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">regw</span>   <span class="c1"># [k3]  预测框的坐标    # 预测的坐标 + 预测的归一化偏移 * 预测的宽高
</span>    <span class="n">qq2</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">regh</span>
    <span class="n">qq3</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="n">regw</span>
    <span class="n">qq4</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="n">regh</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">stack</span><span class="p">([</span><span class="n">qq1</span><span class="p">,</span> <span class="n">qq2</span><span class="p">,</span> <span class="n">qq3</span><span class="p">,</span> <span class="n">qq4</span><span class="p">,</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]]).</span><span class="nf">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [k3,5]   预测框+预测分值
</span>    <span class="n">boxes</span> <span class="o">=</span> <span class="nf">rerec</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>   <span class="c1"># 对boxes进行偏移，得到正方形的box  [k3,5]
</span>    <span class="n">y</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="nf">pad</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>     <span class="c1"># 得到限制在图像内的坐标，均为[k3]
</span>    
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>    <span class="c1"># Second stage
</span>        <span class="n">im_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">ey</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ex</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>   <span class="c1"># 终点坐标大于起点坐标
</span>                <span class="n">img_k</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="n">image_inds</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">:,</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span><span class="n">ey</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span><span class="n">ex</span><span class="p">[</span><span class="n">k</span><span class="p">]].</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>     <span class="c1"># 得到pnet检测后的人脸图像
</span>                <span class="n">im_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">imresample</span><span class="p">(</span><span class="n">img_k</span><span class="p">,</span> <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">)))</span>    <span class="c1"># 将图像缩放到24*24
</span>        <span class="n">im_data</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">im_data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   <span class="c1"># [k3,3,24,24]
</span>        <span class="n">im_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_data</span> <span class="o">-</span> <span class="mf">127.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0078125</span>   <span class="c1"># 缩放图像像素
</span>
        <span class="c1"># 为了避免显存不足，将图像做了类似batch的方式，通过rnet，得到输出  out[0]代表在当前图像上回归的归一化检测框偏移：[k3,4]   out[1]代表是人脸的概率（0为背景，1为人脸）：[k3,2]
</span>        <span class="n">out</span> <span class="o">=</span> <span class="nf">fixed_batch_process</span><span class="p">(</span><span class="n">im_data</span><span class="p">,</span> <span class="n">rnet</span><span class="p">)</span>    <span class="c1"># This is equivalent to out = rnet(im_data) to avoid GPU out of memory.
</span>
        <span class="n">out0</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>   <span class="c1"># [4,k3]
</span>        <span class="n">out1</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>   <span class="c1"># [2,k3]
</span>        <span class="n">score</span> <span class="o">=</span> <span class="n">out1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>   <span class="c1"># 人脸的概率
</span>        <span class="n">ipass</span> <span class="o">=</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># 人脸得分大于阈值的mask
</span>        <span class="n">boxes</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">((</span><span class="n">boxes</span><span class="p">[</span><span class="n">ipass</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">score</span><span class="p">[</span><span class="n">ipass</span><span class="p">].</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># 通过rnet筛选后的人脸box  [k4,5]
</span>        <span class="n">image_inds</span> <span class="o">=</span> <span class="n">image_inds</span><span class="p">[</span><span class="n">ipass</span><span class="p">]</span>  <span class="c1"># 通过rnet筛选后的当前batch中的图像索引
</span>        <span class="n">mv</span> <span class="o">=</span> <span class="n">out0</span><span class="p">[:,</span> <span class="n">ipass</span><span class="p">].</span><span class="nf">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>   <span class="c1"># 回归的归一化偏移  [k4,4]
</span>
        <span class="n">pick</span> <span class="o">=</span> <span class="nf">batched_nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">image_inds</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>  <span class="c1"># 再一次nms  [k5]   # NMS within each image
</span>        <span class="n">boxes</span><span class="p">,</span> <span class="n">image_inds</span><span class="p">,</span> <span class="n">mv</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">pick</span><span class="p">],</span> <span class="n">image_inds</span><span class="p">[</span><span class="n">pick</span><span class="p">],</span> <span class="n">mv</span><span class="p">[</span><span class="n">pick</span><span class="p">]</span>   <span class="c1"># [k5,5]  [k5]  [k5,4]
</span>        <span class="n">boxes</span> <span class="o">=</span> <span class="nf">bbreg</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">mv</span><span class="p">)</span>   <span class="c1"># 结合回归的归一化偏移mv，对boxes进行修正  [k5,5] 
</span>        <span class="n">boxes</span> <span class="o">=</span> <span class="nf">rerec</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span>       <span class="c1"># 对boxes进行偏移，得到正方形的box  [k5,5] 
</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>   <span class="c1"># 人脸关键点坐标
</span>    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">boxes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>   <span class="c1"># Third stage
</span>        <span class="n">y</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ex</span> <span class="o">=</span> <span class="nf">pad</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>    <span class="c1"># 得到限制在图像内的坐标，均为[k5]
</span>        <span class="n">im_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">ey</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ex</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">img_k</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="n">image_inds</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">:,</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span><span class="n">ey</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span><span class="n">ex</span><span class="p">[</span><span class="n">k</span><span class="p">]].</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>     <span class="c1"># 得到rnet检测后的人脸图像
</span>                <span class="n">im_data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">imresample</span><span class="p">(</span><span class="n">img_k</span><span class="p">,</span> <span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">)))</span>    <span class="c1"># 将图像缩放到48*48
</span>        <span class="n">im_data</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">im_data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># [k5,3,48,48]
</span>        <span class="n">im_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_data</span> <span class="o">-</span> <span class="mf">127.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0078125</span>   <span class="c1"># 缩放图像像素
</span>        
        
        <span class="c1"># 为了避免显存不足，将图像做了类似batch的方式，通过onet，得到输出   # This is equivalent to out = onet(im_data) to avoid GPU out of memory.
</span>        <span class="c1"># out[0]代表回归的归一化检测框偏移：[k5,4]  out[1]代表在当前图像上回归的归一化人脸关键点坐标：[k5,10]   out[2]代表是人脸的概率（0为背景，1为人脸）：[k5,2]
</span>        <span class="n">out</span> <span class="o">=</span> <span class="nf">fixed_batch_process</span><span class="p">(</span><span class="n">im_data</span><span class="p">,</span> <span class="n">onet</span><span class="p">)</span>

        <span class="n">out0</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>   <span class="c1">#  [4,k5]
</span>        <span class="n">out1</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>   <span class="c1">#  [10,k5]
</span>        <span class="n">out2</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>   <span class="c1">#  [2,k5]
</span>        <span class="n">score</span> <span class="o">=</span> <span class="n">out2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>   <span class="c1"># 人脸的概率
</span>        <span class="n">points</span> <span class="o">=</span> <span class="n">out1</span>   <span class="c1"># 人脸关键点坐标  [10,k5]
</span>        <span class="n">ipass</span> <span class="o">=</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>   <span class="c1"># 人脸得分大于阈值的mask
</span>        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[:,</span> <span class="n">ipass</span><span class="p">]</span>   <span class="c1"># 人脸关键点坐标  [10,k6]
</span>        <span class="n">boxes</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">((</span><span class="n">boxes</span><span class="p">[</span><span class="n">ipass</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">score</span><span class="p">[</span><span class="n">ipass</span><span class="p">].</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>    <span class="c1"># 通过onet筛选后的人脸box  [k6,5]
</span>        <span class="n">image_inds</span> <span class="o">=</span> <span class="n">image_inds</span><span class="p">[</span><span class="n">ipass</span><span class="p">]</span>    <span class="c1"># 通过onet筛选后的当前batch中的图像索引
</span>        <span class="n">mv</span> <span class="o">=</span> <span class="n">out0</span><span class="p">[:,</span> <span class="n">ipass</span><span class="p">].</span><span class="nf">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>    <span class="c1"># 回归的偏移  [k6,4]
</span>
        <span class="n">w_i</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># 人脸框宽高
</span>        <span class="n">h_i</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">points_x</span> <span class="o">=</span> <span class="n">w_i</span><span class="p">.</span><span class="nf">repeat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">points</span><span class="p">[:</span><span class="mi">5</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">repeat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>   <span class="c1"># points为归一化坐标，*w_i得到当前图像上的绝对坐标。+boxes得到在原始图像上的绝对坐标   [5,k6]
</span>        <span class="n">points_y</span> <span class="o">=</span> <span class="n">h_i</span><span class="p">.</span><span class="nf">repeat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">points</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">repeat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">stack</span><span class="p">((</span><span class="n">points_x</span><span class="p">,</span> <span class="n">points_y</span><span class="p">)).</span><span class="nf">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">#  [k6,5,2] 
</span>        <span class="n">boxes</span> <span class="o">=</span> <span class="nf">bbreg</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">mv</span><span class="p">)</span>  <span class="c1"># 结合回归的归一化偏移mv，对boxes进行修正  [k6,5] 
</span>
        <span class="c1"># pick = batched_nms(boxes[:, :4], boxes[:, 4], image_inds, 0.7)   # NMS within each image using "Min" strategy
</span>        <span class="n">pick</span> <span class="o">=</span> <span class="nf">batched_nms_numpy</span><span class="p">(</span><span class="n">boxes</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">image_inds</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="sh">'</span><span class="s">Min</span><span class="sh">'</span><span class="p">)</span>   <span class="c1"># [k7]
</span>        <span class="n">boxes</span><span class="p">,</span> <span class="n">image_inds</span><span class="p">,</span> <span class="n">points</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">pick</span><span class="p">],</span> <span class="n">image_inds</span><span class="p">[</span><span class="n">pick</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="n">pick</span><span class="p">]</span>  <span class="c1"># 得到nms抑制后的box、当前batch中的图像索引、人脸关键点坐标
</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">.</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">()</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">.</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">()</span>

    <span class="n">image_inds</span> <span class="o">=</span> <span class="n">image_inds</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()</span>

    <span class="n">batch_boxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">batch_points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">b_i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">b_i_inds</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">image_inds</span> <span class="o">==</span> <span class="n">b_i</span><span class="p">)</span>
        <span class="n">batch_boxes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">b_i_inds</span><span class="p">].</span><span class="nf">copy</span><span class="p">())</span>
        <span class="n">batch_points</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">b_i_inds</span><span class="p">].</span><span class="nf">copy</span><span class="p">())</span>

    <span class="n">batch_boxes</span><span class="p">,</span> <span class="n">batch_points</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">batch_boxes</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">batch_points</span><span class="p">)</span>   <span class="c1"># 最终检测的box[B,K7,5]和人脸关键点[B,K7,5,2]  
</span>
    <span class="k">return</span> <span class="n">batch_boxes</span><span class="p">,</span> <span class="n">batch_points</span>
</pre></table></code></div></div></details><h2 id="p38-imresample函数">P3.8 imresample函数</h2><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">imresample</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">sz</span><span class="p">):</span>   <span class="c1"># 将图像缩放到指定大小
</span>    <span class="n">im_data</span> <span class="o">=</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sz</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="sh">"</span><span class="s">area</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">im_data</span>
</pre></table></code></div></div></details><h2 id="p39-generateboundingbox函数">P3.9 generateBoundingBox函数</h2><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">generateBoundingBox</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
    <span class="n">stride</span> <span class="o">=</span> <span class="mi">2</span>     <span class="c1"># pnet只有一个stride=2的maxpool，输出分辨率降低一半，因而此处stride=2
</span>    <span class="n">cellsize</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c1"># pnet默认输入大小就是12*12，因而此处是12
</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>   <span class="c1"># BCHW转CBHW   C=4   reg为归一化的位置偏移
</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">probs</span> <span class="o">&gt;=</span> <span class="n">thresh</span>    <span class="c1"># 大于阈值的人脸mask   BHW
</span>    <span class="n">mask_inds</span> <span class="o">=</span> <span class="n">mask</span><span class="p">.</span><span class="nf">nonzero</span><span class="p">()</span>   <span class="c1"># 由于mask是BHW，因而mask_inds[k,3]，k为mask中非零的个数（即检测到的人脸数量），3指BHW三个维度的索引，也指代特征图上人脸的整数位置（需要结合reg得到检测的人脸位置）
</span>    <span class="n">image_inds</span> <span class="o">=</span> <span class="n">mask_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>   <span class="c1"># B维度的索引
</span>    <span class="n">score</span> <span class="o">=</span> <span class="n">probs</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>   <span class="c1"># 大于阈值的人脸得分，[k]
</span>    <span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">].</span><span class="nf">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>   <span class="c1"># CBHW取BHW的索引，得到[C,k]，permute后为[k,C]，C=4
</span>    <span class="n">bb</span> <span class="o">=</span> <span class="n">mask_inds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:].</span><span class="nf">type</span><span class="p">(</span><span class="n">reg</span><span class="p">.</span><span class="n">dtype</span><span class="p">).</span><span class="nf">flip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># mask_inds[:, 1:]为HW的索引，并在W维度进行flip，得到WH的索引
</span>    <span class="n">q1</span> <span class="o">=</span> <span class="p">((</span><span class="n">stride</span> <span class="o">*</span> <span class="n">bb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span><span class="p">).</span><span class="nf">floor</span><span class="p">()</span>    <span class="c1"># 得到当前框的在原始图像上起点坐标
</span>    <span class="n">q2</span> <span class="o">=</span> <span class="p">((</span><span class="n">stride</span> <span class="o">*</span> <span class="n">bb</span> <span class="o">+</span> <span class="n">cellsize</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span><span class="p">).</span><span class="nf">floor</span><span class="p">()</span>   <span class="c1"># 得到当前框的在原始图像上终点坐标（因pnet默认输入为12*12，故此处使用+cellsize-1得到终点坐标）
</span>    <span class="n">boundingbox</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">([</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">score</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reg</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># [k,9]  9=2（起点坐标）+2（终点坐标）+1（分值）+4（回归的归一化坐标偏移）
</span>    <span class="k">return</span> <span class="n">boundingbox</span><span class="p">,</span> <span class="n">image_inds</span>   <span class="c1"># [k,9]的bbox, [k]的图像在当前batch中的索引
</span></pre></table></code></div></div></details><h2 id="p310-rerec函数">P3.10 rerec函数</h2><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">rerec</span><span class="p">(</span><span class="n">bboxA</span><span class="p">):</span>   <span class="c1"># 由于人脸框是正方形，此处将非正方形偏移起点，得到正方形的框
</span>    <span class="n">h</span> <span class="o">=</span> <span class="n">bboxA</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxA</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>   <span class="c1"># 框宽高  [k]
</span>    <span class="n">w</span> <span class="o">=</span> <span class="n">bboxA</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxA</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    
    <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>   <span class="c1"># 宽高较大值   [k]
</span>    <span class="n">bboxA</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bboxA</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">l</span> <span class="o">*</span> <span class="mf">0.5</span>   <span class="c1"># 左上角坐标按照宽高的较大值进行偏移
</span>    <span class="n">bboxA</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bboxA</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">l</span> <span class="o">*</span> <span class="mf">0.5</span>
    <span class="n">bboxA</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">bboxA</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">l</span><span class="p">.</span><span class="nf">repeat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>   <span class="c1"># 对框终点进行偏移   [k,2]
</span>
    <span class="k">return</span> <span class="n">bboxA</span>  <span class="c1"># 正方形的框
</span></pre></table></code></div></div></details><h2 id="p311-pad函数">P3.11 pad函数</h2><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>   <span class="c1"># 限制框在图像内
</span>    <span class="n">boxes</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">.</span><span class="nf">trunc</span><span class="p">().</span><span class="nf">int</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">()</span>   <span class="c1"># trunc进行截断（类似取整）
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>   <span class="c1"># 起点
</span>    <span class="n">y</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># 终点
</span>    <span class="n">ey</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># 限制起点范围
</span>    <span class="n">y</span><span class="p">[</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ex</span><span class="p">[</span><span class="n">ex</span> <span class="o">&gt;</span> <span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>   <span class="c1"># 限制终点范围
</span>    <span class="n">ey</span><span class="p">[</span><span class="n">ey</span> <span class="o">&gt;</span> <span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>

    <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ex</span>   <span class="c1"># 得到限制范围后的坐标
</span></pre></table></code></div></div></details><h2 id="p312-bbreg函数">P3.12 bbreg函数</h2><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">bbreg</span><span class="p">(</span><span class="n">boundingbox</span><span class="p">,</span> <span class="n">reg</span><span class="p">):</span>  <span class="c1"># 结合回归的reg，对boundingbox进行修正
</span>    <span class="k">if</span> <span class="n">reg</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">reg</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="n">w</span> <span class="o">=</span> <span class="n">boundingbox</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boundingbox</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>   <span class="c1"># 人脸宽高
</span>    <span class="n">h</span> <span class="o">=</span> <span class="n">boundingbox</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">boundingbox</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>   
    <span class="n">b1</span> <span class="o">=</span> <span class="n">boundingbox</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">reg</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span>   <span class="c1"># 修正后的人脸坐标
</span>    <span class="n">b2</span> <span class="o">=</span> <span class="n">boundingbox</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">reg</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span>
    <span class="n">b3</span> <span class="o">=</span> <span class="n">boundingbox</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">reg</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span>
    <span class="n">b4</span> <span class="o">=</span> <span class="n">boundingbox</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">reg</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span>
    <span class="n">boundingbox</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">stack</span><span class="p">([</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">]).</span><span class="nf">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">boundingbox</span>   <span class="c1"># 修正后的bbox
</span></pre></table></code></div></div></details><h2 id="p313-fixed_batch_process函数">P3.13 fixed_batch_process函数</h2><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">fixed_batch_process</span><span class="p">(</span><span class="n">im_data</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>   <span class="c1"># 为了避免gpu显存不足，将输入图像做了batch的方式，通过model，得到输出
</span>    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">512</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">im_data</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">im_data</span><span class="p">[</span><span class="n">i</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">)]</span>
        <span class="n">out</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">model</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span>

    <span class="k">return</span> <span class="nf">tuple</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="o">*</span><span class="n">out</span><span class="p">))</span>
</pre></table></code></div></div></details></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div class="post-tags"> <span>标签(Tags)</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a href="/tags/deep-learning/" class="post-tag no-text-decoration" >deep learning</a> <a href="/tags/algorithm/" class="post-tag no-text-decoration" >algorithm</a> <a href="/tags/detection/" class="post-tag no-text-decoration" >detection</a></div></div><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/UbuntuAgent/">Ubuntu使用代理</a><li><a href="/posts/SunloginDisconnectWin10/">windows10使用向日葵访问ubuntu 20.04显示连接已断开</a><li><a href="/posts/TimeWin10Ubuntu/">windows10和ubuntu双系统的时间差</a><li><a href="/posts/markdown/">markdown基本语法</a><li><a href="/posts/MountDriverInWin10Ubuntu/">windows10的ubuntu子系统挂载移动硬盘</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/deep-learning/">deep learning</a> <a class="post-tag" href="/tags/detection/">detection</a> <a class="post-tag" href="/tags/normalization/">normalization</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/transformers/">transformers</a> <a class="post-tag" href="/tags/demo/">demo</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h6 align="left"><br>未设置提醒，因而不一定能看到回复，见谅</h6><div class="post-navigation d-flex justify-content-between"> <a href="/posts/CornerNet/" class="btn btn-outline-primary" prompt="Older"><p>CornerNet: Detecting Objects as Paired Keypoints</p></a> <a href="/posts/YOLOV1/" class="btn btn-outline-primary" prompt="Newer"><p>YOLOV1 You Only Look Once: Unified, Real-Time Object Detection</p></a></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script> <script src="https://code.jquery.com/jquery-3.2.0.min.js"></script> <script>AV.initialize("7DUQTBuCCKLjnutJOa6ko5cn-MdYXbMMI", "lxmthTQ8ESa2HrVQiIVyXtYo");</script> <script> //新增访问次数 function addCount(Counter) { // 页面（博客文章）中的信息：leancloud_visitors // id为page.url， data-flag-title为page.title var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(Counter); // 只根据文章的url查询LeanCloud服务器中的数据 query.equalTo("post_url", url); query.find({ success: function(results) { if (results.length > 0) {//说明LeanCloud中已经记录了这篇文章 var counter = results[0]; counter.fetchWhenSave(true); counter.increment("visited_times");// 将点击次数加1 counter.save(null, { success: function(counter) { var $element = $(document.getElementById(url)); var newTimes = counter.get('visited_times'); $element.find('.leancloud-visitors-count').text(newTimes); }, error: function(counter, error) { console.log('Failed to save Visitor num, with error message: ' + error.message); } }); } else { // 执行这里，说明LeanCloud中还没有记录此文章 var newcounter = new Counter(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); newcounter.setACL(acl); /* End Set ACL */ newcounter.set("post_title", title);// 把文章标题 newcounter.set("post_url", url); // 文章url newcounter.set("visited_times", 1); // 初始点击次数：1次 newcounter.save(null, { // 上传到LeanCloud服务器中 success: function(newcounter) { var $element = $(document.getElementById(url)); var newTimes = newcounter.get('visited_times'); $element.find('.leancloud-visitors-count').text(newTimes); }, error: function(newcounter, error) { console.log('Failed to create'); } }); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); } }); } //仅根据url和title查出当前访问次数，不做+1操作 function showCount(Counter) { var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(Counter); // 只根据文章的url查询LeanCloud服务器中的数据 query.equalTo("post_url", url); query.find({ success: function(results) { if (results.length > 0) {//说明LeanCloud中已经记录了这篇文章 var counter = results[0]; var $element = $(document.getElementById(url)); var newTimes = counter.get('visited_times'); $element.find('.leancloud-visitors-count').text(newTimes); } else { //如果表里没查到记录，那就是异常情况了 console.log('异常情况，不应该没记录的'); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); } }); } //调用API获取IP function getVisitorIpAndJudge() { var ip; var options = { type: 'POST', dataType: "json", //async: false, //jquery3中可以直接使用回调函数，不用再指定async url: "https://freegeoip.net/json/?callback=?" }; $.ajax(options) .done(function(data, textStatus, jqXHR) { if(textStatus == "success") { ip = data.ip; } judgeVisitor(ip) }); } //判断访客是否已访问过该文章，及访问时间，符合条件则增加一次访问次数 function judgeVisitor(ip) { var Counter = AV.Object.extend("visited_times"); var Visitor = AV.Object.extend("visitors_record"); var $postInfo = $(".leancloud_visitors"); var post_url = $postInfo.attr('id').trim(); var query = new AV.Query(Visitor); query.equalTo("visitor_ip", ip); query.equalTo("post_url", post_url); query.find({ success: function(results) { if (results.length > 0) { console.log('该IP已访问过该文章'); var oldVisitor = results[0]; var lastTime = oldVisitor.updatedAt; var curTime = new Date(); var timePassed = curTime.getTime() - lastTime.getTime(); if(timePassed > 1 * 60 * 1000) { console.log('距离该IP上一次访问该文章已超过了1分钟，更新访问记录，并增加访问次数'); addCount(Counter); oldVisitor.fetchWhenSave(true); oldVisitor.save(null, { success: function(oldVisitor) { }, error: function(oldVisitor, error) { console.log('Failed to save visitor record, with error message: ' + error.message); } }); } else { console.log('这是该IP 1分钟内重复访问该文章，不更新访问记录，不增加访问次数'); showCount(Counter); } } else { console.log('该IP第一次访问该文章，保存新的访问记录，并增加访问次数'); addCount(Counter); var newVisitor = new Visitor(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); newVisitor.setACL(acl); newVisitor.set("visitor_ip", ip); newVisitor.set("post_url", post_url); newVisitor.save(null, { // 上传到LeanCloud服务器中 success: function(newVisitor) { }, error: function(newVisitor, error) { console.log('Failed to create visitor record, with error message: ' + error.message); } }); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); addCount(Counter); } }); } $(function() { if ($('.leancloud_visitors').length == 1) { // 文章页面，调用判断方法，对符合条件的访问增加访问次数 getVisitorIpAndJudge(); } else if ($('.post-link').length > 1){ // 首页 暂未使用 // showHitCount(Counter); } }); </script><div> <span id="/posts/MTCNN/" class="leancloud_visitors" data-flag-title="MTCNN Joint Face Detection and Alignment using Multi-task Cascaded Convolutional Networks"> <a href="#">Pageviews:<span class="leancloud-visitors-count"></span> times</a></span></div><h4 align="left">用户留言：</h4><div id="comments"></div><script src='//unpkg.com/valine/dist/Valine.min.js'></script> <script> new Valine({ av: AV, el: '#comments', app_id: '7DUQTBuCCKLjnutJOa6ko5cn-MdYXbMMI', app_key: 'lxmthTQ8ESa2HrVQiIVyXtYo', placeholder: '', avatar: 'mp', notify: 'true', verify: 'true', recordIP: 'true', enableQQ: 'true', visitor: true }); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#main > div.row:first-child > div:first-child img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="">darkknightzh</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/deep-learning/">deep learning</a> <a class="post-tag" href="/tags/detection/">detection</a> <a class="post-tag" href="/tags/normalization/">normalization</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/transformers/">transformers</a> <a class="post-tag" href="/tags/demo/">demo</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://darkknightzh.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
