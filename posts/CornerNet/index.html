<!DOCTYPE html><html lang="en-US" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="CornerNet: Detecting Objects as Paired Keypoints" /><meta name="author" content="darkknightzh" /><meta property="og:locale" content="en_US" /><meta name="description" content="仅供学习交流使用，错误之处在所难免，欢迎指正." /><meta property="og:description" content="仅供学习交流使用，错误之处在所难免，欢迎指正." /><link rel="canonical" href="https://darkknightzh.github.io/posts/CornerNet/" /><meta property="og:url" content="https://darkknightzh.github.io/posts/CornerNet/" /><meta property="og:site_name" content="darkknightzh" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-24T16:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CornerNet: Detecting Objects as Paired Keypoints" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"darkknightzh"},"dateModified":"2021-09-22T16:09:04+08:00","datePublished":"2021-08-24T16:00:00+08:00","description":"仅供学习交流使用，错误之处在所难免，欢迎指正.","headline":"CornerNet: Detecting Objects as Paired Keypoints","mainEntityOfPage":{"@type":"WebPage","@id":"https://darkknightzh.github.io/posts/CornerNet/"},"url":"https://darkknightzh.github.io/posts/CornerNet/"}</script><title>CornerNet: Detecting Objects as Paired Keypoints | darkknightzh</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] }, // chtml: { displayAlign: 'left' } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">darkknightzh</a></div><div class="site-subtitle font-italic">忘记一个人，从忘记那个声音开始</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>主页</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>时间轴</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/darkknightzh" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>CornerNet: Detecting Objects as Paired Keypoints</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>CornerNet: Detecting Objects as Paired Keypoints</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> darkknightzh </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Aug 24, 2021, 4:00 PM +0800" prep="on" > Aug 24, 2021 <i class="unloaded">2021-08-24T16:00:00+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Sep 22, 2021, 4:09 PM +0800" prefix="Updated " > Sep 22, 2021 <i class="unloaded">2021-09-22T16:09:04+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="15056 words">83 min</span></div></div><div class="post-content"><style> h1 { border-bottom: none }</style><p>转载请注明出处：</p><p><a href="https://darkknightzh.github.io/posts/CornerNet">https://darkknightzh.github.io/posts/CornerNet</a></p><p>CornerNet论文：</p><p><a href="https://arxiv.org/abs/1808.01244">https://arxiv.org/abs/1808.01244</a></p><p>CornerNet-Lite论文：</p><p><a href="https://arxiv.org/abs/1904.08900">https://arxiv.org/abs/1904.08900</a></p><p>官方CornerNet-Lite的pytorch代码：</p><p><a href="https://github.com/princeton-vl/CornerNet-Lite">https://github.com/princeton-vl/CornerNet-Lite</a></p><p>说明：本文为cornernet的理解。但代码看的是CornerNet-Lite，不太匹配。。。</p><h1 id="p1-简介">P1. 简介</h1><p>该文提出CornerNet，一个不需要anchor的一阶段目标检测算法。将目标建模为目标框的左上角和右下角的角点，并使用CNN分别预测当前类别所有目标左上角和右下角角点的热图，以及每个角点的特征向量（embedding vector）。特征向量用于对相同目标的角点分组，训练网络来预测相同的特征向量，使得相同目标的两个角点的特征向量间的距离更小。该算法简化了网络的输出，不再需要设计anchor，整体框图如图1所示。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-24-CornerNet/1cornernet.png" alt="1" /> <em>图1 cornernet</em></p><p>该文还提出了corner pooling，一个新的池化层，帮助CNN更好的定位边界框的角点。边界框的角点通常是在目标外面（才能把目标框起来）。此时无法根据局部信息定位角点。因而为了确定某个位置是否是左上角的角点，需要水平向右看物体的最高边缘，同时垂直向下看物体的最左侧边缘。这促使我们提出了corner pooling层：其包含两个特征图，在每个位置其在第一个特征图取上取当前点到最右侧所有特征的最大值（max-pool），同时在第二个特征图上取当前点到最下侧所有特征的最大值（max-pool），最终把这两个池化结果相加。如图2所示。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-24-CornerNet/2cornernetpooling.png" alt="2" /> <em>图2 cornernetpooling</em></p><p>为何使用角点比使用边界框中心或候选框要好，作者给出了两个猜测的原因：① 由于目标框需要依赖目标的4个边界，因而目标框的中心比较难于定位；而定位角点只需要2个边界，因而更容易定位，corner pooling更是如此，其编码了一些角点的先验知识。② 角点更高效的提供了密集离散化边界框的方式：只需要 \(O\left( wh \right)\) 个角点就能代表 \(O\left( { {w}^{2}}{ {h}^{2}} \right)\) 个可能的anchor。</p><h1 id="p2-cornernet">P2. CornerNet</h1><h2 id="p21-简介">P2.1 简介</h2><p>该算法将目标建模为目标框的左上角和右下角的角点，并使用CNN分别预测当前类别所有目标左上角和右下角角点的热图，以及每个角点的特征向量（embedding vector），使得相同目标的两个角点的特征向量间的距离更小。为了生成更准确的边界框，网络也会预测偏移，来轻微的调整角点的位置。图3是CornerNet的框图。使用hourglass作为骨干网络。骨干网络之后接两个预测模块。一个预测模块用于预测左上角角点，另一个预测右下角角点。每个模块都有相应的角点池化模层，用于对hourglass的特征进行池化，之后得到预测热图、特征向量和预测偏移。本文不使用不同尺度的特征，只使用hourglass输出特征。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-24-CornerNet/3overview.png" alt="3" /> <em>图3 overview of cornernet</em></p><h2 id="p22-角点检测">P2.2 角点检测</h2><p>本文预测2组热图，一组用于左上角角点，一组用于右下角角点。每组热图有C个通道，且无背景通道，热图宽高为H*W，C为目标检测类别的个数。每个通道是二值掩膜，代表当前位置是某个类别的角点。</p><p>每个角点有一个GT位置作为正位置，所有其他位置都为负位置。在训练阶段不是等价的惩罚负样本位置，而是减少了对正位置半径内负位置的惩罚。原因是如果一对错误的角点靠近各自的GT位置，仍然可以产生一个与GT框充分重叠的框，如图4所示。本文根据对象的大小确定半径，确保半径内的一对点对应的框和GT框具有至少t IoU（实验中t=0.3）。得到半径后，通过未归一化的2D高斯核 \({ {e}^{-\frac{ { {x}^{2}}+{ {y}^{2}}}{2{ {\sigma }^{2}}}}}\) 来进行惩罚，高斯核的中心为GT位置， \(\sigma\) 为半径的1/3。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-24-CornerNet/4gt.png" alt="4" /> <em>图4</em></p><p>令 \({ {p}_{cij}}\) 为预测热图中类别c、位置 \(\left( i,j \right)\) 处的得分， \({ {y}_{cij}}\) 为通过未归一化的高斯核得到的GT热图，本文设计focal loss的变种：</p>\[{ {L}_{\det }}=\frac{-1}{N}\sum\limits_{c=1}^{C}{\sum\limits_{i=1}^{H}{\sum\limits_{j=1}^{W}{\left\{ \begin{matrix} { {\left( 1-{ {p}_{cij}} \right)}^{\alpha }}\log \left( { {p}_{cij}} \right) &amp; if\text{ }{ {y}_{cij}}=1 \\ { {\left( 1-{ {y}_{cij}} \right)}^{\beta }}{ {\left( { {p}_{cij}} \right)}^{\alpha }}\log \left( 1-{ {p}_{cij}} \right) &amp; otherwise \\ \end{matrix} \right.}}} \tag{1}\]<p>其中N为图像中目标的数量， \(\alpha\) 和 \(\beta\) 为控制每个点分布的超参（实验中设置 \(\alpha =2\) ， \(\beta =4\) ）。</p><p>\(1-{ {y}_{cij}}\) 能够降低GT位置附近的惩罚。</p><p>很多网络使用下采样获取全局信息，同时降低显存需求，但会导致网络输出尺寸小于图像尺寸。因而图像上 \(\left( x,y \right)\) 位置会映射到特征图上的 \(\left( \left\lfloor \frac{x}{n} \right\rfloor ,\left\lfloor \frac{y}{n} \right\rfloor \right)\) ，其中n为下采样率。当从特征图重新映射到输入图像时，会导致精度损失，从而严重影响小边界框和他们GT框的IoU。为了解决这个问题，本文预测位置偏移，在将位置映射回输入尺寸之前轻微调整角点的位置。</p>\[{ {o}_{k}}=\left( \frac{ { {x}_{k}}}{n}-\left\lfloor \frac{ { {x}_{k}}}{n} \right\rfloor ,\frac{ { {y}_{k}}}{n}-\left\lfloor \frac{ { {y}_{k}}}{n} \right\rfloor \right) \tag{2}\]<p>其中 \({ {o}_{k}}\) 为偏移， \({ {x}_{k}}\) 和 \({ {y}_{k}}\) 为角点k的x和y坐标。实际中会预测所有类别共享的左上角偏移，及所有类别共享的右下角偏移。使用smooth L1 loss训练偏移：</p>\[{ {L}_{off}}=\frac{1}{N}\sum\limits_{k=1}^{N}{\text{SmoothL1Loss}\left( { {o}_{k}},{ { {\hat{o}}}_{k}} \right)} \tag{3}\]<p>smooth L1 loss如下<a href="https://arxiv.org/abs/1504.08083">https://arxiv.org/abs/1504.08083</a>：</p>\[\text{smoot}{ {\text{h}}_{\text{L1}}}\left( x \right)=\left\{ \begin{matrix} 0.5{ {x}^{2}} &amp; if\text{ }\left| x \right|&lt;1 \\ \left| x \right|-0.5 &amp; otherwise \\ \end{matrix} \right. \tag{3.1}\]<p>说明：公式3.1中x等于公式3中 \({ {o}_{k}}-{ {\hat{o}}_{k}}\)</p><h2 id="p23-角点分组">P2.3 角点分组</h2><p>一张图像中可能出现多个类别的目标，可能检测到多个左上角和右下角角点，从而需要确定一组左上角和右下角角点属于同一个边界框。本文受<a href="https://arxiv.org/abs/1611.05424">https://arxiv.org/abs/1611.05424</a>中多人姿态估计算法启发。该文检测所有人的关节点，并生成每个关节点的特征向量（embedding），然后根据特征向量间的距离对关节点分组。该算法也能用于本文中。网络对每个检测到的角点预测特征向量，该向量代表预测到的左上角角点和右下角角点是否来自同一个框（相同目标），同一个框的embedding向量的距离更小。之后根据左上角和右下角角点的特征向量的距离对角点分组。特征向量的实际值不重要，因为使用的是特征之间的距离来对角点分组。</p><p>本文使用1维的特征向量。令 \({ {e}_{ { {t}_{k}}}}\) 为目标k左上角角点的特征， \({ {e}_{ { {b}_{k}}}}\) 为目标k右下角角点的特征，本文使用pull loss训练网络来聚集角点，使用push loss来分散角点：</p>\[{ {L}_{pull}}=\frac{1}{N}\sum\limits_{k=1}^{N}{\left[ { {\left( { {e}_{ { {t}_{k}}}}-{ {e}_{k}} \right)}^{2}}+{ {\left( { {e}_{ { {b}_{k}}}}-{ {e}_{k}} \right)}^{2}} \right]} \tag{4}\] \[{ {L}_{push}}=\frac{1}{N\left( N-1 \right)}\sum\limits_{k=1}^{N}{\sum\limits_{\begin{smallmatrix} j=1 \\ j\ne k \end{smallmatrix}}^{N}{\max \left( 0,\Delta -\left| { {e}_{k}}-{ {e}_{j}} \right| \right)}} \tag{5}\]<p>其中 \({ {e}_{k}}\) 为 \({ {e}_{ { {t}_{k}}}}\) 和 \({ {e}_{ { {b}_{k}}}}\) 的平均值，即中心， \(\Delta =1\) ，push loss是左上角和右下角角点的中心之间相互比较。和训练偏移的损失类似，本文只对GT位置的角点计算pull loss和push loss。</p><h2 id="p24-角点池化corner-pooling">P2.4 角点池化（Corner Pooling）</h2><p>角点通常没有局部视觉信息。因而需要分别需要水平向右看物体的最高边缘、垂直向下看物体的最左侧边缘，才能确定左上角的角点。因而该文提出角点池化（Corner Pooling），来给角点编码先验知识，更好的定位角点。</p><p>假定需要确定位置 \(\left( i,j \right)\) 的像素是否是左上角点。令 \({ {f}_{t}}\) 和 \({ {f}_{l}}\) 分别为左上角点池化层的输入， \({ {f}_{ { {t}_{ij}}}}\) 和 \({ {f}_{ { {l}_{ij}}}}\) 分别为 \({ {f}_{t}}\) 和 \({ {f}_{l}}\) 中位置 \(\left( i,j \right)\) 处的向量。对于H*W的特征图，角点池化层首先最大池化（max-pool） \({ {f}_{t}}\) 中所有的 \(\left( i,j \right)\) 和 \(\left( i,H \right)\) 的特征到特征向量 \({ {t}_{ij}}\) 中，然后最大池化（max-pool） \({ {f}_{l}}\) 中所有的 \(\left( i,j \right)\) 和 \(\left( W,j \right)\) 的特征到特征向量 \({ {l}_{ij}}\) 中。最后将 \({ {t}_{ij}}\) 和 \({ {l}_{ij}}\) 的结果相加：</p>\[{ {t}_{ij}}=\left\{ \begin{matrix} \max \left( { {f}_{ { {t}_{ij}}}},{ {t}_{\left( i+1 \right)j}} \right) &amp; if\text{ }i&lt;H \\ { {f}_{ { {t}_{Hj}}}} &amp; otherwise \\ \end{matrix} \right. \tag{6}\] \[{ {l}_{ij}}=\left\{ \begin{matrix} \max \left( { {f}_{ { {l}_{ij}}}},{ {t}_{i\left( j+1 \right)}} \right) &amp; if\text{ }j&lt;W \\ { {f}_{ { {t}_{iW}}}} &amp; otherwise \\ \end{matrix} \right. \tag{7}\]<p>公式6中，当前点的值是当前点右侧所有值的最大的。i从H开始--，进行比较。公式7中，当前点的值是当前点下方所有值的最大的。j从W开始--，进行比较。 \({ {t}_{ij}}\) 和 \({ {l}_{ij}}\) 可以使用动态规划高效计算，如图5所示。最终 \({ {t}_{ij}}\text{+}{ {l}_{ij}}\) 得到结果。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-24-CornerNet/5tlcornerpooling.png" alt="5" /> <em>图5</em></p><p>右下角池化层通过类似方式定义。其最大池化 \(\left( 0,j \right)\) 和 \(\left( i,j \right)\) 的特征向量，以及 \(\left( i,0 \right)\) 和 \(\left( i,j \right)\) 的特征向量，并把相应结果相加。角点池化层用在预测模块，来预测热图、特征向量和目标偏移。</p><p>预测模块如图6所示。第一部分为修改的残差模块，此处将第一个3*3卷积替换2个具有128通道的3*3卷积模块模块，用来处理骨干网络的特征，卷积模块之后为角点池化层。按照残差模块的设计，我们将池化后的特征输入一个具有256个通道的3*3 Conv-BN层，并添加shortcut支路。修改后的残差模块后面接具有256通道的3*3卷积模块，3个Conv-ReLU-Conv层，来预测热图、特征向量和目标偏移。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-24-CornerNet/6predictionmodule.png" alt="6" /> <em>图6 predictionmodule</em></p><h2 id="p25-hourglass网络">P2.5 Hourglass网络</h2><p>CornerNet的骨干网络为hourglass网络。其为全卷积网络，包含至少一个hourglass模块。hourglass模块先通过一系列的conv和max pooling来下采样输入特征，而后通过一系列上采样和卷积层上采样特征到原始分辨率。使用hourglass时，由于上采样丢失了细节信息，因而将输入层和上采样层使用skip层相连。 本文使用的hourglass网络包含2个hourglass模块，但对hourglass模块做了一些修改。我们没有使用max pooling，而是使用stride=2来降低特征图的分辨率。本文降低特征图的分辨率5次，同时特征通道数依次变为(256, 384, 384, 384, 512)。而后使用2个残差模块和一个最近邻上采样模块来上采样特征。每个skip连接也包括2个残差模块。在hourglass模块的中间有4个具有512个通道的残差模块。在hourglass模块之前，使用stride=2、128个通道的7*7卷积，以及stride=2、256个通道的残差块将图像分辨率降低4倍。</p><p>本文训练阶段也使用中间监督。不过我们发现中间预测会降低网络的性能，因而没有将中间预测添加到网络中。我们在第一个hourglass模块的输入和输出都使用1*1 conv bn，然后使用逐元素相加并加上ReLU和256通道的残差模块，作为第二个hourglass模块的输入。hourglass网络的层数为104。我们仅使用网络最后一层的特征进行预测。</p><h2 id="p26-损失">P2.6 损失</h2><p>该文使用Adam训练网络。总体的损失为：</p>\[L={ {L}_{det}}+\alpha { {L}_{pull}}+\beta { {L}_{push}}+\gamma { {L}_{off}} \tag{8}\]<p>其中 \(\alpha =0.1\) 、 \(\beta =0.1\) 、 \(\gamma =1\) 分别是pull loss，push loss、偏移损失的权重。 \(\alpha\) 和 \(\beta\) 大于等于1时，模型性能变差。</p><h1 id="p3代码">P3.代码</h1><p>说明：相关代码有一定注释；调用系统函数的代码，基本无注释。</p><h2 id="p31-训练trainpy">P3.1 训练train.py</h2><p>用于初始化pytorch分布式训练或者单机训练。代码如下：</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">training_dbs</span><span class="p">,</span> <span class="n">validation_db</span><span class="p">,</span> <span class="n">system_config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="c1"># reading arguments from command
</span>    <span class="n">start_iter</span>  <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">start_iter</span>
    <span class="n">distributed</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">distributed</span>
    <span class="n">world_size</span>  <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">world_size</span>
    <span class="n">initialize</span>  <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">initialize</span>
    <span class="n">gpu</span>         <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">gpu</span>
    <span class="n">rank</span>        <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">rank</span>

    <span class="c1"># reading arguments from json file
</span>    <span class="n">batch_size</span>       <span class="o">=</span> <span class="n">system_config</span><span class="p">.</span><span class="n">batch_size</span>
    <span class="n">learning_rate</span>    <span class="o">=</span> <span class="n">system_config</span><span class="p">.</span><span class="n">learning_rate</span>
    <span class="n">max_iteration</span>    <span class="o">=</span> <span class="n">system_config</span><span class="p">.</span><span class="n">max_iter</span>
    <span class="n">pretrained_model</span> <span class="o">=</span> <span class="n">system_config</span><span class="p">.</span><span class="n">pretrain</span>
    <span class="n">stepsize</span>         <span class="o">=</span> <span class="n">system_config</span><span class="p">.</span><span class="n">stepsize</span>
    <span class="n">snapshot</span>         <span class="o">=</span> <span class="n">system_config</span><span class="p">.</span><span class="n">snapshot</span>
    <span class="n">val_iter</span>         <span class="o">=</span> <span class="n">system_config</span><span class="p">.</span><span class="n">val_iter</span>
    <span class="n">display</span>          <span class="o">=</span> <span class="n">system_config</span><span class="p">.</span><span class="n">display</span>
    <span class="n">decay_rate</span>       <span class="o">=</span> <span class="n">system_config</span><span class="p">.</span><span class="n">decay_rate</span>
    <span class="n">stepsize</span>         <span class="o">=</span> <span class="n">system_config</span><span class="p">.</span><span class="n">stepsize</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Process {}: building model...</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">rank</span><span class="p">))</span>
    <span class="n">nnet</span> <span class="o">=</span> <span class="nc">NetworkFactory</span><span class="p">(</span><span class="n">system_config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">distributed</span><span class="o">=</span><span class="n">distributed</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="n">gpu</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">initialize</span><span class="p">:</span>
        <span class="n">nnet</span><span class="p">.</span><span class="nf">save_params</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># queues storing data for training
</span>    <span class="n">training_queue</span>   <span class="o">=</span> <span class="nc">Queue</span><span class="p">(</span><span class="n">system_config</span><span class="p">.</span><span class="n">prefetch_size</span><span class="p">)</span>
    <span class="n">validation_queue</span> <span class="o">=</span> <span class="nc">Queue</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1"># queues storing pinned data for training
</span>    <span class="n">pinned_training_queue</span>   <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="nc">Queue</span><span class="p">(</span><span class="n">system_config</span><span class="p">.</span><span class="n">prefetch_size</span><span class="p">)</span>
    <span class="n">pinned_validation_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="nc">Queue</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1"># allocating resources for parallel reading
</span>    <span class="n">training_tasks</span> <span class="o">=</span> <span class="nf">init_parallel_jobs</span><span class="p">(</span><span class="n">system_config</span><span class="p">,</span> <span class="n">training_dbs</span><span class="p">,</span> <span class="n">training_queue</span><span class="p">,</span> <span class="n">data_sampling_func</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val_iter</span><span class="p">:</span>
        <span class="n">validation_tasks</span> <span class="o">=</span> <span class="nf">init_parallel_jobs</span><span class="p">(</span><span class="n">system_config</span><span class="p">,</span> <span class="p">[</span><span class="n">validation_db</span><span class="p">],</span> <span class="n">validation_queue</span><span class="p">,</span> <span class="n">data_sampling_func</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="n">training_pin_semaphore</span>   <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">()</span>
    <span class="n">validation_pin_semaphore</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Semaphore</span><span class="p">()</span>
    <span class="n">training_pin_semaphore</span><span class="p">.</span><span class="nf">acquire</span><span class="p">()</span>
    <span class="n">validation_pin_semaphore</span><span class="p">.</span><span class="nf">acquire</span><span class="p">()</span>

    <span class="n">training_pin_args</span>   <span class="o">=</span> <span class="p">(</span><span class="n">training_queue</span><span class="p">,</span> <span class="n">pinned_training_queue</span><span class="p">,</span> <span class="n">training_pin_semaphore</span><span class="p">)</span>
    <span class="n">training_pin_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">training_pin_args</span><span class="p">)</span>
    <span class="n">training_pin_thread</span><span class="p">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">training_pin_thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="n">validation_pin_args</span>   <span class="o">=</span> <span class="p">(</span><span class="n">validation_queue</span><span class="p">,</span> <span class="n">pinned_validation_queue</span><span class="p">,</span> <span class="n">validation_pin_semaphore</span><span class="p">)</span>
    <span class="n">validation_pin_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">validation_pin_args</span><span class="p">)</span>
    <span class="n">validation_pin_thread</span><span class="p">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">validation_pin_thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">pretrained_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">pretrained_model</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">pretrained model does not exist</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Process {}: loading from pretrained model</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">rank</span><span class="p">))</span>
        <span class="n">nnet</span><span class="p">.</span><span class="nf">load_pretrained_params</span><span class="p">(</span><span class="n">pretrained_model</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">start_iter</span><span class="p">:</span>
        <span class="n">nnet</span><span class="p">.</span><span class="nf">load_params</span><span class="p">(</span><span class="n">start_iter</span><span class="p">)</span>
        <span class="n">learning_rate</span> <span class="o">/=</span> <span class="p">(</span><span class="n">decay_rate</span> <span class="o">**</span> <span class="p">(</span><span class="n">start_iter</span> <span class="o">//</span> <span class="n">stepsize</span><span class="p">))</span>
        <span class="n">nnet</span><span class="p">.</span><span class="nf">set_lr</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Process {}: training starts from iteration {} with learning_rate {}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">start_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nnet</span><span class="p">.</span><span class="nf">set_lr</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">training start...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">nnet</span><span class="p">.</span><span class="nf">cuda</span><span class="p">()</span>
    <span class="n">nnet</span><span class="p">.</span><span class="nf">train_mode</span><span class="p">()</span>   <span class="c1"># 训练模式
</span>    <span class="k">with</span> <span class="nf">stdout_to_tqdm</span><span class="p">()</span> <span class="k">as</span> <span class="n">save_stdout</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nf">tqdm</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="n">start_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_iteration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">save_stdout</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
            <span class="n">training</span> <span class="o">=</span> <span class="n">pinned_training_queue</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">training_loss</span> <span class="o">=</span> <span class="n">nnet</span><span class="p">.</span><span class="nf">train</span><span class="p">(</span><span class="o">**</span><span class="n">training</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">display</span> <span class="ow">and</span> <span class="n">iteration</span> <span class="o">%</span> <span class="n">display</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Process {}: training loss at iteration {}: {}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">training_loss</span><span class="p">.</span><span class="nf">item</span><span class="p">()))</span>
            <span class="k">del</span> <span class="n">training_loss</span>

            <span class="k">if</span> <span class="n">val_iter</span> <span class="ow">and</span> <span class="n">validation_db</span><span class="p">.</span><span class="n">db_inds</span><span class="p">.</span><span class="n">size</span> <span class="ow">and</span> <span class="n">iteration</span> <span class="o">%</span> <span class="n">val_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nnet</span><span class="p">.</span><span class="nf">eval_mode</span><span class="p">()</span>  <span class="c1"># eval模式
</span>                <span class="n">validation</span> <span class="o">=</span> <span class="n">pinned_validation_queue</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">validation_loss</span> <span class="o">=</span> <span class="n">nnet</span><span class="p">.</span><span class="nf">validate</span><span class="p">(</span><span class="o">**</span><span class="n">validation</span><span class="p">)</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Process {}: validation loss at iteration {}: {}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">validation_loss</span><span class="p">.</span><span class="nf">item</span><span class="p">()))</span>
                <span class="n">nnet</span><span class="p">.</span><span class="nf">train_mode</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="n">snapshot</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nnet</span><span class="p">.</span><span class="nf">save_params</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="n">stepsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">learning_rate</span> <span class="o">/=</span> <span class="n">decay_rate</span>
                <span class="n">nnet</span><span class="p">.</span><span class="nf">set_lr</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">)</span>   <span class="c1"># 更新学习率
</span>
    <span class="c1"># sending signal to kill the thread
</span>    <span class="n">training_pin_semaphore</span><span class="p">.</span><span class="nf">release</span><span class="p">()</span>
    <span class="n">validation_pin_semaphore</span><span class="p">.</span><span class="nf">release</span><span class="p">()</span>

    <span class="c1"># terminating data fetching processes
</span>    <span class="nf">terminate_tasks</span><span class="p">(</span><span class="n">training_tasks</span><span class="p">)</span>
    <span class="nf">terminate_tasks</span><span class="p">(</span><span class="n">validation_tasks</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span> <span class="n">ngpus_per_node</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="n">args</span><span class="p">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="n">gpu</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">distributed</span><span class="p">:</span>
        <span class="n">args</span><span class="p">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">rank</span> <span class="o">*</span> <span class="n">ngpus_per_node</span> <span class="o">+</span> <span class="n">gpu</span>
        <span class="n">dist</span><span class="p">.</span><span class="nf">init_process_group</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">dist_backend</span><span class="p">,</span> <span class="n">init_method</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">dist_url</span><span class="p">,</span> <span class="n">world_size</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">world_size</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">rank</span><span class="p">)</span>  <span class="c1"># 设置分布式训练
</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">rank</span>

    <span class="n">cfg_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sh">"</span><span class="s">./configs</span><span class="sh">"</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">cfg_file</span> <span class="o">+</span> <span class="sh">"</span><span class="s">.json</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">config</span><span class="p">[</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">][</span><span class="sh">"</span><span class="s">snapshot_name</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">cfg_file</span>
    <span class="n">system_config</span> <span class="o">=</span> <span class="nc">SystemConfig</span><span class="p">().</span><span class="nf">update_config</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">])</span>

    <span class="n">model_file</span>  <span class="o">=</span> <span class="sh">"</span><span class="s">core.models.{}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">cfg_file</span><span class="p">)</span>  <span class="c1"># 从core.models.CornerNet载入模型
</span>    <span class="n">model_file</span>  <span class="o">=</span> <span class="n">importlib</span><span class="p">.</span><span class="nf">import_module</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span>
    <span class="n">model</span>       <span class="o">=</span> <span class="n">model_file</span><span class="p">.</span><span class="nf">model</span><span class="p">()</span>   <span class="c1"># 得到实际的模型，如core.models.CornerNet中的model
</span>
    <span class="n">train_split</span> <span class="o">=</span> <span class="n">system_config</span><span class="p">.</span><span class="n">train_split</span>   <span class="c1"># trainval
</span>    <span class="n">val_split</span>   <span class="o">=</span> <span class="n">system_config</span><span class="p">.</span><span class="n">val_split</span>     <span class="c1"># minival
</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Process {}: loading all datasets...</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">rank</span><span class="p">))</span>   <span class="c1"># rank为分布式训练的参数
</span>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">system_config</span><span class="p">.</span><span class="n">dataset</span>   <span class="c1"># COCO
</span>    <span class="n">workers</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">workers</span>   <span class="c1"># 4
</span>    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Process {}: using {} workers</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">workers</span><span class="p">))</span>
    <span class="n">training_dbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">datasets</span><span class="p">[</span><span class="n">dataset</span><span class="p">](</span><span class="n">config</span><span class="p">[</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">],</span> <span class="n">split</span><span class="o">=</span><span class="n">train_split</span><span class="p">,</span> <span class="n">sys_config</span><span class="o">=</span><span class="n">system_config</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">workers</span><span class="p">)]</span>  <span class="c1"># datasets[dataset]=COCO，得到训练的
</span>    <span class="n">validation_db</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="n">dataset</span><span class="p">](</span><span class="n">config</span><span class="p">[</span><span class="sh">"</span><span class="s">db</span><span class="sh">"</span><span class="p">],</span> <span class="n">split</span><span class="o">=</span><span class="n">val_split</span><span class="p">,</span> <span class="n">sys_config</span><span class="o">=</span><span class="n">system_config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">system config...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">pprint</span><span class="p">.</span><span class="nf">pprint</span><span class="p">(</span><span class="n">system_config</span><span class="p">.</span><span class="n">full</span><span class="p">)</span>

        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">db config...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">pprint</span><span class="p">.</span><span class="nf">pprint</span><span class="p">(</span><span class="n">training_dbs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">configs</span><span class="p">)</span>

        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">len of db: {}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">training_dbs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">db_inds</span><span class="p">)))</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">distributed: {}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">distributed</span><span class="p">))</span>

    <span class="nf">train</span><span class="p">(</span><span class="n">training_dbs</span><span class="p">,</span> <span class="n">validation_db</span><span class="p">,</span> <span class="n">system_config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">distributed</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">distributed</span>
    <span class="n">world_size</span>  <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">world_size</span>

    <span class="k">if</span> <span class="n">distributed</span> <span class="ow">and</span> <span class="n">world_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">world size must be greater than 0 in distributed training</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">ngpus_per_node</span>  <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">device_count</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">distributed</span><span class="p">:</span>
        <span class="n">args</span><span class="p">.</span><span class="n">world_size</span> <span class="o">=</span> <span class="n">ngpus_per_node</span> <span class="o">*</span> <span class="n">args</span><span class="p">.</span><span class="n">world_size</span>
        <span class="n">mp</span><span class="p">.</span><span class="nf">spawn</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">ngpus_per_node</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">ngpus_per_node</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">main</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">ngpus_per_node</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</pre></table></code></div></div></details><h2 id="p32-网络coremodelscornernet">P3.2 网络core.models.CornerNet</h2><p>位于core/models/CornerNet.py</p><h3 id="p321-cornernet">P3.2.1 CornerNet</h3><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">make_pool_layer</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">make_hg_layer</span><span class="p">(</span><span class="n">inp_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">,</span> <span class="n">modules</span><span class="p">):</span>
    <span class="n">layers</span>  <span class="o">=</span> <span class="p">[</span><span class="nf">residual</span><span class="p">(</span><span class="n">inp_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)]</span>
    <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="nf">residual</span><span class="p">(</span><span class="n">out_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">modules</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">model</span><span class="p">(</span><span class="n">hg_net</span><span class="p">):</span>   <span class="c1"># cornernet网络结构，继承自hg_net
</span>    <span class="k">def</span> <span class="nf">_pred_mod</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>  <span class="c1"># conv+bn+relu + 1*1conv
</span>        <span class="k">return</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span>
            <span class="nf">convolution</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">with_bn</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_merge_mod</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">stacks</span>  <span class="o">=</span> <span class="mi">2</span>
        <span class="n">pre</span>     <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span>
            <span class="nf">convolution</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>    <span class="c1"># conv+bn+relu
</span>            <span class="nf">residual</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>         <span class="c1"># 残差连接模块 (conv+bn + (conv+bn+relu+conv+bn)) + relu
</span>        <span class="p">)</span>
        <span class="n">hg_mods</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="nf">hg_module</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">384</span><span class="p">,</span> <span class="mi">384</span><span class="p">,</span> <span class="mi">384</span><span class="p">,</span> <span class="mi">512</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                                           <span class="n">make_pool_layer</span><span class="o">=</span><span class="n">make_pool_layer</span><span class="p">,</span> <span class="n">make_hg_layer</span><span class="o">=</span><span class="n">make_hg_layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">stacks</span><span class="p">)])</span>   <span class="c1"># 2个hg_module模块
</span>
        <span class="n">cnvs</span>    <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="nf">convolution</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">stacks</span><span class="p">)])</span>  <span class="c1"># 2个
</span>        <span class="n">inters</span>  <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="nf">residual</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">stacks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>    <span class="c1"># 1个
</span>        <span class="n">cnvs_</span>   <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="nf">_merge_mod</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">stacks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>     <span class="c1"># 1个
</span>        <span class="n">inters_</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="nf">_merge_mod</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">stacks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>     <span class="c1"># 1个
</span>        
        <span class="c1"># hg如下
</span>        <span class="c1"># 
</span>        <span class="c1">#                    out[0]                                                   out[0]
</span>        <span class="c1">#                      ↑
</span>        <span class="c1">#       hg_mods[0] → cnvs[0] → cnvs_[0]
</span>        <span class="c1">#     ↗                                ↘                                      ↑
</span>        <span class="c1"># pre                                      + → relu → inters[0] → hg_mods[1] → cnvs[1]
</span>        <span class="c1">#    ↘             inters_[0]          ↗  
</span>        <span class="n">hgs</span> <span class="o">=</span> <span class="nf">hg</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">hg_mods</span><span class="p">,</span> <span class="n">cnvs</span><span class="p">,</span> <span class="n">inters</span><span class="p">,</span> <span class="n">cnvs_</span><span class="p">,</span> <span class="n">inters_</span><span class="p">)</span> 

        <span class="c1"># corner_pool如下
</span>        <span class="c1"># pool1: TopPool or BottomPool
</span>        <span class="c1"># pool2: LeftPool or RightPool
</span>        <span class="c1"># 
</span>        <span class="c1">#         conv+bn+relu → pool1 
</span>        <span class="c1">#      ↗                      ↘ 
</span>        <span class="c1">#    x →  conv+bn+relu → pool2 →  + → conv → bn ↘
</span>        <span class="c1">#      ↘                                          + → relu → conv+bn+relu
</span>        <span class="c1">#         conv → bn  -------------------------→ ↗
</span>
        <span class="n">tl_modules</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="nf">corner_pool</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">TopPool</span><span class="p">,</span> <span class="n">LeftPool</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">stacks</span><span class="p">)])</span>       <span class="c1"># 左上角池化
</span>        <span class="n">br_modules</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="nf">corner_pool</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">BottomPool</span><span class="p">,</span> <span class="n">RightPool</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">stacks</span><span class="p">)])</span>   <span class="c1"># 右下角池化
</span>
        <span class="n">tl_heats</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="nf">_pred_mod</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">stacks</span><span class="p">)])</span>   <span class="c1"># 预测目标左上角热图的分支  # conv+bn+relu + 1*1conv
</span>        <span class="n">br_heats</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="nf">_pred_mod</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">stacks</span><span class="p">)])</span>   <span class="c1"># 预测目标右下角热图的分支  # conv+bn+relu + 1*1conv
</span>        <span class="k">for</span> <span class="n">tl_heat</span><span class="p">,</span> <span class="n">br_heat</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">tl_heats</span><span class="p">,</span> <span class="n">br_heats</span><span class="p">):</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">tl_heat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">bias</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.19</span><span class="p">)</span>   <span class="c1"># 初始化bias
</span>            <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">br_heat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">bias</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.19</span><span class="p">)</span>

        <span class="n">tl_tags</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="nf">_pred_mod</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">stacks</span><span class="p">)])</span>   <span class="c1"># 预测左上角目标embedding向量的分支  # conv+bn+relu + 1*1conv
</span>        <span class="n">br_tags</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="nf">_pred_mod</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">stacks</span><span class="p">)])</span>   <span class="c1"># 预测右下角目标embedding向量的分支  # conv+bn+relu + 1*1conv
</span>
        <span class="n">tl_offs</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="nf">_pred_mod</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">stacks</span><span class="p">)])</span>   <span class="c1"># 预测左上角目标偏移的分支（2是要预测xy坐标，因而输出通道数为2）   # conv+bn+relu + 1*1conv
</span>        <span class="n">br_offs</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="nf">_pred_mod</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">stacks</span><span class="p">)])</span>   <span class="c1"># 预测右下角目标偏移的分支   # conv+bn+relu + 1*1conv
</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span><span class="n">hgs</span><span class="p">,</span> <span class="n">tl_modules</span><span class="p">,</span> <span class="n">br_modules</span><span class="p">,</span> <span class="n">tl_heats</span><span class="p">,</span> <span class="n">br_heats</span><span class="p">,</span> <span class="n">tl_tags</span><span class="p">,</span> <span class="n">br_tags</span><span class="p">,</span> <span class="n">tl_offs</span><span class="p">,</span> <span class="n">br_offs</span><span class="p">)</span>  <span class="c1"># 调用基类hg_net的__init__函数
</span>
        <span class="n">self</span><span class="p">.</span><span class="n">loss</span> <span class="o">=</span> <span class="nc">CornerNet_Loss</span><span class="p">(</span><span class="n">pull_weight</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span> <span class="n">push_weight</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">)</span>   <span class="c1"># 损失函数
</span></pre></table></code></div></div></details><h3 id="p322-convolution">P3.2.2 convolution</h3><p>实际为conv+bn+relu，位于core/models/py_utils/utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">convolution</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>   <span class="c1"># conv+bn+relu
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">inp_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">with_bn</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">convolution</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>

        <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="n">inp_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="n">stride</span><span class="p">,</span> <span class="n">stride</span><span class="p">),</span> <span class="n">bias</span><span class="o">=</span><span class="ow">not</span> <span class="n">with_bn</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bn</span>   <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">out_dim</span><span class="p">)</span> <span class="k">if</span> <span class="n">with_bn</span> <span class="k">else</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">bn</span>   <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bn</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
        <span class="n">relu</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">relu</span><span class="p">(</span><span class="n">bn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">relu</span>
</pre></table></code></div></div></details><h3 id="p323-残差residual">P3.2.3 残差residual</h3><p>实际为conv+bn + (conv+bn+relu+conv+bn)) + relu，位于core/models/py_utils/utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">residual</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>  <span class="c1"># 残差连接模块 (conv+bn + (conv+bn+relu+conv+bn)) + relu
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">inp_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="n">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="n">inp_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="n">stride</span><span class="p">,</span> <span class="n">stride</span><span class="p">),</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bn1</span>   <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">out_dim</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">relu1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="n">out_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bn2</span>   <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">out_dim</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">skip</span>  <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="n">inp_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="n">stride</span><span class="p">,</span> <span class="n">stride</span><span class="p">),</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">out_dim</span><span class="p">)</span>
        <span class="p">)</span> <span class="k">if</span> <span class="n">stride</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">inp_dim</span> <span class="o">!=</span> <span class="n">out_dim</span> <span class="k">else</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">relu</span>  <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">conv1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">bn1</span>   <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bn1</span><span class="p">(</span><span class="n">conv1</span><span class="p">)</span>
        <span class="n">relu1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">relu1</span><span class="p">(</span><span class="n">bn1</span><span class="p">)</span>

        <span class="n">conv2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv2</span><span class="p">(</span><span class="n">relu1</span><span class="p">)</span>
        <span class="n">bn2</span>   <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bn2</span><span class="p">(</span><span class="n">conv2</span><span class="p">)</span>

        <span class="n">skip</span>  <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">skip</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">relu</span><span class="p">(</span><span class="n">bn2</span> <span class="o">+</span> <span class="n">skip</span><span class="p">)</span>
</pre></table></code></div></div></details><h3 id="p324-corner_pool">P3.2.4 corner_pool</h3><p>CornerNet提出了corner池化（corner_pool），位于core/models/py_utils/utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">corner_pool</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">pool1</span><span class="p">,</span> <span class="n">pool2</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">corner_pool</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_init_layers</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">pool1</span><span class="p">,</span> <span class="n">pool2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_layers</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">pool1</span><span class="p">,</span> <span class="n">pool2</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">p1_conv1</span> <span class="o">=</span> <span class="nf">convolution</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>   <span class="c1"># conv+bn+relu
</span>        <span class="n">self</span><span class="p">.</span><span class="n">p2_conv1</span> <span class="o">=</span> <span class="nf">convolution</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>   <span class="c1"># conv+bn+relu
</span>
        <span class="n">self</span><span class="p">.</span><span class="n">p_conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">p_bn1</span>   <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bn1</span>   <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">relu1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="nf">convolution</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>   <span class="c1"># conv+bn+relu
</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pool1</span> <span class="o">=</span> <span class="nf">pool1</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pool2</span> <span class="o">=</span> <span class="nf">pool2</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># pool1: TopPool or BottomPool
</span>        <span class="c1"># pool2: LeftPool or RightPool
</span>        <span class="c1"># 
</span>        <span class="c1">#         conv+bn+relu → pool1 
</span>        <span class="c1">#      ↗                      ↘ 
</span>        <span class="c1">#    x →  conv+bn+relu → pool2 →  + → conv → bn ↘
</span>        <span class="c1">#      ↘                                          + → relu → conv+bn+relu
</span>        <span class="c1">#         conv → bn  -------------------------→ ↗
</span>        
        <span class="n">p1_conv1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">p1_conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># pool 1
</span>        <span class="n">pool1</span>    <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pool1</span><span class="p">(</span><span class="n">p1_conv1</span><span class="p">)</span>

        <span class="n">p2_conv1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">p2_conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># pool 2
</span>        <span class="n">pool2</span>    <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pool2</span><span class="p">(</span><span class="n">p2_conv1</span><span class="p">)</span>

        <span class="n">p_conv1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">p_conv1</span><span class="p">(</span><span class="n">pool1</span> <span class="o">+</span> <span class="n">pool2</span><span class="p">)</span>  <span class="c1"># pool 1 + pool 2
</span>        <span class="n">p_bn1</span>   <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">p_bn1</span><span class="p">(</span><span class="n">p_conv1</span><span class="p">)</span>

        <span class="n">conv1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">bn1</span>   <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bn1</span><span class="p">(</span><span class="n">conv1</span><span class="p">)</span>
        <span class="n">relu1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">relu1</span><span class="p">(</span><span class="n">p_bn1</span> <span class="o">+</span> <span class="n">bn1</span><span class="p">)</span>

        <span class="n">conv2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv2</span><span class="p">(</span><span class="n">relu1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conv2</span>
</pre></table></code></div></div></details><h4 id="p3241-top_pool">P3.2.4.1 top_pool</h4><p>实际的top_pool位于core/models/py_utils/_cpools/src/top_pool.cpp。下面为前向计算的代码（反向计算没看）：</p><details><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&gt;</span> <span class="n">top_pool_forward</span><span class="p">(</span>
    <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">input</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Initialize output</span>
    <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">output</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

    <span class="c1">// Get height</span>
    <span class="kt">int64_t</span> <span class="n">height</span> <span class="o">=</span> <span class="n">input</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

    <span class="n">output</span><span class="p">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
    <span class="c1">// 取H方向当前位置值为：从当前位置往下的最大值</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int64_t</span> <span class="n">ind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ind</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">ind</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// slice(Tensor, dim, start, end, step = 1)   max_out(out, Tensor, other)</span>
        <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">max_temp</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">slice</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="o">-</span><span class="n">ind</span><span class="p">);</span>  <span class="c1">//  BCHW，dim=2，则在H上，start=0，end=height-ind</span>
        <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">cur_temp</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">slice</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="o">-</span><span class="n">ind</span><span class="p">);</span>
        <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">next_temp</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">slice</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>   <span class="c1">//  BCHW，dim=2，则在H上，start=ind，end=height</span>
        <span class="n">at</span><span class="o">::</span><span class="n">max_out</span><span class="p">(</span><span class="n">max_temp</span><span class="p">,</span> <span class="n">cur_temp</span><span class="p">,</span> <span class="n">next_temp</span><span class="p">);</span>  <span class="c1">// 依次取out[i] = max(out[i], out[i+1])，由于每次都比较过相应值，因而上面可以在直接&lt;&lt;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span> 
        <span class="n">output</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></table></code></div></div></details><h4 id="p3242-bottom_pool">P3.2.4.2 bottom_pool</h4><p>实际的bottom_pool位于core/models/py_utils/_cpools/src/bottom_pool.cpp。下面为前向计算的代码（反向计算没看）：</p><details><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&gt;</span> <span class="n">pool_forward</span><span class="p">(</span>
    <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">input</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Initialize output</span>
    <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">output</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

    <span class="c1">// Get height</span>
    <span class="kt">int64_t</span> <span class="n">height</span> <span class="o">=</span> <span class="n">input</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

    <span class="n">output</span><span class="p">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
    <span class="c1">// 取H方向当前位置值为：从当前位置往上的最大值</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int64_t</span> <span class="n">ind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ind</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">ind</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// slice(Tensor, dim, start, end, step = 1)   max_out(out, Tensor, other)</span>
        <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">max_temp</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">slice</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>   <span class="c1">//  BCHW，dim=2，则在H上，start=ind，end=height</span>
        <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">cur_temp</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">slice</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
        <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">next_temp</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">slice</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="o">-</span><span class="n">ind</span><span class="p">);</span>   <span class="c1">//  BCHW，dim=2，则在H上，start=0，end=height-ind</span>
        <span class="n">at</span><span class="o">::</span><span class="n">max_out</span><span class="p">(</span><span class="n">max_temp</span><span class="p">,</span> <span class="n">cur_temp</span><span class="p">,</span> <span class="n">next_temp</span><span class="p">);</span>    <span class="c1">// 依次取out[i] = max(out[i], out[i+1])，由于每次都比较过相应值，因而上面可以在直接&lt;&lt;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span> 
        <span class="n">output</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></table></code></div></div></details><h4 id="p3243-left_pool">P3.2.4.3 left_pool</h4><p>实际的left_pool位于core/models/py_utils/_cpools/src/left_pool.cpp。下面为前向计算的代码（反向计算没看）：</p><details><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&gt;</span> <span class="n">pool_forward</span><span class="p">(</span>
    <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">input</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Initialize output</span>
    <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">output</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

    <span class="c1">// Get width</span>
    <span class="kt">int64_t</span> <span class="n">width</span> <span class="o">=</span> <span class="n">input</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

    <span class="n">output</span><span class="p">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
    <span class="c1">// 取W方向当前位置值为：从当前位置往右的最大值</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int64_t</span> <span class="n">ind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ind</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">ind</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">// slice(Tensor, dim, start, end, step = 1)   max_out(out, Tensor, other)</span>
        <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">max_temp</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">slice</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">-</span><span class="n">ind</span><span class="p">);</span>     <span class="c1">//  BCHW，dim=3，则在W上，start=0，end=width-ind</span>
        <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">cur_temp</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">slice</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">-</span><span class="n">ind</span><span class="p">);</span>        
        <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">next_temp</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">slice</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>   <span class="c1">//  BCHW，dim=3，则在W上，start=ind，end=height</span>
        <span class="n">at</span><span class="o">::</span><span class="n">max_out</span><span class="p">(</span><span class="n">max_temp</span><span class="p">,</span> <span class="n">cur_temp</span><span class="p">,</span> <span class="n">next_temp</span><span class="p">);</span>    <span class="c1">// 依次取out[i] = max(out[i], out[i+1])，由于每次都比较过相应值，因而上面可以在直接&lt;&lt;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span> 
        <span class="n">output</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></table></code></div></div></details><h4 id="p3244-top_pool">P3.2.4.4 top_pool</h4><p>实际的top_pool位于core/models/py_utils/_cpools/src/top_pool.cpp。下面为前向计算的代码（反向计算没看）：</p><details><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">at</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&gt;</span> <span class="n">pool_forward</span><span class="p">(</span>
    <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">input</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Initialize output</span>
    <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">output</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

    <span class="c1">// Get width</span>
    <span class="kt">int64_t</span> <span class="n">width</span> <span class="o">=</span> <span class="n">input</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

    <span class="n">output</span><span class="p">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
    <span class="c1">// 取W方向当前位置值为：从当前位置往左的最大值</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int64_t</span> <span class="n">ind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ind</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">ind</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// slice(Tensor, dim, start, end, step = 1)   max_out(out, Tensor, other)</span>
        <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">max_temp</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">slice</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>    <span class="c1">//  BCHW，dim=3，则在W上，start=ind，end=width</span>
        <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">cur_temp</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">slice</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>        
        <span class="n">at</span><span class="o">::</span><span class="n">Tensor</span> <span class="n">next_temp</span> <span class="o">=</span> <span class="n">at</span><span class="o">::</span><span class="n">slice</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">-</span><span class="n">ind</span><span class="p">);</span>    <span class="c1">//  BCHW，dim=3，则在W上，start=0，end=height-ind</span>
        <span class="n">at</span><span class="o">::</span><span class="n">max_out</span><span class="p">(</span><span class="n">max_temp</span><span class="p">,</span> <span class="n">cur_temp</span><span class="p">,</span> <span class="n">next_temp</span><span class="p">);</span>    <span class="c1">// 依次取out[i] = max(out[i], out[i+1])，由于每次都比较过相应值，因而上面可以在直接&lt;&lt;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span> 
        <span class="n">output</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></table></code></div></div></details><h3 id="p325-骨干网络">P3.2.5 骨干网络</h3><p>位于core/models/py_utils/modules.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_make_layer</span><span class="p">(</span><span class="n">inp_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">,</span> <span class="n">modules</span><span class="p">):</span>
    <span class="n">layers</span>  <span class="o">=</span> <span class="p">[</span><span class="nf">residual</span><span class="p">(</span><span class="n">inp_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">)]</span>
    <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="nf">residual</span><span class="p">(</span><span class="n">out_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">modules</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_make_layer_revr</span><span class="p">(</span><span class="n">inp_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">,</span> <span class="n">modules</span><span class="p">):</span>
    <span class="n">layers</span>  <span class="o">=</span> <span class="p">[</span><span class="nf">residual</span><span class="p">(</span><span class="n">inp_dim</span><span class="p">,</span> <span class="n">inp_dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">modules</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="n">layers</span> <span class="o">+=</span> <span class="p">[</span><span class="nf">residual</span><span class="p">(</span><span class="n">inp_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_make_pool_layer</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">nn</span><span class="p">.</span><span class="nc">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_make_unpool_layer</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
    <span class="k">return</span> <span class="nf">upsample</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_make_merge_layer</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
    <span class="k">return</span> <span class="nf">merge</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">hg_module</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="n">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">modules</span><span class="p">,</span> <span class="n">make_up_layer</span><span class="o">=</span><span class="n">_make_layer</span><span class="p">,</span>
        <span class="n">make_pool_layer</span><span class="o">=</span><span class="n">_make_pool_layer</span><span class="p">,</span> <span class="n">make_hg_layer</span><span class="o">=</span><span class="n">_make_layer</span><span class="p">,</span>
        <span class="n">make_low_layer</span><span class="o">=</span><span class="n">_make_layer</span><span class="p">,</span> <span class="n">make_hg_layer_revr</span><span class="o">=</span><span class="n">_make_layer_revr</span><span class="p">,</span>
        <span class="n">make_unpool_layer</span><span class="o">=</span><span class="n">_make_unpool_layer</span><span class="p">,</span> <span class="n">make_merge_layer</span><span class="o">=</span><span class="n">_make_merge_layer</span>
    <span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">hg_module</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>

        <span class="n">curr_mod</span> <span class="o">=</span> <span class="n">modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">next_mod</span> <span class="o">=</span> <span class="n">modules</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">curr_dim</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">next_dim</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">self</span><span class="p">.</span><span class="n">n</span>    <span class="o">=</span> <span class="n">n</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up1</span>  <span class="o">=</span> <span class="nf">make_up_layer</span><span class="p">(</span><span class="n">curr_dim</span><span class="p">,</span> <span class="n">curr_dim</span><span class="p">,</span> <span class="n">curr_mod</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max1</span> <span class="o">=</span> <span class="nf">make_pool_layer</span><span class="p">(</span><span class="n">curr_dim</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">low1</span> <span class="o">=</span> <span class="nf">make_hg_layer</span><span class="p">(</span><span class="n">curr_dim</span><span class="p">,</span> <span class="n">next_dim</span><span class="p">,</span> <span class="n">curr_mod</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">low2</span> <span class="o">=</span> <span class="nf">hg_module</span><span class="p">(</span>
            <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">modules</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
            <span class="n">make_up_layer</span><span class="o">=</span><span class="n">make_up_layer</span><span class="p">,</span>
            <span class="n">make_pool_layer</span><span class="o">=</span><span class="n">make_pool_layer</span><span class="p">,</span>
            <span class="n">make_hg_layer</span><span class="o">=</span><span class="n">make_hg_layer</span><span class="p">,</span>
            <span class="n">make_low_layer</span><span class="o">=</span><span class="n">make_low_layer</span><span class="p">,</span>
            <span class="n">make_hg_layer_revr</span><span class="o">=</span><span class="n">make_hg_layer_revr</span><span class="p">,</span>
            <span class="n">make_unpool_layer</span><span class="o">=</span><span class="n">make_unpool_layer</span><span class="p">,</span>
            <span class="n">make_merge_layer</span><span class="o">=</span><span class="n">make_merge_layer</span>
        <span class="p">)</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="nf">make_low_layer</span><span class="p">(</span><span class="n">next_dim</span><span class="p">,</span> <span class="n">next_dim</span><span class="p">,</span> <span class="n">next_mod</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">low3</span> <span class="o">=</span> <span class="nf">make_hg_layer_revr</span><span class="p">(</span><span class="n">next_dim</span><span class="p">,</span> <span class="n">curr_dim</span><span class="p">,</span> <span class="n">curr_mod</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">up2</span>  <span class="o">=</span> <span class="nf">make_unpool_layer</span><span class="p">(</span><span class="n">curr_dim</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">merg</span> <span class="o">=</span> <span class="nf">make_merge_layer</span><span class="p">(</span><span class="n">curr_dim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">up1</span>  <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">up1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">max1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">max1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">low1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">low1</span><span class="p">(</span><span class="n">max1</span><span class="p">)</span>
        <span class="n">low2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">low2</span><span class="p">(</span><span class="n">low1</span><span class="p">)</span>
        <span class="n">low3</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">low3</span><span class="p">(</span><span class="n">low2</span><span class="p">)</span>
        <span class="n">up2</span>  <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">up2</span><span class="p">(</span><span class="n">low3</span><span class="p">)</span>
        <span class="n">merg</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">merg</span><span class="p">(</span><span class="n">up1</span><span class="p">,</span> <span class="n">up2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">merg</span>

<span class="k">class</span> <span class="nc">hg</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="c1"># hg如下
</span>    <span class="c1">#                  out[0]                                                 out[0]
</span>    <span class="c1">#                   ↑
</span>    <span class="c1">#       hgs[0] → cnvs[0] → cnvs_[0]
</span>    <span class="c1">#     ↗                            ↘                                      ↑
</span>    <span class="c1"># pre                                  + → relu → inters[0] → hgs[1] → cnvs[1]
</span>    <span class="c1">#    ↘         inters_[0]          ↗  
</span>    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">hg_modules</span><span class="p">,</span> <span class="n">cnvs</span><span class="p">,</span> <span class="n">inters</span><span class="p">,</span> <span class="n">cnvs_</span><span class="p">,</span> <span class="n">inters_</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">pre</span>  <span class="o">=</span> <span class="n">pre</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hgs</span>  <span class="o">=</span> <span class="n">hg_modules</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cnvs</span> <span class="o">=</span> <span class="n">cnvs</span>

        <span class="n">self</span><span class="p">.</span><span class="n">inters</span>  <span class="o">=</span> <span class="n">inters</span>
        <span class="n">self</span><span class="p">.</span><span class="n">inters_</span> <span class="o">=</span> <span class="n">inters_</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cnvs_</span>   <span class="o">=</span> <span class="n">cnvs_</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">inter</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pre</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">cnvs</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="p">(</span><span class="n">hg_</span><span class="p">,</span> <span class="n">cnv_</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">hgs</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">cnvs</span><span class="p">)):</span>  <span class="c1"># self.hgs为2个hg_module，self.cnvs为2个convolution
</span>            <span class="n">hg</span>  <span class="o">=</span> <span class="nf">hg_</span><span class="p">(</span><span class="n">inter</span><span class="p">)</span>
            <span class="n">cnv</span> <span class="o">=</span> <span class="nf">cnv_</span><span class="p">(</span><span class="n">hg</span><span class="p">)</span>
            <span class="n">cnvs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">cnv</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ind</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">hgs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>    <span class="c1"># len(self.hgs)-1=1，此处执行一次
</span>                <span class="n">inter</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">inters_</span><span class="p">[</span><span class="n">ind</span><span class="p">](</span><span class="n">inter</span><span class="p">)</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">cnvs_</span><span class="p">[</span><span class="n">ind</span><span class="p">](</span><span class="n">cnv</span><span class="p">)</span>
                <span class="n">inter</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="nf">relu_</span><span class="p">(</span><span class="n">inter</span><span class="p">)</span>
                <span class="n">inter</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">inters</span><span class="p">[</span><span class="n">ind</span><span class="p">](</span><span class="n">inter</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cnvs</span>

<span class="k">class</span> <span class="nc">hg_net</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">hg</span><span class="p">,</span> <span class="n">tl_modules</span><span class="p">,</span> <span class="n">br_modules</span><span class="p">,</span> <span class="n">tl_heats</span><span class="p">,</span> <span class="n">br_heats</span><span class="p">,</span> <span class="n">tl_tags</span><span class="p">,</span> <span class="n">br_tags</span><span class="p">,</span> <span class="n">tl_offs</span><span class="p">,</span> <span class="n">br_offs</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">hg_net</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_decode</span> <span class="o">=</span> <span class="n">_decode</span>

        <span class="n">self</span><span class="p">.</span><span class="n">hg</span> <span class="o">=</span> <span class="n">hg</span>

        <span class="n">self</span><span class="p">.</span><span class="n">tl_modules</span> <span class="o">=</span> <span class="n">tl_modules</span>
        <span class="n">self</span><span class="p">.</span><span class="n">br_modules</span> <span class="o">=</span> <span class="n">br_modules</span>

        <span class="n">self</span><span class="p">.</span><span class="n">tl_heats</span> <span class="o">=</span> <span class="n">tl_heats</span>
        <span class="n">self</span><span class="p">.</span><span class="n">br_heats</span> <span class="o">=</span> <span class="n">br_heats</span>

        <span class="n">self</span><span class="p">.</span><span class="n">tl_tags</span> <span class="o">=</span> <span class="n">tl_tags</span>
        <span class="n">self</span><span class="p">.</span><span class="n">br_tags</span> <span class="o">=</span> <span class="n">br_tags</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">tl_offs</span> <span class="o">=</span> <span class="n">tl_offs</span>
        <span class="n">self</span><span class="p">.</span><span class="n">br_offs</span> <span class="o">=</span> <span class="n">br_offs</span>

    <span class="k">def</span> <span class="nf">_train</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">xs</span><span class="p">):</span>
        <span class="c1"># train时由于hg有2个输出，因而右侧每组都有2个结果，test时只使用最后一个hg的输出进行预测
</span>        <span class="c1">#                               ↗tl_heat   左上角热图
</span>        <span class="c1">#                → tl_modules → → tl_tags   左上角embedding向量
</span>        <span class="c1">#              ↗               ↘tl_offs   左上角偏移
</span>        <span class="c1"># image → hg → 
</span>        <span class="c1">#              ↘               ↗br_heat   右下角热图
</span>        <span class="c1">#                → br_modules → → br_tags   右下角embedding向量 
</span>        <span class="c1">#                               ↘br_offs   右下角偏移
</span>        <span class="n">image</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="c1"># 
</span>        <span class="n">cnvs</span>  <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">hg</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>  <span class="c1"># 通过hg，得到特征
</span>
        <span class="n">tl_modules</span> <span class="o">=</span> <span class="p">[</span><span class="nf">tl_mod_</span><span class="p">(</span><span class="n">cnv</span><span class="p">)</span> <span class="k">for</span> <span class="n">tl_mod_</span><span class="p">,</span> <span class="n">cnv</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tl_modules</span><span class="p">,</span> <span class="n">cnvs</span><span class="p">)]</span>   <span class="c1"># 左上角池化
</span>        <span class="n">br_modules</span> <span class="o">=</span> <span class="p">[</span><span class="nf">br_mod_</span><span class="p">(</span><span class="n">cnv</span><span class="p">)</span> <span class="k">for</span> <span class="n">br_mod_</span><span class="p">,</span> <span class="n">cnv</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">br_modules</span><span class="p">,</span> <span class="n">cnvs</span><span class="p">)]</span>   <span class="c1"># 右下角池化
</span>        <span class="n">tl_heats</span>   <span class="o">=</span> <span class="p">[</span><span class="nf">tl_heat_</span><span class="p">(</span><span class="n">tl_mod</span><span class="p">)</span> <span class="k">for</span> <span class="n">tl_heat_</span><span class="p">,</span> <span class="n">tl_mod</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tl_heats</span><span class="p">,</span> <span class="n">tl_modules</span><span class="p">)]</span>   <span class="c1"># 左上角热图
</span>        <span class="n">br_heats</span>   <span class="o">=</span> <span class="p">[</span><span class="nf">br_heat_</span><span class="p">(</span><span class="n">br_mod</span><span class="p">)</span> <span class="k">for</span> <span class="n">br_heat_</span><span class="p">,</span> <span class="n">br_mod</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">br_heats</span><span class="p">,</span> <span class="n">br_modules</span><span class="p">)]</span>   <span class="c1"># 右下角热图
</span>        <span class="n">tl_tags</span>    <span class="o">=</span> <span class="p">[</span><span class="nf">tl_tag_</span><span class="p">(</span><span class="n">tl_mod</span><span class="p">)</span>  <span class="k">for</span> <span class="n">tl_tag_</span><span class="p">,</span>  <span class="n">tl_mod</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tl_tags</span><span class="p">,</span>  <span class="n">tl_modules</span><span class="p">)]</span>   <span class="c1"># 左上角embedding向量
</span>        <span class="n">br_tags</span>    <span class="o">=</span> <span class="p">[</span><span class="nf">br_tag_</span><span class="p">(</span><span class="n">br_mod</span><span class="p">)</span>  <span class="k">for</span> <span class="n">br_tag_</span><span class="p">,</span>  <span class="n">br_mod</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">br_tags</span><span class="p">,</span>  <span class="n">br_modules</span><span class="p">)]</span>   <span class="c1"># 右下角embedding向量
</span>        <span class="n">tl_offs</span>    <span class="o">=</span> <span class="p">[</span><span class="nf">tl_off_</span><span class="p">(</span><span class="n">tl_mod</span><span class="p">)</span>  <span class="k">for</span> <span class="n">tl_off_</span><span class="p">,</span>  <span class="n">tl_mod</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tl_offs</span><span class="p">,</span>  <span class="n">tl_modules</span><span class="p">)]</span>   <span class="c1"># 左上角偏移
</span>        <span class="n">br_offs</span>    <span class="o">=</span> <span class="p">[</span><span class="nf">br_off_</span><span class="p">(</span><span class="n">br_mod</span><span class="p">)</span>  <span class="k">for</span> <span class="n">br_off_</span><span class="p">,</span>  <span class="n">br_mod</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">br_offs</span><span class="p">,</span>  <span class="n">br_modules</span><span class="p">)]</span>   <span class="c1"># 右下角偏移
</span>        <span class="k">return</span> <span class="p">[</span><span class="n">tl_heats</span><span class="p">,</span> <span class="n">br_heats</span><span class="p">,</span> <span class="n">tl_tags</span><span class="p">,</span> <span class="n">br_tags</span><span class="p">,</span> <span class="n">tl_offs</span><span class="p">,</span> <span class="n">br_offs</span><span class="p">]</span>   <span class="c1"># 左上角热图、右下角热图、左上角embedding向量、右下角embedding向量、左上角偏移、右下角偏移
</span>
    <span class="k">def</span> <span class="nf">_test</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">xs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>   <span class="c1"># test时只使用最后一个hg的输出进行预测
</span>        <span class="n">image</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cnvs</span>  <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">hg</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>    <span class="c1"># 通过hg，得到特征
</span>
        <span class="n">tl_mod</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tl_modules</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">cnvs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>   <span class="c1"># 左上角池化
</span>        <span class="n">br_mod</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">br_modules</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">cnvs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>   <span class="c1"># 右下角池化
</span>
        <span class="n">tl_heat</span><span class="p">,</span> <span class="n">br_heat</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tl_heats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">tl_mod</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">br_heats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">br_mod</span><span class="p">)</span>   <span class="c1"># 左上角、右下角热图
</span>        <span class="n">tl_tag</span><span class="p">,</span>  <span class="n">br_tag</span>  <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tl_tags</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">tl_mod</span><span class="p">),</span>  <span class="n">self</span><span class="p">.</span><span class="n">br_tags</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">br_mod</span><span class="p">)</span>    <span class="c1"># 左上角embedding向量、右下角embedding向量
</span>        <span class="n">tl_off</span><span class="p">,</span>  <span class="n">br_off</span>  <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tl_offs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">tl_mod</span><span class="p">),</span>  <span class="n">self</span><span class="p">.</span><span class="n">br_offs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">br_mod</span><span class="p">)</span>    <span class="c1"># 左上角、右下角偏移
</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tl_heat</span><span class="p">,</span> <span class="n">br_heat</span><span class="p">,</span> <span class="n">tl_tag</span><span class="p">,</span> <span class="n">br_tag</span><span class="p">,</span> <span class="n">tl_off</span><span class="p">,</span> <span class="n">br_off</span><span class="p">]</span>

        <span class="c1">#  self._decode得到检测结果  [B*num_dets*8]  8为：bbox坐标，目标中心得分，左上角目标分值，右下角目标分值，目标类别
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_decode</span><span class="p">(</span><span class="o">*</span><span class="n">outs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">tl_heat</span><span class="p">,</span> <span class="n">br_heat</span><span class="p">,</span> <span class="n">tl_tag</span><span class="p">,</span> <span class="n">br_tag</span>  <span class="c1">#  检测结果，左上角热图、右下角热图、左上角embedding向量、右下角embedding向量  最终返回core\test\cornernet.py中decode函数（只使用本函数结果的[0]，中间还有一系列返回位置）
</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">xs</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_train</span><span class="p">(</span><span class="o">*</span><span class="n">xs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">_test</span><span class="p">(</span><span class="o">*</span><span class="n">xs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></table></code></div></div></details><h3 id="p326-额外调用的函数upsample和merge">P3.2.6 额外调用的函数upsample和merge</h3><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">upsample</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">upsample</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scale_factor</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="nf">interpolate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">scale_factor</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">merge</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></table></code></div></div></details><h2 id="p33-损失cornernet_loss">P3.3 损失CornerNet_Loss</h2><p>位于core/models/py_utils/losses.py</p><h3 id="p331-cornernet_loss">P3.3.1 CornerNet_Loss</h3><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="p">.</span><span class="nf">clamp</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">sigmoid_</span><span class="p">(),</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_ae_loss</span><span class="p">(</span><span class="n">tag0</span><span class="p">,</span> <span class="n">tag1</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
    <span class="n">num</span>  <span class="o">=</span> <span class="n">mask</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>  <span class="c1"># mask：B*128  num：当前batch每个图像上有多少个目标
</span>    <span class="n">tag0</span> <span class="o">=</span> <span class="n">tag0</span><span class="p">.</span><span class="nf">squeeze</span><span class="p">()</span>   <span class="c1"># B*128*1  tag0：去掉最后为1的维度  为上（或左）的embedding向量
</span>    <span class="n">tag1</span> <span class="o">=</span> <span class="n">tag1</span><span class="p">.</span><span class="nf">squeeze</span><span class="p">()</span>   <span class="c1"># B*128*1  tag1：去掉最后为1的维度  为下（或右）的embedding向量 
</span>
    <span class="n">tag_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">tag0</span> <span class="o">+</span> <span class="n">tag1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>   <span class="c1"># 中点
</span>
    <span class="n">tag0</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">pow</span><span class="p">(</span><span class="n">tag0</span> <span class="o">-</span> <span class="n">tag_mean</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">num</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="p">)</span>  <span class="c1"># 论文中公式4
</span>    <span class="n">tag0</span> <span class="o">=</span> <span class="n">tag0</span><span class="p">[</span><span class="n">mask</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>     <span class="c1"># 取有效的结果
</span>    <span class="n">tag1</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">pow</span><span class="p">(</span><span class="n">tag1</span> <span class="o">-</span> <span class="n">tag_mean</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">num</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="p">)</span>  <span class="c1"># 论文中公式4
</span>    <span class="n">tag1</span> <span class="o">=</span> <span class="n">tag1</span><span class="p">[</span><span class="n">mask</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>     <span class="c1"># 取有效的结果
</span>    <span class="n">pull</span> <span class="o">=</span> <span class="n">tag0</span> <span class="o">+</span> <span class="n">tag1</span>   <span class="c1"># 论文中公式4
</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">mask</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># B*1*128 + B*128*1的进行broadcast相加，得到B*128*128。
</span>    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">.</span><span class="nf">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="c1"># 得到两两配对，均是目标的索引
</span>    <span class="n">num</span>  <span class="o">=</span> <span class="n">num</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">num2</span> <span class="o">=</span> <span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">tag_mean</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">tag_mean</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 得到两两配对时，相互之间的距离
</span>    <span class="n">dist</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">torch</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>  <span class="c1"># 论文中公式5的△-|e_k-e_j|，此处包含j=k
</span>    <span class="n">dist</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="nf">relu</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>   <span class="c1"># 论文中公式5的max(0, △-|e_k-e_j|)，此处包含j=k
</span>    <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">num</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="p">)</span>   <span class="c1"># 去除j=k的，是需要除法，此处每个值都-1，下面sum()后，相当于(dist-1/num)*(num*num)=系数*dist-num，实际每个图像共num个j=k的，此处结合dist.sum()等效于dist-num
</span>    <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">/</span> <span class="p">(</span><span class="n">num2</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">push</span> <span class="o">=</span> <span class="n">dist</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>   <span class="c1"># 论文中公式5
</span>    <span class="k">return</span> <span class="n">pull</span><span class="p">,</span> <span class="n">push</span>

<span class="k">def</span> <span class="nf">_off_loss</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">gt_off</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>  <span class="c1"># gt_off：B*128*2   mask:B*128，有目标相应值为1，否则为0
</span>    <span class="n">num</span>  <span class="o">=</span> <span class="n">mask</span><span class="p">.</span><span class="nf">float</span><span class="p">().</span><span class="nf">sum</span><span class="p">()</span>  <span class="c1"># 
</span>    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">expand_as</span><span class="p">(</span><span class="n">gt_off</span><span class="p">)</span>   <span class="c1"># B*128*2 
</span>
    <span class="n">off</span>    <span class="o">=</span> <span class="n">off</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>      <span class="c1"># 得到有目标的预测偏移
</span>    <span class="n">gt_off</span> <span class="o">=</span> <span class="n">gt_off</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>   <span class="c1"># 得到有目标的实际偏移
</span>    
    <span class="n">off_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="nf">smooth_l1_loss</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">gt_off</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="sh">"</span><span class="s">sum</span><span class="sh">"</span><span class="p">)</span>   <span class="c1"># 预测偏移和实际偏移的L1损失
</span>    <span class="n">off_loss</span> <span class="o">=</span> <span class="n">off_loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">num</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="p">)</span>   <span class="c1"># L1损失
</span>    <span class="k">return</span> <span class="n">off_loss</span>

<span class="k">def</span> <span class="nf">_focal_loss</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">gt</span><span class="p">):</span>
    <span class="n">pos_inds</span> <span class="o">=</span> <span class="n">gt</span><span class="p">.</span><span class="nf">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">neg_inds</span> <span class="o">=</span> <span class="n">gt</span><span class="p">.</span><span class="nf">lt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">neg_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">pow</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">gt</span><span class="p">[</span><span class="n">neg_inds</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">preds</span><span class="p">:</span>   <span class="c1"># preds为list，代表预测的[上，左]或者[下，右]热图
</span>        <span class="n">pos_pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">pos_inds</span><span class="p">]</span>
        <span class="n">neg_pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">neg_inds</span><span class="p">]</span>

        <span class="n">pos_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">pos_pred</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="nf">pow</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pos_pred</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">neg_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">neg_pred</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="nf">pow</span><span class="p">(</span><span class="n">neg_pred</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">neg_weights</span>

        <span class="n">num_pos</span>  <span class="o">=</span> <span class="n">pos_inds</span><span class="p">.</span><span class="nf">float</span><span class="p">().</span><span class="nf">sum</span><span class="p">()</span>
        <span class="n">pos_loss</span> <span class="o">=</span> <span class="n">pos_loss</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>
        <span class="n">neg_loss</span> <span class="o">=</span> <span class="n">neg_loss</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pos_pred</span><span class="p">.</span><span class="nf">nelement</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">-</span> <span class="n">neg_loss</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_loss</span> <span class="o">+</span> <span class="n">neg_loss</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_pos</span>
    <span class="k">return</span> <span class="n">loss</span>

<span class="k">class</span> <span class="nc">CornerNet_Loss</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pull_weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">push_weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">off_weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">focal_loss</span><span class="o">=</span><span class="n">_focal_loss</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">CornerNet_Loss</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">pull_weight</span> <span class="o">=</span> <span class="n">pull_weight</span>   <span class="c1"># 分组相同角点的损失的权重
</span>        <span class="n">self</span><span class="p">.</span><span class="n">push_weight</span> <span class="o">=</span> <span class="n">push_weight</span>   <span class="c1"># 分离不同角点的损失的权重  
</span>        <span class="n">self</span><span class="p">.</span><span class="n">off_weight</span>  <span class="o">=</span> <span class="n">off_weight</span>    <span class="c1"># 预测偏移损失的权重
</span>        <span class="n">self</span><span class="p">.</span><span class="n">focal_loss</span>  <span class="o">=</span> <span class="n">focal_loss</span>    <span class="c1"># 热图的损失函数
</span>        <span class="n">self</span><span class="p">.</span><span class="n">ae_loss</span>     <span class="o">=</span> <span class="n">_ae_loss</span>      <span class="c1"># 对角点进行分组的损失函数
</span>        <span class="n">self</span><span class="p">.</span><span class="n">off_loss</span>    <span class="o">=</span> <span class="n">_off_loss</span>     <span class="c1"># 预测偏移的损失函数
</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">outs</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
        <span class="n">tl_heats</span> <span class="o">=</span> <span class="n">outs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># 预测目标左上角热图   2个B*80*H*W
</span>        <span class="n">br_heats</span> <span class="o">=</span> <span class="n">outs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># 预测目标右下角热图   2个B*80*H*W
</span>        <span class="n">tl_tags</span>  <span class="o">=</span> <span class="n">outs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>   <span class="c1"># 预测目标左上角embedding向量   2个B*1*H*W
</span>        <span class="n">br_tags</span>  <span class="o">=</span> <span class="n">outs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>   <span class="c1"># 预测目标右下角embedding向量   2个B*1*H*W
</span>        <span class="n">tl_offs</span>  <span class="o">=</span> <span class="n">outs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>   <span class="c1"># 预测目标左上角偏移   2个B*2*H*W
</span>        <span class="n">br_offs</span>  <span class="o">=</span> <span class="n">outs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>   <span class="c1"># 预测目标右下角偏移   2个B*2*H*W
</span>
        <span class="n">gt_tl_heat</span>  <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>     <span class="c1"># BCHW      gt左上角热图  C=80
</span>        <span class="n">gt_br_heat</span>  <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>     <span class="c1"># BCHW      gt右下角热图  C=80
</span>        <span class="n">gt_mask</span>     <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>     <span class="c1"># B*128     每个图像上有目标的mask，有目标相应值为1，否则为0
</span>        <span class="n">gt_tl_off</span>   <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>     <span class="c1"># B*128*2   左上角坐标gt偏移
</span>        <span class="n">gt_br_off</span>   <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>     <span class="c1"># B*128*2   右下角坐标gt偏移
</span>        <span class="n">gt_tl_ind</span>   <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>     <span class="c1"># B*128     当前图像上，当宽高为一维时，左上角顶点的位置
</span>        <span class="n">gt_br_ind</span>   <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>     <span class="c1"># B*128     当前图像上，当宽高为一维时，右下角顶点的位置
</span>
        <span class="c1"># focal loss
</span>        <span class="n">focal_loss</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 预测角点的损失（左上角+右下角）
</span>
        <span class="n">tl_heats</span> <span class="o">=</span> <span class="p">[</span><span class="nf">_sigmoid</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tl_heats</span><span class="p">]</span>   <span class="c1"># 左上角热图映射到0-1之间
</span>        <span class="n">br_heats</span> <span class="o">=</span> <span class="p">[</span><span class="nf">_sigmoid</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">br_heats</span><span class="p">]</span>   <span class="c1"># 右下角热图映射到0-1之间
</span>
        <span class="n">focal_loss</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nf">focal_loss</span><span class="p">(</span><span class="n">tl_heats</span><span class="p">,</span> <span class="n">gt_tl_heat</span><span class="p">)</span>   <span class="c1"># 左上角热图的总损失
</span>        <span class="n">focal_loss</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nf">focal_loss</span><span class="p">(</span><span class="n">br_heats</span><span class="p">,</span> <span class="n">gt_br_heat</span><span class="p">)</span>   <span class="c1"># 之前损失 + 右下角热图的总损失
</span>
        <span class="c1"># tag loss
</span>        <span class="n">pull_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">push_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tl_tags</span>   <span class="o">=</span> <span class="p">[</span><span class="nf">_tranpose_and_gather_feat</span><span class="p">(</span><span class="n">tl_tag</span><span class="p">,</span> <span class="n">gt_tl_ind</span><span class="p">)</span> <span class="k">for</span> <span class="n">tl_tag</span> <span class="ow">in</span> <span class="n">tl_tags</span><span class="p">]</span>  <span class="c1"># 分别从左上角embedding向量上得到实际点的embedding向量，2个B*128*1的矩阵
</span>        <span class="n">br_tags</span>   <span class="o">=</span> <span class="p">[</span><span class="nf">_tranpose_and_gather_feat</span><span class="p">(</span><span class="n">br_tag</span><span class="p">,</span> <span class="n">gt_br_ind</span><span class="p">)</span> <span class="k">for</span> <span class="n">br_tag</span> <span class="ow">in</span> <span class="n">br_tags</span><span class="p">]</span>  <span class="c1"># 分别从右下角embedding向量上得到实际点的embedding向量，2个B*128*1的矩阵
</span>        <span class="k">for</span> <span class="n">tl_tag</span><span class="p">,</span> <span class="n">br_tag</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">tl_tags</span><span class="p">,</span> <span class="n">br_tags</span><span class="p">):</span>
            <span class="n">pull</span><span class="p">,</span> <span class="n">push</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">ae_loss</span><span class="p">(</span><span class="n">tl_tag</span><span class="p">,</span> <span class="n">br_tag</span><span class="p">,</span> <span class="n">gt_mask</span><span class="p">)</span>  <span class="c1"># 依次计算是否是同一个目标框的上和下、左和右角点的损失
</span>            <span class="n">pull_loss</span> <span class="o">+=</span> <span class="n">pull</span>
            <span class="n">push_loss</span> <span class="o">+=</span> <span class="n">push</span>
        <span class="n">pull_loss</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">pull_weight</span> <span class="o">*</span> <span class="n">pull_loss</span>   <span class="c1"># 分组相同角点的损失
</span>        <span class="n">push_loss</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">push_weight</span> <span class="o">*</span> <span class="n">push_loss</span>   <span class="c1"># 分离不同角点的损失
</span>
        <span class="n">off_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tl_offs</span>  <span class="o">=</span> <span class="p">[</span><span class="nf">_tranpose_and_gather_feat</span><span class="p">(</span><span class="n">tl_off</span><span class="p">,</span> <span class="n">gt_tl_ind</span><span class="p">)</span> <span class="k">for</span> <span class="n">tl_off</span> <span class="ow">in</span> <span class="n">tl_offs</span><span class="p">]</span>  <span class="c1"># 预测左上角角点的实际偏移，2个B*128*2的矩阵
</span>        <span class="n">br_offs</span>  <span class="o">=</span> <span class="p">[</span><span class="nf">_tranpose_and_gather_feat</span><span class="p">(</span><span class="n">br_off</span><span class="p">,</span> <span class="n">gt_br_ind</span><span class="p">)</span> <span class="k">for</span> <span class="n">br_off</span> <span class="ow">in</span> <span class="n">br_offs</span><span class="p">]</span>  <span class="c1"># 预测右下角角点的实际偏移，2个B*128*2的矩阵
</span>        <span class="k">for</span> <span class="n">tl_off</span><span class="p">,</span> <span class="n">br_off</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">tl_offs</span><span class="p">,</span> <span class="n">br_offs</span><span class="p">):</span>
            <span class="n">off_loss</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nf">off_loss</span><span class="p">(</span><span class="n">tl_off</span><span class="p">,</span> <span class="n">gt_tl_off</span><span class="p">,</span> <span class="n">gt_mask</span><span class="p">)</span>     <span class="c1"># 预测左上角角点偏移的损失
</span>            <span class="n">off_loss</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nf">off_loss</span><span class="p">(</span><span class="n">br_off</span><span class="p">,</span> <span class="n">gt_br_off</span><span class="p">,</span> <span class="n">gt_mask</span><span class="p">)</span>     <span class="c1"># 预测右下角角点偏移的损失
</span>        <span class="n">off_loss</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">off_weight</span> <span class="o">*</span> <span class="n">off_loss</span>    <span class="c1"># 总的预测偏移的损失
</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">focal_loss</span> <span class="o">+</span> <span class="n">pull_loss</span> <span class="o">+</span> <span class="n">push_loss</span> <span class="o">+</span> <span class="n">off_loss</span><span class="p">)</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">tl_heats</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>    <span class="c1"># 总损失
</span>        <span class="k">return</span> <span class="n">loss</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></table></code></div></div></details><h3 id="p332-_tranpose_and_gather_feat">P3.3.2 _tranpose_and_gather_feat</h3><p>位于core/models/py_utils/utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_tranpose_and_gather_feat</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">ind</span><span class="p">):</span>   <span class="c1"># 和_gather_feat比，有一个BCHW转到BHWC再转到B(HW)C的过程
</span>    <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="p">.</span><span class="nf">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">contiguous</span><span class="p">()</span>   <span class="c1"># BCHW变成BHWC
</span>    <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">feat</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">feat</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>    <span class="c1"># BHWC变成B(HW)C
</span>    <span class="n">feat</span> <span class="o">=</span> <span class="nf">_gather_feat</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>   <span class="c1"># 得到当前batch中HW上所有ind处的特征   B*n*C
</span>    <span class="k">return</span> <span class="n">feat</span>

<span class="k">def</span> <span class="nf">_gather_feat</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>    <span class="c1"># 和_tranpose_and_gather_feat比，无一个BCHW转到BHWC再转到B(HW)C的过程
</span>    <span class="n">dim</span>  <span class="o">=</span> <span class="n">feat</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 通道数
</span>    <span class="n">ind</span>  <span class="o">=</span> <span class="n">ind</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">expand</span><span class="p">(</span><span class="n">ind</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ind</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dim</span><span class="p">)</span>
    <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>   <span class="c1"># B*n*C
</span>    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">expand_as</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
        <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">feat</span>
</pre></table></code></div></div></details><h2 id="p34-获取数据时的cornernet">P3.4 获取数据时的cornernet</h2><p>位于core/sample/cornernet.py</p><h3 id="p341-cornernet">P3.4.1 cornernet</h3><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_resize_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">detections</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>  <span class="c1"># 缩放图像及gt信息
</span>    <span class="n">detections</span>    <span class="o">=</span> <span class="n">detections</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>   <span class="c1"># 输入图像高宽
</span>    <span class="n">new_height</span><span class="p">,</span> <span class="n">new_width</span> <span class="o">=</span> <span class="n">size</span>   <span class="c1"># 目标高宽
</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">new_width</span><span class="p">,</span> <span class="n">new_height</span><span class="p">))</span>
    
    <span class="n">height_ratio</span> <span class="o">=</span> <span class="n">new_height</span> <span class="o">/</span> <span class="n">height</span>   <span class="c1"># 高度缩放比例
</span>    <span class="n">width_ratio</span>  <span class="o">=</span> <span class="n">new_width</span>  <span class="o">/</span> <span class="n">width</span>    <span class="c1"># 宽度缩放比例
</span>    <span class="n">detections</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">width_ratio</span>   <span class="c1"># 缩放相应gt信息
</span>    <span class="n">detections</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">height_ratio</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">detections</span>

<span class="k">def</span> <span class="nf">_clip_detections</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">detections</span><span class="p">):</span>   <span class="c1"># 裁剪（宽高在图像范围内）、校验（目标宽高均&gt;0）gt信息
</span>    <span class="n">detections</span>    <span class="o">=</span> <span class="n">detections</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">detections</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">detections</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># 保证gt信息不超过图像边界，防止之前随机裁剪把目标裁掉了
</span>    <span class="n">detections</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">detections</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">keep_inds</span>  <span class="o">=</span> <span class="p">((</span><span class="n">detections</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">detections</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">detections</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">detections</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>   <span class="c1"># 目标宽高均&gt;0的索引，防止之前随机裁剪把目标裁掉了
</span>    <span class="n">detections</span> <span class="o">=</span> <span class="n">detections</span><span class="p">[</span><span class="n">keep_inds</span><span class="p">]</span>   <span class="c1"># 得到处理后的gt信息
</span>    <span class="k">return</span> <span class="n">detections</span>

<span class="k">def</span> <span class="nf">cornernet</span><span class="p">(</span><span class="n">system_configs</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">k_ind</span><span class="p">,</span> <span class="n">data_aug</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span>   <span class="c1"># cornernet获取数据的函数
</span>    <span class="n">data_rng</span>   <span class="o">=</span> <span class="n">system_configs</span><span class="p">.</span><span class="n">data_rng</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">system_configs</span><span class="p">.</span><span class="n">batch_size</span>

    <span class="n">categories</span>   <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">categories</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># 80
</span>    <span class="n">input_size</span>   <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">input_size</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># [511, 511]
</span>    <span class="n">output_size</span>  <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">output_sizes</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># output_sizes：[[128, 128]]，取[0]得到[128, 128]
</span>
    <span class="n">border</span>        <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">border</span><span class="sh">"</span><span class="p">]</span>   <span class="c1"># 128
</span>    <span class="n">lighting</span>      <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">lighting</span><span class="sh">"</span><span class="p">]</span> <span class="c1"># True   core\dbs\detection.py
</span>    <span class="n">rand_crop</span>     <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_crop</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># true
</span>    <span class="n">rand_color</span>    <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_color</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># true
</span>    <span class="n">rand_scales</span>   <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_scales</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># 配置为null，则为np.arange(rand_scale_min=0.6, rand_scale_max=1.4, rand_scale_step=0.1)
</span>    <span class="n">gaussian_bump</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">gaussian_bump</span><span class="sh">"</span><span class="p">]</span>   <span class="c1"># true
</span>    <span class="n">gaussian_iou</span>  <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">gaussian_iou</span><span class="sh">"</span><span class="p">]</span>   <span class="c1"># 0.3
</span>    <span class="n">gaussian_rad</span>  <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">gaussian_radius</span><span class="sh">"</span><span class="p">]</span>  <span class="c1"># -1   core\dbs\detection.py
</span>
    <span class="n">max_tag_len</span> <span class="o">=</span> <span class="mi">128</span>

    <span class="c1"># allocating memory
</span>    <span class="n">images</span>      <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">input_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>   <span class="c1"># BCHW  图像
</span>    <span class="n">tl_heatmaps</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>   <span class="c1"># BCHW  左上角顶点热图
</span>    <span class="n">br_heatmaps</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>   <span class="c1"># BCHW  右下角顶点热图
</span>    <span class="n">tl_regrs</span>    <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_tag_len</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>                               <span class="c1"># B*128*2   左上角坐标gt偏移
</span>    <span class="n">br_regrs</span>    <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_tag_len</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>                               <span class="c1"># B*128*2   右下角坐标gt偏移
</span>    <span class="n">tl_tags</span>     <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_tag_len</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>                                    <span class="c1"># B*128     当前图像上，当宽高为一维时，左上角顶点的位置
</span>    <span class="n">br_tags</span>     <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_tag_len</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>                                    <span class="c1"># B*128     当前图像上，当宽高为一维时，右下角顶点的位置
</span>    <span class="n">tag_masks</span>   <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_tag_len</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>                                    <span class="c1"># B*128     每个图像上有目标的mask，有目标相应值为1，否则为0
</span>    <span class="n">tag_lens</span>    <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">int32</span><span class="p">)</span>                                               <span class="c1"># 128       当前batch中每个图像上目标数量
</span>
    <span class="n">db_size</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">db_inds</span><span class="p">.</span><span class="n">size</span>   <span class="c1"># 数据库中图像数量
</span>    <span class="k">for</span> <span class="n">b_ind</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>  <span class="c1"># 得到batch中的数据
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">k_ind</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">db</span><span class="p">.</span><span class="nf">shuffle_inds</span><span class="p">()</span>    <span class="c1"># 打乱图像索引顺序，得到新的图像顺序
</span>
        <span class="n">db_ind</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">db_inds</span><span class="p">[</span><span class="n">k_ind</span><span class="p">]</span>    <span class="c1"># 得到当前图像索引
</span>        <span class="n">k_ind</span>  <span class="o">=</span> <span class="p">(</span><span class="n">k_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">db_size</span>  <span class="c1"># 超出图像数量，则从0开始
</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="nf">image_path</span><span class="p">(</span><span class="n">db_ind</span><span class="p">)</span>   <span class="c1"># 图像路径
</span>        <span class="n">image</span>      <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>  <span class="c1"># reading image
</span>
        <span class="n">detections</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="nf">detections</span><span class="p">(</span><span class="n">db_ind</span><span class="p">)</span>    <span class="c1"># detections:{图像名字:n*[x1,y1,x2,y2,类别]}  # reading detections  
</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">rand_crop</span><span class="p">:</span>   <span class="c1"># cropping an image randomly
</span>            <span class="n">image</span><span class="p">,</span> <span class="n">detections</span> <span class="o">=</span> <span class="nf">random_crop</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">detections</span><span class="p">,</span> <span class="n">rand_scales</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="n">border</span><span class="p">)</span>  <span class="c1"># 随机裁剪图像，返回裁剪后的图像及gt信息（n*[x1,y1,x2,y2,类别]）
</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">detections</span> <span class="o">=</span> <span class="nf">_resize_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">detections</span><span class="p">,</span> <span class="n">input_size</span><span class="p">)</span>    <span class="c1"># 缩放图像及gt信息
</span>        <span class="n">detections</span> <span class="o">=</span> <span class="nf">_clip_detections</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">detections</span><span class="p">)</span>     <span class="c1"># 裁剪（宽高在图像范围内）、校验（目标宽高均&gt;0）gt信息，防止之前随机裁剪把目标裁掉了
</span>
        <span class="n">width_ratio</span>  <span class="o">=</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">input_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># 输出特征和输入图像宽高之比
</span>        <span class="n">height_ratio</span> <span class="o">=</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">input_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># flipping an image randomly
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">uniform</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>   <span class="c1"># 水平翻转图像及坐标
</span>            <span class="n">image</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">width</span>    <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">detections</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">detections</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span>   <span class="c1"># 图像像素范围缩放到0-1
</span>            <span class="k">if</span> <span class="n">rand_color</span><span class="p">:</span>
                <span class="nf">color_jittering_</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>   <span class="c1"># 亮度、对比度、饱和度随机扰动
</span>                <span class="k">if</span> <span class="n">lighting</span><span class="p">:</span>
                    <span class="nf">lighting_</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">db</span><span class="p">.</span><span class="n">eig_val</span><span class="p">,</span> <span class="n">db</span><span class="p">.</span><span class="n">eig_vec</span><span class="p">)</span>   <span class="c1"># 不知道这个是干什么的
</span>            <span class="nf">normalize_</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">db</span><span class="p">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">db</span><span class="p">.</span><span class="n">std</span><span class="p">)</span>    <span class="c1"># 归一化图像
</span>        <span class="n">images</span><span class="p">[</span><span class="n">b_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="nf">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>   <span class="c1"># CHW到HWC
</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">detection</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">detections</span><span class="p">):</span>  <span class="c1"># 依次处理每个目标，得到训练用的gt相关结果
</span>            <span class="n">category</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">detection</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>    <span class="c1"># 目标类别。coco的0为背景，cornernet无背景通道
</span>
            <span class="n">xtl</span><span class="p">,</span> <span class="n">ytl</span> <span class="o">=</span> <span class="n">detection</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">detection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 左上角顶点xy坐标
</span>            <span class="n">xbr</span><span class="p">,</span> <span class="n">ybr</span> <span class="o">=</span> <span class="n">detection</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">detection</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># 右下角顶点xy坐标
</span>
            <span class="n">fxtl</span> <span class="o">=</span> <span class="p">(</span><span class="n">xtl</span> <span class="o">*</span> <span class="n">width_ratio</span><span class="p">)</span>  <span class="c1"># 输出特征左上角xy坐标
</span>            <span class="n">fytl</span> <span class="o">=</span> <span class="p">(</span><span class="n">ytl</span> <span class="o">*</span> <span class="n">height_ratio</span><span class="p">)</span>
            <span class="n">fxbr</span> <span class="o">=</span> <span class="p">(</span><span class="n">xbr</span> <span class="o">*</span> <span class="n">width_ratio</span><span class="p">)</span>  <span class="c1"># 输出特征右下角xy坐标
</span>            <span class="n">fybr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ybr</span> <span class="o">*</span> <span class="n">height_ratio</span><span class="p">)</span>

            <span class="n">xtl</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">fxtl</span><span class="p">)</span>   <span class="c1"># 左上角顶点xy坐标取整
</span>            <span class="n">ytl</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">fytl</span><span class="p">)</span>
            <span class="n">xbr</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">fxbr</span><span class="p">)</span>   <span class="c1"># 右下角顶点xy坐标取整
</span>            <span class="n">ybr</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">fybr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">gaussian_bump</span><span class="p">:</span>   <span class="c1"># True
</span>                <span class="n">width</span>  <span class="o">=</span> <span class="n">detection</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">detection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># 目标宽高
</span>                <span class="n">height</span> <span class="o">=</span> <span class="n">detection</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">detection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">width</span>  <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">ceil</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">width_ratio</span><span class="p">)</span>   <span class="c1"># 特征图上目标宽高
</span>                <span class="n">height</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="nf">ceil</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">height_ratio</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">gaussian_rad</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">radius</span> <span class="o">=</span> <span class="nf">gaussian_radius</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">gaussian_iou</span><span class="p">)</span>   <span class="c1"># 半径。在半径内的点得到的框仍旧认为是正确的检测框
</span>                    <span class="n">radius</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">radius</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">radius</span> <span class="o">=</span> <span class="n">gaussian_rad</span>

                <span class="nf">draw_gaussian</span><span class="p">(</span><span class="n">tl_heatmaps</span><span class="p">[</span><span class="n">b_ind</span><span class="p">,</span> <span class="n">category</span><span class="p">],</span> <span class="p">[</span><span class="n">xtl</span><span class="p">,</span> <span class="n">ytl</span><span class="p">],</span> <span class="n">radius</span><span class="p">)</span>  <span class="c1"># 热图上相应通道相应顶点画半径为radius的高斯分布的gt热图
</span>                <span class="nf">draw_gaussian</span><span class="p">(</span><span class="n">br_heatmaps</span><span class="p">[</span><span class="n">b_ind</span><span class="p">,</span> <span class="n">category</span><span class="p">],</span> <span class="p">[</span><span class="n">xbr</span><span class="p">,</span> <span class="n">ybr</span><span class="p">],</span> <span class="n">radius</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tl_heatmaps</span><span class="p">[</span><span class="n">b_ind</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">ytl</span><span class="p">,</span> <span class="n">xtl</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># 热图上相应通道相应顶点设置为1
</span>                <span class="n">br_heatmaps</span><span class="p">[</span><span class="n">b_ind</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">ybr</span><span class="p">,</span> <span class="n">xbr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">tag_ind</span> <span class="o">=</span> <span class="n">tag_lens</span><span class="p">[</span><span class="n">b_ind</span><span class="p">]</span>   <span class="c1"># 得到当前图像上第tag_ind个目标的索引
</span>            <span class="n">tl_regrs</span><span class="p">[</span><span class="n">b_ind</span><span class="p">,</span> <span class="n">tag_ind</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fxtl</span> <span class="o">-</span> <span class="n">xtl</span><span class="p">,</span> <span class="n">fytl</span> <span class="o">-</span> <span class="n">ytl</span><span class="p">]</span>   <span class="c1"># 设置当前图像上相应目标的gt的偏移
</span>            <span class="n">br_regrs</span><span class="p">[</span><span class="n">b_ind</span><span class="p">,</span> <span class="n">tag_ind</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fxbr</span> <span class="o">-</span> <span class="n">xbr</span><span class="p">,</span> <span class="n">fybr</span> <span class="o">-</span> <span class="n">ybr</span><span class="p">]</span>
            <span class="n">tl_tags</span><span class="p">[</span><span class="n">b_ind</span><span class="p">,</span> <span class="n">tag_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ytl</span> <span class="o">*</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">xtl</span>   <span class="c1"># 得到当前图像上，当宽高为一维时，顶点的位置
</span>            <span class="n">br_tags</span><span class="p">[</span><span class="n">b_ind</span><span class="p">,</span> <span class="n">tag_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ybr</span> <span class="o">*</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">xbr</span>
            <span class="n">tag_lens</span><span class="p">[</span><span class="n">b_ind</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>   <span class="c1"># 相应图像上目标数量+1
</span>
    <span class="k">for</span> <span class="n">b_ind</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">tag_len</span> <span class="o">=</span> <span class="n">tag_lens</span><span class="p">[</span><span class="n">b_ind</span><span class="p">]</span>        <span class="c1">#  得到每个图像上目标数量
</span>        <span class="n">tag_masks</span><span class="p">[</span><span class="n">b_ind</span><span class="p">,</span> <span class="p">:</span><span class="n">tag_len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># 每个图像上有目标的mask，有目标相应值为1，否则为0
</span>
    <span class="n">images</span>      <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="n">tl_heatmaps</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">tl_heatmaps</span><span class="p">)</span>
    <span class="n">br_heatmaps</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">br_heatmaps</span><span class="p">)</span>
    <span class="n">tl_regrs</span>    <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">tl_regrs</span><span class="p">)</span>
    <span class="n">br_regrs</span>    <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">br_regrs</span><span class="p">)</span>
    <span class="n">tl_tags</span>     <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">tl_tags</span><span class="p">)</span>
    <span class="n">br_tags</span>     <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">br_tags</span><span class="p">)</span>
    <span class="n">tag_masks</span>   <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">tag_masks</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">xs</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">images</span><span class="p">],</span> <span class="sh">"</span><span class="s">ys</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="n">tl_heatmaps</span><span class="p">,</span> <span class="n">br_heatmaps</span><span class="p">,</span> <span class="n">tag_masks</span><span class="p">,</span> <span class="n">tl_regrs</span><span class="p">,</span> <span class="n">br_regrs</span><span class="p">,</span> <span class="n">tl_tags</span><span class="p">,</span> <span class="n">br_tags</span><span class="p">]},</span> <span class="n">k_ind</span>
</pre></table></code></div></div></details><h3 id="p342-random_crop">P3.4.2 random_crop</h3><p>随机裁剪图像，位于core/sample/utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_get_border</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">size</span> <span class="o">-</span> <span class="n">border</span> <span class="o">//</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">border</span> <span class="o">//</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">*=</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">border</span> <span class="o">//</span> <span class="n">i</span>

<span class="k">def</span> <span class="nf">random_crop</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">detections</span><span class="p">,</span> <span class="n">random_scales</span><span class="p">,</span> <span class="n">view_size</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>  <span class="c1"># 随机裁剪图像
</span>    <span class="n">view_height</span><span class="p">,</span> <span class="n">view_width</span>   <span class="o">=</span> <span class="n">view_size</span>   <span class="c1"># 裁剪后图像的高宽
</span>    <span class="n">image_height</span><span class="p">,</span> <span class="n">image_width</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">scale</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">random_scales</span><span class="p">)</span>   <span class="c1"># 在random_scales随机选一个scale
</span>    <span class="n">height</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">view_height</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>   <span class="c1"># 裁剪并缩放后的高宽
</span>    <span class="n">width</span>  <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">view_width</span>  <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>

    <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="p">.</span><span class="n">dtype</span><span class="p">)</span>   <span class="c1"># 裁剪后的图像
</span>
    <span class="n">w_border</span> <span class="o">=</span> <span class="nf">_get_border</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="n">image_width</span><span class="p">)</span>   <span class="c1"># 不懂为何这样算？？？保证裁剪前图像至少宽度是2*w_border（不一定用到这么多像素，只是保证有）
</span>    <span class="n">h_border</span> <span class="o">=</span> <span class="nf">_get_border</span><span class="p">(</span><span class="n">border</span><span class="p">,</span> <span class="n">image_height</span><span class="p">)</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">w_border</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">image_width</span> <span class="o">-</span> <span class="n">w_border</span><span class="p">)</span>   <span class="c1"># 裁剪前图像中心的位置
</span>    <span class="n">cty</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">h_border</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">image_height</span> <span class="o">-</span> <span class="n">h_border</span><span class="p">)</span>

    <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">ctx</span> <span class="o">-</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="nf">min</span><span class="p">(</span><span class="n">ctx</span> <span class="o">+</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">image_width</span><span class="p">)</span>  <span class="c1"># 裁剪前的起点和终点
</span>    <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">cty</span> <span class="o">-</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nf">min</span><span class="p">(</span><span class="n">cty</span> <span class="o">+</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">image_height</span><span class="p">)</span>

    <span class="n">left_w</span><span class="p">,</span> <span class="n">right_w</span> <span class="o">=</span> <span class="n">ctx</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">ctx</span>   <span class="c1"># 裁剪前图像上实际裁剪的图像宽高
</span>    <span class="n">top_h</span><span class="p">,</span> <span class="n">bottom_h</span> <span class="o">=</span> <span class="n">cty</span> <span class="o">-</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">cty</span>

    <span class="c1"># crop image
</span>    <span class="n">cropped_ctx</span><span class="p">,</span> <span class="n">cropped_cty</span> <span class="o">=</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>   <span class="c1"># 裁剪后图像的中心
</span>    <span class="n">x_slice</span> <span class="o">=</span> <span class="nf">slice</span><span class="p">(</span><span class="n">cropped_ctx</span> <span class="o">-</span> <span class="n">left_w</span><span class="p">,</span> <span class="n">cropped_ctx</span> <span class="o">+</span> <span class="n">right_w</span><span class="p">)</span>  <span class="c1"># 返回指定如何对序列进行裁切的对象  slice(start, end, step=1)
</span>    <span class="n">y_slice</span> <span class="o">=</span> <span class="nf">slice</span><span class="p">(</span><span class="n">cropped_cty</span> <span class="o">-</span> <span class="n">top_h</span><span class="p">,</span> <span class="n">cropped_cty</span> <span class="o">+</span> <span class="n">bottom_h</span><span class="p">)</span>
    <span class="n">cropped_image</span><span class="p">[</span><span class="n">y_slice</span><span class="p">,</span> <span class="n">x_slice</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="p">:]</span>   <span class="c1"># 裁剪图像
</span>
    <span class="c1"># crop detections
</span>    <span class="n">cropped_detections</span> <span class="o">=</span> <span class="n">detections</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>   <span class="c1"># 复制gt结果  n*[x1,y1,x2,y2,类别]
</span>    <span class="n">cropped_detections</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">x0</span>   <span class="c1"># 减去原始图像上的偏移
</span>    <span class="n">cropped_detections</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y0</span>
    <span class="n">cropped_detections</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cropped_ctx</span> <span class="o">-</span> <span class="n">left_w</span>  <span class="c1"># 加上在目标图像上的偏移
</span>    <span class="n">cropped_detections</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cropped_cty</span> <span class="o">-</span> <span class="n">top_h</span>

    <span class="k">return</span> <span class="n">cropped_image</span><span class="p">,</span> <span class="n">cropped_detections</span>  <span class="c1"># 返回裁剪后的图像和gt信息（n*[x1,y1,x2,y2,类别]）
</span></pre></table></code></div></div></details><h3 id="p343-draw_gaussian">P3.4.3 draw_gaussian</h3><p>用于在热图相应位置画高斯分布的gt热图。位于core/sample/utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">draw_gaussian</span><span class="p">(</span><span class="n">heatmap</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># 热图上相应通道heatmap相应顶点center画半径为radius的高斯分布的gt热图
</span>    <span class="n">diameter</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># 直径
</span>    <span class="n">gaussian</span> <span class="o">=</span> <span class="nf">gaussian2D</span><span class="p">((</span><span class="n">diameter</span><span class="p">,</span> <span class="n">diameter</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="n">diameter</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>    <span class="c1"># 得到中心在原点，直径为diameter的高斯分布
</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">center</span>

    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">radius</span><span class="p">),</span> <span class="nf">min</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">radius</span><span class="p">),</span> <span class="nf">min</span><span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">masked_heatmap</span>  <span class="o">=</span> <span class="n">heatmap</span><span class="p">[</span><span class="n">y</span> <span class="o">-</span> <span class="n">top</span><span class="p">:</span><span class="n">y</span> <span class="o">+</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">left</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="n">right</span><span class="p">]</span>   <span class="c1"># 取热图相应位置，实际为引用
</span>    <span class="n">masked_gaussian</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">[</span><span class="n">radius</span> <span class="o">-</span> <span class="n">top</span><span class="p">:</span><span class="n">radius</span> <span class="o">+</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">left</span><span class="p">:</span><span class="n">radius</span> <span class="o">+</span> <span class="n">right</span><span class="p">]</span>    <span class="c1"># 取高斯分布相应位置，实际为引用   radius为高斯分布的中心
</span><span class="n">np</span><span class="p">.</span><span class="nf">maximum</span><span class="p">(</span><span class="n">masked_heatmap</span><span class="p">,</span> <span class="n">masked_gaussian</span> <span class="o">*</span> <span class="n">k</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">masked_heatmap</span><span class="p">)</span>   <span class="c1"># 取热图相应位置和高斯分布相应位置的最大值，输出到masked_heatmap，由于上面为引用，因而修改的是heatmap相应位置
</span>
<span class="k">def</span> <span class="nf">gaussian2D</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># 得到中心在原点，直径为shape的高斯分布
</span>    <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ss</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">]</span>   <span class="c1"># 半径
</span>    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">ogrid</span><span class="p">[</span><span class="o">-</span><span class="n">m</span><span class="p">:</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># 坐标
</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">))</span>   <span class="c1"># 高斯分布的矩阵
</span>    <span class="n">h</span><span class="p">[</span><span class="n">h</span> <span class="o">&lt;</span> <span class="n">np</span><span class="p">.</span><span class="nf">finfo</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">dtype</span><span class="p">).</span><span class="n">eps</span> <span class="o">*</span> <span class="n">h</span><span class="p">.</span><span class="nf">max</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># 过小的值设置为0
</span>    <span class="k">return</span> <span class="n">h</span>
</pre></table></code></div></div></details><h3 id="p344-gaussian_radius">P3.4.4 gaussian_radius</h3><p>位于core/sample/utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">gaussian_radius</span><span class="p">(</span><span class="n">det_size</span><span class="p">,</span> <span class="n">min_overlap</span><span class="p">):</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">det_size</span>   <span class="c1"># 特征图上目标的高宽。不知道下面为何这样算？？？
</span>
    <span class="n">a1</span>  <span class="o">=</span> <span class="mi">1</span>
    <span class="n">b1</span>  <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">width</span><span class="p">)</span>
    <span class="n">c1</span>  <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">min_overlap</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">min_overlap</span><span class="p">)</span>
    <span class="n">sq1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">b1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">c1</span><span class="p">)</span>
    <span class="n">r1</span>  <span class="o">=</span> <span class="p">(</span><span class="n">b1</span> <span class="o">-</span> <span class="n">sq1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a1</span><span class="p">)</span>

    <span class="n">a2</span>  <span class="o">=</span> <span class="mi">4</span>
    <span class="n">b2</span>  <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">width</span><span class="p">)</span>
    <span class="n">c2</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">min_overlap</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span>
    <span class="n">sq2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">b2</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">c2</span><span class="p">)</span>
    <span class="n">r2</span>  <span class="o">=</span> <span class="p">(</span><span class="n">b2</span> <span class="o">-</span> <span class="n">sq2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a2</span><span class="p">)</span>

    <span class="n">a3</span>  <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">min_overlap</span>
    <span class="n">b3</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">min_overlap</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">width</span><span class="p">)</span>
    <span class="n">c3</span>  <span class="o">=</span> <span class="p">(</span><span class="n">min_overlap</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span>
    <span class="n">sq3</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">b3</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">c3</span><span class="p">)</span>
    <span class="n">r3</span>  <span class="o">=</span> <span class="p">(</span><span class="n">b3</span> <span class="o">+</span> <span class="n">sq3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a3</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">min</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span><span class="p">)</span>
</pre></table></code></div></div></details><h3 id="p345-gaussian_radius">P3.4.5 gaussian_radius</h3><p>归一化图像。位于core/sample/utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">normalize_</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">):</span>   <span class="c1"># 归一化图像
</span>    <span class="n">image</span> <span class="o">-=</span> <span class="n">mean</span>
    <span class="n">image</span> <span class="o">/=</span> <span class="n">std</span>
</pre></table></code></div></div></details><h3 id="p346-color_jittering_">P3.4.6 color_jittering_</h3><p>对图像亮度、对比度、饱和度进行扰动。位于core/sample/utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">grayscale</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">blend_</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">):</span>
    <span class="n">image1</span> <span class="o">*=</span> <span class="n">alpha</span>
    <span class="n">image2</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>
    <span class="n">image1</span> <span class="o">+=</span> <span class="n">image2</span>

<span class="k">def</span> <span class="nf">saturation_</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">gs_mean</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>   <span class="c1"># 饱和度随机扰动
</span>    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">data_rng</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="n">var</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>
    <span class="nf">blend_</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">gs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">None</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">brightness_</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">gs_mean</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>  <span class="c1"># 亮度随机扰动
</span>    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">data_rng</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="n">var</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">*=</span> <span class="n">alpha</span>

<span class="k">def</span> <span class="nf">contrast_</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">gs_mean</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>  <span class="c1"># 对比度随机扰动
</span>    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">data_rng</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="n">var</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>
    <span class="nf">blend_</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">gs_mean</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">color_jittering_</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>   <span class="c1"># 亮度、对比度、饱和度随机扰动
</span>    <span class="n">functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">brightness_</span><span class="p">,</span> <span class="n">contrast_</span><span class="p">,</span> <span class="n">saturation_</span><span class="p">]</span>
    <span class="n">random</span><span class="p">.</span><span class="nf">shuffle</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="nf">grayscale</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">gs_mean</span> <span class="o">=</span> <span class="n">gs</span><span class="p">.</span><span class="nf">mean</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
        <span class="nf">f</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">gs_mean</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
</pre></table></code></div></div></details><h3 id="p347-lighting_">P3.4.7 lighting_</h3><p>位于core/sample/utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">lighting_</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">alphastd</span><span class="p">,</span> <span class="n">eigval</span><span class="p">,</span> <span class="n">eigvec</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">data_rng</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">alphastd</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">image</span> <span class="o">+=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">eigvec</span><span class="p">,</span> <span class="n">eigval</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span>
</pre></table></code></div></div></details><h2 id="p35-获取coco数据">P3.5 获取COCO数据</h2><p>位于core/dbs/coco.py</p><h3 id="p351-coco">P3.5.1 COCO</h3><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">COCO</span><span class="p">(</span><span class="n">DETECTION</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">db_config</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sys_config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">split</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">sys_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">COCO</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span><span class="n">db_config</span><span class="p">)</span>   <span class="c1"># 调用基类DETECTION的__init__函数，更新其self._configs相关参数
</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_mean</span>    <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mf">0.40789654</span><span class="p">,</span> <span class="mf">0.44719302</span><span class="p">,</span> <span class="mf">0.47026115</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_std</span>     <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mf">0.28863828</span><span class="p">,</span> <span class="mf">0.27408164</span><span class="p">,</span> <span class="mf">0.27809835</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_eig_val</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mf">0.2141788</span><span class="p">,</span> <span class="mf">0.01817699</span><span class="p">,</span> <span class="mf">0.00341571</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_eig_vec</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.58752847</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.69563484</span><span class="p">,</span> <span class="mf">0.41340352</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5832747</span><span class="p">,</span> <span class="mf">0.00994535</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.81221408</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.56089297</span><span class="p">,</span> <span class="mf">0.71832671</span><span class="p">,</span> <span class="mf">0.41158938</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_coco_cls_ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> 
            <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> 
            <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> 
            <span class="mi">37</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> 
            <span class="mi">48</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> 
            <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> 
            <span class="mi">72</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> 
            <span class="mi">82</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">90</span>
        <span class="p">]</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_coco_cls_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sh">'</span><span class="s">person</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">bicycle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">car</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">motorcycle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">airplane</span><span class="sh">'</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">bus</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">truck</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">boat</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">traffic light</span><span class="sh">'</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">fire hydrant</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">stop sign</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">parking meter</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">bench</span><span class="sh">'</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">bird</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">cat</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dog</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">horse</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">sheep</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">cow</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">elephant</span><span class="sh">'</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">bear</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">zebra</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">giraffe</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">backpack</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">umbrella</span><span class="sh">'</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">handbag</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">tie</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">suitcase</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">frisbee</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">skis</span><span class="sh">'</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">snowboard</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">sports ball</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">kite</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">baseball bat</span><span class="sh">'</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">baseball glove</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">skateboard</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">surfboard</span><span class="sh">'</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">tennis racket</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">bottle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wine glass</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">cup</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">fork</span><span class="sh">'</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">knife</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">spoon</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">bowl</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">banana</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">apple</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sandwich</span><span class="sh">'</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">orange</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">broccoli</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">carrot</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">hot dog</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pizza</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">donut</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">cake</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">chair</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">couch</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">potted plant</span><span class="sh">'</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">bed</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dining table</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">toilet</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">tv</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">laptop</span><span class="sh">'</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">mouse</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">remote</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">keyboard</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">cell phone</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">microwave</span><span class="sh">'</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">oven</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">toaster</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sink</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">refrigerator</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">book</span><span class="sh">'</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">clock</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">vase</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">scissors</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">teddy bear</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">hair drier</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">toothbrush</span><span class="sh">'</span><span class="p">]</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_cls2coco</span>  <span class="o">=</span> <span class="p">{</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="n">coco_id</span> <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">coco_id</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_coco_cls_ids</span><span class="p">)}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_coco2cls</span>  <span class="o">=</span> <span class="p">{</span><span class="n">coco_id</span><span class="p">:</span> <span class="n">cls_id</span> <span class="k">for</span> <span class="n">cls_id</span><span class="p">,</span> <span class="n">coco_id</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_cls2coco</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_coco2name</span> <span class="o">=</span> <span class="p">{</span><span class="n">cls_id</span><span class="p">:</span> <span class="n">cls_name</span> <span class="k">for</span> <span class="n">cls_id</span><span class="p">,</span> <span class="n">cls_name</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_coco_cls_ids</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_coco_cls_names</span><span class="p">)}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_name2coco</span> <span class="o">=</span> <span class="p">{</span><span class="n">cls_name</span><span class="p">:</span> <span class="n">cls_id</span> <span class="k">for</span> <span class="n">cls_name</span><span class="p">,</span> <span class="n">cls_id</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_coco2name</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>

        <span class="k">if</span> <span class="n">split</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">coco_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">sys_config</span><span class="p">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">coco</span><span class="sh">"</span><span class="p">)</span>

            <span class="n">self</span><span class="p">.</span><span class="n">_split</span>     <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">trainval</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">trainval2014</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minival</span><span class="sh">"</span><span class="p">:</span>  <span class="sh">"</span><span class="s">minival2014</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">testdev</span><span class="sh">"</span><span class="p">:</span>  <span class="sh">"</span><span class="s">testdev2017</span><span class="sh">"</span><span class="p">}[</span><span class="n">split</span><span class="p">]</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_data_dir</span>  <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">coco_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">images</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_split</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_anno_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">coco_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">annotations</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">instances_{}.json</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_split</span><span class="p">))</span>

            <span class="n">self</span><span class="p">.</span><span class="n">_detections</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_eval_ids</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_load_coco_annos</span><span class="p">()</span>  <span class="c1"># detections:{图像名字:n*[x1,y1,x2,y2,类别]}
</span>            <span class="n">self</span><span class="p">.</span><span class="n">_image_ids</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_detections</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_db_inds</span>   <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_image_ids</span><span class="p">))</span>   <span class="c1"># 图像索引
</span>
    <span class="k">def</span> <span class="nf">_load_coco_annos</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="n">pycocotools.coco</span> <span class="kn">import</span> <span class="n">COCO</span>

        <span class="n">coco</span> <span class="o">=</span> <span class="nc">COCO</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_anno_file</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_coco</span> <span class="o">=</span> <span class="n">coco</span>

        <span class="n">class_ids</span> <span class="o">=</span> <span class="n">coco</span><span class="p">.</span><span class="nf">getCatIds</span><span class="p">()</span>
        <span class="n">image_ids</span> <span class="o">=</span> <span class="n">coco</span><span class="p">.</span><span class="nf">getImgIds</span><span class="p">()</span>
        
        <span class="n">eval_ids</span>   <span class="o">=</span> <span class="p">{}</span>
        <span class="n">detections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">image_id</span> <span class="ow">in</span> <span class="n">image_ids</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">coco</span><span class="p">.</span><span class="nf">loadImgs</span><span class="p">(</span><span class="n">image_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dets</span>  <span class="o">=</span> <span class="p">[]</span>
            
            <span class="n">eval_ids</span><span class="p">[</span><span class="n">image</span><span class="p">[</span><span class="sh">"</span><span class="s">file_name</span><span class="sh">"</span><span class="p">]]</span> <span class="o">=</span> <span class="n">image_id</span>
            <span class="k">for</span> <span class="n">class_id</span> <span class="ow">in</span> <span class="n">class_ids</span><span class="p">:</span>
                <span class="n">annotation_ids</span> <span class="o">=</span> <span class="n">coco</span><span class="p">.</span><span class="nf">getAnnIds</span><span class="p">(</span><span class="n">imgIds</span><span class="o">=</span><span class="n">image</span><span class="p">[</span><span class="sh">"</span><span class="s">id</span><span class="sh">"</span><span class="p">],</span> <span class="n">catIds</span><span class="o">=</span><span class="n">class_id</span><span class="p">)</span>
                <span class="n">annotations</span>    <span class="o">=</span> <span class="n">coco</span><span class="p">.</span><span class="nf">loadAnns</span><span class="p">(</span><span class="n">annotation_ids</span><span class="p">)</span>
                <span class="n">category</span>       <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_coco2cls</span><span class="p">[</span><span class="n">class_id</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
                    <span class="n">det</span>     <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="sh">"</span><span class="s">bbox</span><span class="sh">"</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">category</span><span class="p">]</span>
                    <span class="n">det</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">det</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">det</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">det</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">dets</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>   <span class="c1"># [x1,y1,x2,y2,类别]
</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="sh">"</span><span class="s">file_name</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">dets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">detections</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">detections</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">detections</span><span class="p">,</span> <span class="n">eval_ids</span>  <span class="c1"># detections:{图像名字:n*[x1,y1,x2,y2,类别]}
</span>
    <span class="k">def</span> <span class="nf">image_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_data_dir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">Data directory is not set</span><span class="sh">"</span><span class="p">)</span>

        <span class="n">db_ind</span>    <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_db_inds</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>    <span class="c1"># 得到当前图像索引
</span>        <span class="n">file_name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_image_ids</span><span class="p">[</span><span class="n">db_ind</span><span class="p">]</span>   <span class="c1"># 得到图像名字
</span>        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_data_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">detections</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">):</span>
        <span class="n">db_ind</span>    <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_db_inds</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>     <span class="c1"># 得到当前图像索引
</span>        <span class="n">file_name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_image_ids</span><span class="p">[</span><span class="n">db_ind</span><span class="p">]</span>   <span class="c1"># 得到图像名字
</span>        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_detections</span><span class="p">[</span><span class="n">file_name</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>   <span class="c1"># 得到图像gt信息  detections:{图像名字:n*[x1,y1,x2,y2,类别]}
</span>
    <span class="k">def</span> <span class="nf">cls2name</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="n">coco</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cls2coco</span><span class="p">[</span><span class="n">cls</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_coco2name</span><span class="p">[</span><span class="n">coco</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_to_float</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">float</span><span class="p">(</span><span class="sh">"</span><span class="s">{:.2f}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">convert_to_coco</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">all_bboxes</span><span class="p">):</span>
        <span class="n">detections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">image_id</span> <span class="ow">in</span> <span class="n">all_bboxes</span><span class="p">:</span>
            <span class="n">coco_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_eval_ids</span><span class="p">[</span><span class="n">image_id</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cls_ind</span> <span class="ow">in</span> <span class="n">all_bboxes</span><span class="p">[</span><span class="n">image_id</span><span class="p">]:</span>
                <span class="n">category_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_cls2coco</span><span class="p">[</span><span class="n">cls_ind</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">all_bboxes</span><span class="p">[</span><span class="n">image_id</span><span class="p">][</span><span class="n">cls_ind</span><span class="p">]:</span>
                    <span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-=</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="n">score</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">bbox</span>  <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_to_float</span><span class="p">,</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]))</span>

                    <span class="n">detection</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">image_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">coco_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">category_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">category_id</span><span class="p">,</span> <span class="sh">"</span><span class="s">bbox</span><span class="sh">"</span><span class="p">:</span> <span class="n">bbox</span><span class="p">,</span> <span class="sh">"</span><span class="s">score</span><span class="sh">"</span><span class="p">:</span> <span class="nf">float</span><span class="p">(</span><span class="sh">"</span><span class="s">{:.2f}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">score</span><span class="p">))}</span>

                    <span class="n">detections</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">detection</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">detections</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">result_json</span><span class="p">,</span> <span class="n">cls_ids</span><span class="p">,</span> <span class="n">image_ids</span><span class="p">):</span>
        <span class="kn">from</span> <span class="n">pycocotools.cocoeval</span> <span class="kn">import</span> <span class="n">COCOeval</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_split</span> <span class="o">==</span> <span class="sh">"</span><span class="s">testdev</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">coco</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_coco</span>

        <span class="n">eval_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">_eval_ids</span><span class="p">[</span><span class="n">image_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">image_id</span> <span class="ow">in</span> <span class="n">image_ids</span><span class="p">]</span>
        <span class="n">cat_ids</span>  <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">_cls2coco</span><span class="p">[</span><span class="n">cls_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">cls_id</span> <span class="ow">in</span> <span class="n">cls_ids</span><span class="p">]</span>

        <span class="n">coco_dets</span> <span class="o">=</span> <span class="n">coco</span><span class="p">.</span><span class="nf">loadRes</span><span class="p">(</span><span class="n">result_json</span><span class="p">)</span>
        <span class="n">coco_eval</span> <span class="o">=</span> <span class="nc">COCOeval</span><span class="p">(</span><span class="n">coco</span><span class="p">,</span> <span class="n">coco_dets</span><span class="p">,</span> <span class="sh">"</span><span class="s">bbox</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">coco_eval</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">imgIds</span> <span class="o">=</span> <span class="n">eval_ids</span>
        <span class="n">coco_eval</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">catIds</span> <span class="o">=</span> <span class="n">cat_ids</span>
        <span class="n">coco_eval</span><span class="p">.</span><span class="nf">evaluate</span><span class="p">()</span>
        <span class="n">coco_eval</span><span class="p">.</span><span class="nf">accumulate</span><span class="p">()</span>
        <span class="n">coco_eval</span><span class="p">.</span><span class="nf">summarize</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">coco_eval</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">coco_eval</span><span class="p">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">12</span><span class="p">:]</span>
</pre></table></code></div></div></details><h3 id="p352-detection">P3.5.2 DETECTION</h3><p>COCO继承自DETECTION，其位于core/dbs/detection.py。包括如下参数：</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">DETECTION</span><span class="p">(</span><span class="n">BASE</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">db_config</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">DETECTION</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>

        <span class="c1"># Configs for training
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">categories</span><span class="sh">"</span><span class="p">]</span>      <span class="o">=</span> <span class="mi">80</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_scales</span><span class="sh">"</span><span class="p">]</span>     <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_scale_min</span><span class="sh">"</span><span class="p">]</span>  <span class="o">=</span> <span class="mf">0.8</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_scale_max</span><span class="sh">"</span><span class="p">]</span>  <span class="o">=</span> <span class="mf">1.4</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_scale_step</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.2</span>

        <span class="c1"># Configs for both training and testing
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">input_size</span><span class="sh">"</span><span class="p">]</span>      <span class="o">=</span> <span class="p">[</span><span class="mi">383</span><span class="p">,</span> <span class="mi">383</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">output_sizes</span><span class="sh">"</span><span class="p">]</span>    <span class="o">=</span> <span class="p">[[</span><span class="mi">96</span><span class="p">,</span> <span class="mi">96</span><span class="p">],</span> <span class="p">[</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">],</span> <span class="p">[</span><span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">],</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">]]</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">score_threshold</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">nms_threshold</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="mf">0.7</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">max_per_set</span><span class="sh">"</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">40</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">max_per_image</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">100</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">top_k</span><span class="sh">"</span><span class="p">]</span>           <span class="o">=</span> <span class="mi">20</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">ae_threshold</span><span class="sh">"</span><span class="p">]</span>    <span class="o">=</span> <span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">nms_kernel</span><span class="sh">"</span><span class="p">]</span>      <span class="o">=</span> <span class="mi">3</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">num_dets</span><span class="sh">"</span><span class="p">]</span>        <span class="o">=</span> <span class="mi">1000</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">nms_algorithm</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="sh">"</span><span class="s">exp_soft_nms</span><span class="sh">"</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">weight_exp</span><span class="sh">"</span><span class="p">]</span>      <span class="o">=</span> <span class="mi">8</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">merge_bbox</span><span class="sh">"</span><span class="p">]</span>      <span class="o">=</span> <span class="bp">False</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">data_aug</span><span class="sh">"</span><span class="p">]</span>        <span class="o">=</span> <span class="bp">True</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">lighting</span><span class="sh">"</span><span class="p">]</span>        <span class="o">=</span> <span class="bp">True</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">border</span><span class="sh">"</span><span class="p">]</span>          <span class="o">=</span> <span class="mi">64</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">gaussian_bump</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">gaussian_iou</span><span class="sh">"</span><span class="p">]</span>    <span class="o">=</span> <span class="mf">0.7</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">gaussian_radius</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_crop</span><span class="sh">"</span><span class="p">]</span>       <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_color</span><span class="sh">"</span><span class="p">]</span>      <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_center</span><span class="sh">"</span><span class="p">]</span>     <span class="o">=</span> <span class="bp">True</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">init_sizes</span><span class="sh">"</span><span class="p">]</span>      <span class="o">=</span> <span class="p">[</span><span class="mi">192</span><span class="p">,</span> <span class="mi">255</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">view_sizes</span><span class="sh">"</span><span class="p">]</span>      <span class="o">=</span> <span class="p">[]</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">min_scale</span><span class="sh">"</span><span class="p">]</span>       <span class="o">=</span> <span class="mi">16</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">max_scale</span><span class="sh">"</span><span class="p">]</span>       <span class="o">=</span> <span class="mi">32</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">att_sizes</span><span class="sh">"</span><span class="p">]</span>       <span class="o">=</span> <span class="p">[[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">],</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">]]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">att_ranges</span><span class="sh">"</span><span class="p">]</span>      <span class="o">=</span> <span class="p">[[</span><span class="mi">96</span><span class="p">,</span> <span class="mi">256</span><span class="p">],</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">96</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">]]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">att_ratios</span><span class="sh">"</span><span class="p">]</span>      <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">att_scales</span><span class="sh">"</span><span class="p">]</span>      <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">att_thresholds</span><span class="sh">"</span><span class="p">]</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">att_nms_ks</span><span class="sh">"</span><span class="p">]</span>      <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">att_max_crops</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">8</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">ref_dets</span><span class="sh">"</span><span class="p">]</span>        <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># Configs for testing
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">test_scales</span><span class="sh">"</span><span class="p">]</span>     <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">test_flipped</span><span class="sh">"</span><span class="p">]</span>    <span class="o">=</span> <span class="bp">True</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">update_config</span><span class="p">(</span><span class="n">db_config</span><span class="p">)</span>   <span class="c1"># 根据输入的config，更新self._configs相关参数
</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_scales</span><span class="sh">"</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_scales</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_scale_min</span><span class="sh">"</span><span class="p">],</span> <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_scale_max</span><span class="sh">"</span><span class="p">],</span> <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">rand_scale_step</span><span class="sh">"</span><span class="p">])</span>  <span class="c1"># 随机取一个值
</span></pre></table></code></div></div></details><h3 id="p353-base">P3.5.3 BASE</h3><p>DETECTION继承自BASE，其位于core/dbs/base.py，如下：</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">BASE</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_split</span>     <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_db_inds</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_image_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_mean</span>    <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_std</span>     <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_eig_val</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_eig_vec</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="sh">"</span><span class="s">data_aug</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_data_rng</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">configs</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_configs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_mean</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">std</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_std</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eig_val</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_eig_val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eig_vec</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_eig_vec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db_inds</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_db_inds</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_split</span>

    <span class="k">def</span> <span class="nf">update_config</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_configs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">image_ids</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_image_ids</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">image_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">write_result</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">all_bboxes</span><span class="p">,</span> <span class="n">all_scores</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">shuffle_inds</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>   <span class="c1"># 打乱图像索引顺序，得到新的图像顺序
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_data_rng</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_data_rng</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nc">RandomState</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="nf">getpid</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">shuffling indices...</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">rand_perm</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_data_rng</span><span class="p">.</span><span class="nf">permutation</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_db_inds</span><span class="p">))</span>   <span class="c1"># _db_inds应该是数据库中图像索引：np.arange(len(self._image_ids))，打乱_db_inds顺序，起到随机的作用
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_db_inds</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_db_inds</span><span class="p">[</span><span class="n">rand_perm</span><span class="p">]</span>   <span class="c1"># 得到新的图像索引
</span></pre></table></code></div></div></details><h2 id="p36-evaluate时的cornernet">P3.6 evaluate时的cornernet</h2><p>hg_net在test（包括evaluate）时，调用_test函数，该函数调用_decode，最终返回core\test\cornernet.py中decode函数。</p><h3 id="p361-cornernet">P3.6.1 cornernet</h3><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">rescale_dets_</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">ratios</span><span class="p">,</span> <span class="n">borders</span><span class="p">,</span> <span class="n">sizes</span><span class="p">):</span>  <span class="c1"># 缩放检测结果
</span>    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">detections</span><span class="p">[...,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">detections</span><span class="p">[...,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">xs</span>    <span class="o">/=</span> <span class="n">ratios</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">][:,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
    <span class="n">ys</span>    <span class="o">/=</span> <span class="n">ratios</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][:,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
    <span class="n">xs</span>    <span class="o">-=</span> <span class="n">borders</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">][:,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
    <span class="n">ys</span>    <span class="o">-=</span> <span class="n">borders</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][:,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
    <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sizes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">][:,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">xs</span><span class="p">)</span>
    <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sizes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][:,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">ys</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="n">nnet</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">ae_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_dets</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="c1"># 检测，最终调用core\models\py_utils\modules.py中_test
</span>    <span class="c1"># 得到：检测结果，左上角热图、右下角热图、左上角embedding向量、右下角embedding向量 
</span>    <span class="c1"># 其中，检测结果  [B*num_dets*8]  8为：bbox坐标，目标中心得分，左上角目标分值，右下角目标分值，目标类别
</span>    <span class="n">detections</span> <span class="o">=</span> <span class="n">nnet</span><span class="p">.</span><span class="nf">test</span><span class="p">([</span><span class="n">images</span><span class="p">],</span> <span class="n">ae_threshold</span><span class="o">=</span><span class="n">ae_threshold</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">num_dets</span><span class="o">=</span><span class="n">num_dets</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 得到[B*num_dets*8]的检测结果 8为：bbox坐标，目标中心得分，左上角目标分值，右下角目标分值，目标类别
</span>    <span class="k">return</span> <span class="n">detections</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">cornernet</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">nnet</span><span class="p">,</span> <span class="n">result_dir</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">decode_func</span><span class="o">=</span><span class="n">decode</span><span class="p">):</span>   <span class="c1"># test时会调用本函数
</span>    <span class="n">debug_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">debug</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">debug_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">debug_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">db</span><span class="p">.</span><span class="n">split</span> <span class="o">!=</span> <span class="sh">"</span><span class="s">trainval2014</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">db_inds</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">db_inds</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="n">db</span><span class="p">.</span><span class="n">db_inds</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">db_inds</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">db_inds</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="n">db</span><span class="p">.</span><span class="n">db_inds</span><span class="p">[:</span><span class="mi">5000</span><span class="p">]</span>

    <span class="n">num_images</span> <span class="o">=</span> <span class="n">db_inds</span><span class="p">.</span><span class="n">size</span>   <span class="c1"># 图像数量
</span>    <span class="n">categories</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">categories</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">timer</span> <span class="o">=</span> <span class="nc">Timer</span><span class="p">()</span>
    <span class="n">top_bboxes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nf">tqdm</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_images</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sh">"</span><span class="s">locating kps</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">db_ind</span> <span class="o">=</span> <span class="n">db_inds</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

        <span class="n">image_id</span>   <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="nf">image_ids</span><span class="p">(</span><span class="n">db_ind</span><span class="p">)</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="nf">image_path</span><span class="p">(</span><span class="n">db_ind</span><span class="p">)</span>
        <span class="n">image</span>      <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>   <span class="c1"># 读取图像
</span>
        <span class="n">timer</span><span class="p">.</span><span class="nf">tic</span><span class="p">()</span>
        <span class="n">top_bboxes</span><span class="p">[</span><span class="n">image_id</span><span class="p">]</span> <span class="o">=</span> <span class="nf">cornernet_inference</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">nnet</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>  <span class="c1"># 前向推断函数，得到bbox+得分
</span>        <span class="n">timer</span><span class="p">.</span><span class="nf">toc</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">image_path</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="nf">image_path</span><span class="p">(</span><span class="n">db_ind</span><span class="p">)</span>
            <span class="n">image</span>      <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
            <span class="n">bboxes</span>     <span class="o">=</span> <span class="p">{</span><span class="n">db</span><span class="p">.</span><span class="nf">cls2name</span><span class="p">(</span><span class="n">j</span><span class="p">):</span> <span class="n">top_bboxes</span><span class="p">[</span><span class="n">image_id</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">categories</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span>
            <span class="n">image</span>      <span class="o">=</span> <span class="nf">draw_bboxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">)</span>
            <span class="n">debug_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">debug_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">{}.jpg</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">db_ind</span><span class="p">))</span>
            <span class="n">cv2</span><span class="p">.</span><span class="nf">imwrite</span><span class="p">(</span><span class="n">debug_file</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">average time: {}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">timer</span><span class="p">.</span><span class="n">average_time</span><span class="p">))</span>

    <span class="n">result_json</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">result_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">results.json</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">detections</span>  <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="nf">convert_to_coco</span><span class="p">(</span><span class="n">top_bboxes</span><span class="p">)</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">result_json</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="n">cls_ids</span>   <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">categories</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">image_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">db</span><span class="p">.</span><span class="nf">image_ids</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">db_inds</span><span class="p">]</span>
    <span class="n">db</span><span class="p">.</span><span class="nf">evaluate</span><span class="p">(</span><span class="n">result_json</span><span class="p">,</span> <span class="n">cls_ids</span><span class="p">,</span> <span class="n">image_ids</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">cornernet_inference</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">nnet</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">decode_func</span><span class="o">=</span><span class="n">decode</span><span class="p">):</span>
    <span class="n">K</span>             <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">top_k</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">ae_threshold</span>  <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">ae_threshold</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">nms_kernel</span>    <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">nms_kernel</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">num_dets</span>      <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">num_dets</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">test_flipped</span>  <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">test_flipped</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">input_size</span>    <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">input_size</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">output_size</span>   <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">output_sizes</span><span class="sh">"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">scales</span>        <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">test_scales</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">weight_exp</span>    <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">weight_exp</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">merge_bbox</span>    <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">merge_bbox</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">categories</span>    <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">categories</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">nms_threshold</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">nms_threshold</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">max_per_image</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">max_per_image</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">nms_algorithm</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">nms</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">"</span><span class="s">linear_soft_nms</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">exp_soft_nms</span><span class="sh">"</span><span class="p">:</span> <span class="mi">2</span><span class="p">}[</span><span class="n">db</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="sh">"</span><span class="s">nms_algorithm</span><span class="sh">"</span><span class="p">]]</span>

    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">height_scale</span>  <span class="o">=</span> <span class="p">(</span><span class="n">input_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 特征图相比他图像，宽高缩放倍数
</span>    <span class="n">width_scale</span>   <span class="o">=</span> <span class="p">(</span><span class="n">input_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">im_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nc">FloatTensor</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">mean</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">im_std</span>  <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nc">FloatTensor</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">std</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">detections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">scale</span> <span class="ow">in</span> <span class="n">scales</span><span class="p">:</span>   <span class="c1"># 多尺度检测，增加性能
</span>        <span class="n">new_height</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">new_width</span>  <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">new_center</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">new_height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">new_width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">])</span>

        <span class="n">inp_height</span> <span class="o">=</span> <span class="n">new_height</span> <span class="o">|</span> <span class="mi">127</span>
        <span class="n">inp_width</span>  <span class="o">=</span> <span class="n">new_width</span>  <span class="o">|</span> <span class="mi">127</span>

        <span class="n">images</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">inp_height</span><span class="p">,</span> <span class="n">inp_width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">ratios</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">borders</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">sizes</span>   <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">out_height</span><span class="p">,</span> <span class="n">out_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">inp_height</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">height_scale</span><span class="p">,</span> <span class="p">(</span><span class="n">inp_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">width_scale</span>
        <span class="n">height_ratio</span> <span class="o">=</span> <span class="n">out_height</span> <span class="o">/</span> <span class="n">inp_height</span>
        <span class="n">width_ratio</span>  <span class="o">=</span> <span class="n">out_width</span>  <span class="o">/</span> <span class="n">inp_width</span>

        <span class="n">resized_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">new_width</span><span class="p">,</span> <span class="n">new_height</span><span class="p">))</span>
        <span class="n">resized_image</span><span class="p">,</span> <span class="n">border</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="nf">crop_image</span><span class="p">(</span><span class="n">resized_image</span><span class="p">,</span> <span class="n">new_center</span><span class="p">,</span> <span class="p">[</span><span class="n">inp_height</span><span class="p">,</span> <span class="n">inp_width</span><span class="p">])</span>  <span class="c1"># 裁剪图像
</span>
        <span class="n">resized_image</span> <span class="o">=</span> <span class="n">resized_image</span> <span class="o">/</span> <span class="mf">255.</span>   <span class="c1"># 缩放图像像素到0-1
</span>
        <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">resized_image</span><span class="p">.</span><span class="nf">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>   <span class="c1"># HWC到CHW
</span>        <span class="n">borders</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">border</span>
        <span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">scale</span><span class="p">),</span> <span class="nf">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)]</span>
        <span class="n">ratios</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="p">[</span><span class="n">height_ratio</span><span class="p">,</span> <span class="n">width_ratio</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">test_flipped</span><span class="p">:</span>   <span class="c1"># 水平镜像图像
</span>            <span class="n">images</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">((</span><span class="n">images</span><span class="p">,</span> <span class="n">images</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">images</span>  <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">images</span><span class="p">).</span><span class="nf">cuda</span><span class="p">()</span>
        <span class="n">images</span> <span class="o">-=</span> <span class="n">im_mean</span>   <span class="c1"># 归一化图像
</span>        <span class="n">images</span> <span class="o">/=</span> <span class="n">im_std</span>
        
        <span class="n">dets</span> <span class="o">=</span> <span class="nf">decode_func</span><span class="p">(</span><span class="n">nnet</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">ae_threshold</span><span class="o">=</span><span class="n">ae_threshold</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">nms_kernel</span><span class="p">,</span> <span class="n">num_dets</span><span class="o">=</span><span class="n">num_dets</span><span class="p">)</span>  <span class="c1"># 得到[B*num_dets*8]的检测结果 8为：bbox坐标，目标中心得分，左上角目标分值，右下角目标分值，目标类别
</span>        <span class="k">if</span> <span class="n">test_flipped</span><span class="p">:</span>  <span class="c1"># 水平翻转x坐标
</span>            <span class="n">dets</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">out_width</span> <span class="o">-</span> <span class="n">dets</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
            <span class="n">dets</span> <span class="o">=</span> <span class="n">dets</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

        <span class="nf">rescale_dets_</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">ratios</span><span class="p">,</span> <span class="n">borders</span><span class="p">,</span> <span class="n">sizes</span><span class="p">)</span>    <span class="c1"># 缩放检测结果
</span>        <span class="n">dets</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">/=</span> <span class="n">scale</span>
        <span class="n">detections</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">dets</span><span class="p">)</span>

    <span class="n">detections</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 将多尺度的检测结果拼接  1*(2*K)*8
</span>
    <span class="n">classes</span>    <span class="o">=</span> <span class="n">detections</span><span class="p">[...,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 检测到的目标类别   1*(2*K)
</span>    <span class="n">classes</span>    <span class="o">=</span> <span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>           <span class="c1"># bs=1，因而得到(2*K)的类别
</span>    <span class="n">detections</span> <span class="o">=</span> <span class="n">detections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>        <span class="c1"># bs=1，因而得到(2*K)的类别   (2*K)*8
</span>
    <span class="n">keep_inds</span>  <span class="o">=</span> <span class="p">(</span><span class="n">detections</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 目标中心得分大于阈值的索引   # reject detections with negative scores
</span>    <span class="n">detections</span> <span class="o">=</span> <span class="n">detections</span><span class="p">[</span><span class="n">keep_inds</span><span class="p">]</span>    <span class="c1"># 过滤后的目标  n*8
</span>    <span class="n">classes</span>    <span class="o">=</span> <span class="n">classes</span><span class="p">[</span><span class="n">keep_inds</span><span class="p">]</span>       <span class="c1"># 过滤后的类别  n
</span>
    <span class="n">top_bboxes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">categories</span><span class="p">):</span>
        <span class="n">keep_inds</span> <span class="o">=</span> <span class="p">(</span><span class="n">classes</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span>   <span class="c1"># 第i类别的索引
</span>        <span class="n">top_bboxes</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">detections</span><span class="p">[</span><span class="n">keep_inds</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>   <span class="c1"># 检测结果
</span>        <span class="k">if</span> <span class="n">merge_bbox</span><span class="p">:</span>   <span class="c1"># 默认false，CornerNet-multi_scale.json时为True
</span>            <span class="nf">soft_nms_merge</span><span class="p">(</span><span class="n">top_bboxes</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">Nt</span><span class="o">=</span><span class="n">nms_threshold</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">nms_algorithm</span><span class="p">,</span> <span class="n">weight_exp</span><span class="o">=</span><span class="n">weight_exp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">soft_nms</span><span class="p">(</span><span class="n">top_bboxes</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">Nt</span><span class="o">=</span><span class="n">nms_threshold</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">nms_algorithm</span><span class="p">)</span>
        <span class="n">top_bboxes</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_bboxes</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>   <span class="c1"># 最终检测结果   bbox+得分
</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">hstack</span><span class="p">([</span><span class="n">top_bboxes</span><span class="p">[</span><span class="n">j</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">categories</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_per_image</span><span class="p">:</span>   <span class="c1"># 当前图像上监测的目标个数太多，则按目标得分，去除得分太低的目标
</span>        <span class="n">kth</span>    <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">-</span> <span class="n">max_per_image</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">partition</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">kth</span><span class="p">)[</span><span class="n">kth</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">categories</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">keep_inds</span>     <span class="o">=</span> <span class="p">(</span><span class="n">top_bboxes</span><span class="p">[</span><span class="n">j</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">thresh</span><span class="p">)</span>
            <span class="n">top_bboxes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_bboxes</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">keep_inds</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">top_bboxes</span>
</pre></table></code></div></div></details><h3 id="p362-得到检测结果_decode">P3.6.2 得到检测结果_decode</h3><p>位于core/models/py_utils/utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_decode</span><span class="p">(</span><span class="n">tl_heat</span><span class="p">,</span> <span class="n">br_heat</span><span class="p">,</span> <span class="n">tl_tag</span><span class="p">,</span> <span class="n">br_tag</span><span class="p">,</span> <span class="n">tl_regr</span><span class="p">,</span> <span class="n">br_regr</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ae_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_dets</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">no_border</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">batch</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">tl_heat</span><span class="p">.</span><span class="nf">size</span><span class="p">()</span>

    <span class="n">tl_heat</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">sigmoid</span><span class="p">(</span><span class="n">tl_heat</span><span class="p">)</span>   <span class="c1"># 特征归一化
</span>    <span class="n">br_heat</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">sigmoid</span><span class="p">(</span><span class="n">br_heat</span><span class="p">)</span>

    <span class="n">tl_heat</span> <span class="o">=</span> <span class="nf">_nms</span><span class="p">(</span><span class="n">tl_heat</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">)</span>   <span class="c1"># 得到极大值点（其他位置均为0）  perform nms on heatmaps  kernel=3
</span>    <span class="n">br_heat</span> <span class="o">=</span> <span class="nf">_nms</span><span class="p">(</span><span class="n">br_heat</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">)</span>

    <span class="n">tl_scores</span><span class="p">,</span> <span class="n">tl_inds</span><span class="p">,</span> <span class="n">tl_clses</span><span class="p">,</span> <span class="n">tl_ys</span><span class="p">,</span> <span class="n">tl_xs</span> <span class="o">=</span> <span class="nf">_topk</span><span class="p">(</span><span class="n">tl_heat</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>  <span class="c1"># 前k个分值最大的目标的分值、在宽高上的索引、类别、y坐标、x坐标，均为b*K
</span>    <span class="n">br_scores</span><span class="p">,</span> <span class="n">br_inds</span><span class="p">,</span> <span class="n">br_clses</span><span class="p">,</span> <span class="n">br_ys</span><span class="p">,</span> <span class="n">br_xs</span> <span class="o">=</span> <span class="nf">_topk</span><span class="p">(</span><span class="n">br_heat</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>

    <span class="n">tl_ys</span> <span class="o">=</span> <span class="n">tl_ys</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">expand</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>   <span class="c1"># b*K*K
</span>    <span class="n">tl_xs</span> <span class="o">=</span> <span class="n">tl_xs</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">expand</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="n">br_ys</span> <span class="o">=</span> <span class="n">br_ys</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="p">).</span><span class="nf">expand</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="n">br_xs</span> <span class="o">=</span> <span class="n">br_xs</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="p">).</span><span class="nf">expand</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">no_border</span><span class="p">:</span>  <span class="c1"># no_border=False
</span>        <span class="n">tl_ys_binds</span> <span class="o">=</span> <span class="p">(</span><span class="n">tl_ys</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">tl_xs_binds</span> <span class="o">=</span> <span class="p">(</span><span class="n">tl_xs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">br_ys_binds</span> <span class="o">=</span> <span class="p">(</span><span class="n">br_ys</span> <span class="o">==</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">br_xs_binds</span> <span class="o">=</span> <span class="p">(</span><span class="n">br_xs</span> <span class="o">==</span> <span class="n">width</span>  <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tl_regr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">br_regr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1"># 预测坐标偏移
</span>        <span class="n">tl_regr</span> <span class="o">=</span> <span class="nf">_tranpose_and_gather_feat</span><span class="p">(</span><span class="n">tl_regr</span><span class="p">,</span> <span class="n">tl_inds</span><span class="p">)</span>   <span class="c1"># 得到预测目标的坐标偏移   B*K*2
</span>        <span class="n">tl_regr</span> <span class="o">=</span> <span class="n">tl_regr</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   <span class="c1"># B*K*1*2
</span>        <span class="n">br_regr</span> <span class="o">=</span> <span class="nf">_tranpose_and_gather_feat</span><span class="p">(</span><span class="n">br_regr</span><span class="p">,</span> <span class="n">br_inds</span><span class="p">)</span>
        <span class="n">br_regr</span> <span class="o">=</span> <span class="n">br_regr</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">tl_xs</span> <span class="o">=</span> <span class="n">tl_xs</span> <span class="o">+</span> <span class="n">tl_regr</span><span class="p">[...,</span> <span class="mi">0</span><span class="p">]</span>   <span class="c1"># 预测的坐标  tl_regr[..., 0]取0维度，为B*K*1，和b*K*K的broadast相加，得到b*K*K
</span>        <span class="n">tl_ys</span> <span class="o">=</span> <span class="n">tl_ys</span> <span class="o">+</span> <span class="n">tl_regr</span><span class="p">[...,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">br_xs</span> <span class="o">=</span> <span class="n">br_xs</span> <span class="o">+</span> <span class="n">br_regr</span><span class="p">[...,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">br_ys</span> <span class="o">=</span> <span class="n">br_ys</span> <span class="o">+</span> <span class="n">br_regr</span><span class="p">[...,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">stack</span><span class="p">((</span><span class="n">tl_xs</span><span class="p">,</span> <span class="n">tl_ys</span><span class="p">,</span> <span class="n">br_xs</span><span class="p">,</span> <span class="n">br_ys</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># 预测的bbox b*K*K*4   # all possible boxes based on top k corners (ignoring class)
</span>
    <span class="n">tl_tag</span> <span class="o">=</span> <span class="nf">_tranpose_and_gather_feat</span><span class="p">(</span><span class="n">tl_tag</span><span class="p">,</span> <span class="n">tl_inds</span><span class="p">)</span>   <span class="c1"># 预测的embedding向量  输入tl_tag为B*1*W*H，输出tl_tag为B*K*1
</span>    <span class="n">tl_tag</span> <span class="o">=</span> <span class="n">tl_tag</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># B*K*1
</span>    <span class="n">br_tag</span> <span class="o">=</span> <span class="nf">_tranpose_and_gather_feat</span><span class="p">(</span><span class="n">br_tag</span><span class="p">,</span> <span class="n">br_inds</span><span class="p">)</span>
    <span class="n">br_tag</span> <span class="o">=</span> <span class="n">br_tag</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>   <span class="c1"># B*1*K
</span>    <span class="n">dists</span>  <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">tl_tag</span> <span class="o">-</span> <span class="n">br_tag</span><span class="p">)</span>   <span class="c1"># broadcast减法，得到B*K*K，代表左上和右下两两对比的embedding向量之间的距离
</span>
    <span class="n">tl_scores</span> <span class="o">=</span> <span class="n">tl_scores</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">expand</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>   <span class="c1"># B*K转到B*K*K
</span>    <span class="n">br_scores</span> <span class="o">=</span> <span class="n">br_scores</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="p">).</span><span class="nf">expand</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="n">scores</span>    <span class="o">=</span> <span class="p">(</span><span class="n">tl_scores</span> <span class="o">+</span> <span class="n">br_scores</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>   <span class="c1"># B*K*K，代表左上和右下两两对比中点的得分
</span>
    <span class="n">tl_clses</span> <span class="o">=</span> <span class="n">tl_clses</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">expand</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>  <span class="c1"># B*K转到B*K*1扩充到B*K*K  左上角目标类别
</span>    <span class="n">br_clses</span> <span class="o">=</span> <span class="n">br_clses</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="p">).</span><span class="nf">expand</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>  <span class="c1"># B*K转到B*1*K扩充到B*K*K  右下角目标类别
</span>    <span class="n">cls_inds</span> <span class="o">=</span> <span class="p">(</span><span class="n">tl_clses</span> <span class="o">!=</span> <span class="n">br_clses</span><span class="p">)</span>   <span class="c1"># 代表左上和右下两两对比目标不同的mask，下面用于去除相应的结果    # reject boxes based on classes
</span>
    <span class="n">dist_inds</span> <span class="o">=</span> <span class="p">(</span><span class="n">dists</span> <span class="o">&gt;</span> <span class="n">ae_threshold</span><span class="p">)</span>    <span class="c1"># 左上和右下两两对比的embedding向量之间的距离大于阈值的mask，下面用于去除相应的结果   # reject boxes based on distances
</span>
    <span class="n">width_inds</span>  <span class="o">=</span> <span class="p">(</span><span class="n">br_xs</span> <span class="o">&lt;</span> <span class="n">tl_xs</span><span class="p">)</span>    <span class="c1"># 预测目标右下角小于左上角的mask，下面用于去除相应的结果   # reject boxes based on widths and heights
</span>    <span class="n">height_inds</span> <span class="o">=</span> <span class="p">(</span><span class="n">br_ys</span> <span class="o">&lt;</span> <span class="n">tl_ys</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">no_border</span><span class="p">:</span>
        <span class="n">scores</span><span class="p">[</span><span class="n">tl_ys_binds</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">scores</span><span class="p">[</span><span class="n">tl_xs_binds</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">scores</span><span class="p">[</span><span class="n">br_ys_binds</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">scores</span><span class="p">[</span><span class="n">br_xs_binds</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">scores</span><span class="p">[</span><span class="n">cls_inds</span><span class="p">]</span>    <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>   <span class="c1"># 去除相应的左上和右下两两对比中点的得分
</span>    <span class="n">scores</span><span class="p">[</span><span class="n">dist_inds</span><span class="p">]</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">scores</span><span class="p">[</span><span class="n">width_inds</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">scores</span><span class="p">[</span><span class="n">height_inds</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># B*K*K转到B*(K*K)
</span>    <span class="n">scores</span><span class="p">,</span> <span class="n">inds</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">topk</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">num_dets</span><span class="p">)</span>  <span class="c1"># 最高的num_dets个目标中心得分及相应索引，均为B*num_dets
</span>    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="c1"># B*num_dets*1
</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">bboxes</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># B*K*K*4转到B*(K*K)*4
</span>    <span class="n">bboxes</span> <span class="o">=</span> <span class="nf">_gather_feat</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">inds</span><span class="p">)</span>  <span class="c1"># 取最高的num_dets个目标的bbox  B*num_dets*4
</span>
    <span class="n">clses</span>  <span class="o">=</span> <span class="n">tl_clses</span><span class="p">.</span><span class="nf">contiguous</span><span class="p">().</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># 预测的左上角的类别  B*K*K转到B*(K*K)*1
</span>    <span class="n">clses</span>  <span class="o">=</span> <span class="nf">_gather_feat</span><span class="p">(</span><span class="n">clses</span><span class="p">,</span> <span class="n">inds</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>  <span class="c1"># 取最高的num_dets个类别   B*num_dets*1
</span>
    <span class="n">tl_scores</span> <span class="o">=</span> <span class="n">tl_scores</span><span class="p">.</span><span class="nf">contiguous</span><span class="p">().</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>      <span class="c1"># 预测的左上角的前K个目标的分值  B*K*K转到B*(K*K)*1
</span>    <span class="n">tl_scores</span> <span class="o">=</span> <span class="nf">_gather_feat</span><span class="p">(</span><span class="n">tl_scores</span><span class="p">,</span> <span class="n">inds</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>          <span class="c1"># 取最高的num_dets个目标的分值   B*num_dets*1
</span>    <span class="n">br_scores</span> <span class="o">=</span> <span class="n">br_scores</span><span class="p">.</span><span class="nf">contiguous</span><span class="p">().</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>      <span class="c1"># 预测的右下角的前K个目标的分值  B*K*K转到B*(K*K)*1
</span>    <span class="n">br_scores</span> <span class="o">=</span> <span class="nf">_gather_feat</span><span class="p">(</span><span class="n">br_scores</span><span class="p">,</span> <span class="n">inds</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>          <span class="c1"># 取最高的num_dets个目标的分值   B*num_dets*1
</span>
    <span class="n">detections</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">([</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">tl_scores</span><span class="p">,</span> <span class="n">br_scores</span><span class="p">,</span> <span class="n">clses</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>   <span class="c1"># 得到检测结果  B*num_dets*8  8为：bbox坐标，目标中心得分，左上角目标分值，右下角目标分值，目标类别
</span>    <span class="k">return</span> <span class="n">detections</span>
</pre></table></code></div></div></details><h3 id="p363-得到极大值点的_nms">P3.6.3 得到极大值点的_nms</h3><p>_nms通过max pool得到极大值点，并未进行非极大值抑制。位于core/models/py_utils/utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_nms</span><span class="p">(</span><span class="n">heat</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># 实际kernel=3
</span>    <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="n">hmax</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="nf">max_pool2d</span><span class="p">(</span><span class="n">heat</span><span class="p">,</span> <span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">kernel</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">pad</span><span class="p">)</span>  <span class="c1"># maxpool，得到每个位置3*3内的最大值，当做极大值点
</span>    <span class="n">keep</span> <span class="o">=</span> <span class="p">(</span><span class="n">hmax</span> <span class="o">==</span> <span class="n">heat</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>   <span class="c1"># 得到极值点mask
</span>    <span class="k">return</span> <span class="n">heat</span> <span class="o">*</span> <span class="n">keep</span>  <span class="c1"># 返回极大值点
</span></pre></table></code></div></div></details><h3 id="p364-得到前k个得分最高的极值点信息_topk">P3.6.4 得到前K个得分最高的极值点信息_topk</h3><p>_topk用于得到前k个分值最大的目标的分值、在宽高上的索引、类别、y坐标、x坐标。位于core/models/py_utils/utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_topk</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>  <span class="c1"># scores BCHW
</span>    <span class="n">batch</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">scores</span><span class="p">.</span><span class="nf">size</span><span class="p">()</span> 

    <span class="n">topk_scores</span><span class="p">,</span> <span class="n">topk_inds</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">topk</span><span class="p">(</span><span class="n">scores</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">K</span><span class="p">)</span>    <span class="c1"># 用于得到极值点（即目标）的得分及类别索引  b*K
</span>
    <span class="n">topk_clses</span> <span class="o">=</span> <span class="p">(</span><span class="n">topk_inds</span> <span class="o">/</span> <span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">width</span><span class="p">)).</span><span class="nf">int</span><span class="p">()</span>   <span class="c1">#  极值点（即目标）的类别  b*K
</span>
    <span class="n">topk_inds</span> <span class="o">=</span> <span class="n">topk_inds</span> <span class="o">%</span> <span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>   <span class="c1"># 目标在宽高上的索引  b*K
</span>    <span class="n">topk_ys</span>   <span class="o">=</span> <span class="p">(</span><span class="n">topk_inds</span> <span class="o">/</span> <span class="n">width</span><span class="p">).</span><span class="nf">int</span><span class="p">().</span><span class="nf">float</span><span class="p">()</span>   <span class="c1"># 前K个目标的y坐标  b*K
</span>    <span class="n">topk_xs</span>   <span class="o">=</span> <span class="p">(</span><span class="n">topk_inds</span> <span class="o">%</span> <span class="n">width</span><span class="p">).</span><span class="nf">int</span><span class="p">().</span><span class="nf">float</span><span class="p">()</span>   <span class="c1"># 前K个目标的x坐标  b*K
</span>    <span class="k">return</span> <span class="n">topk_scores</span><span class="p">,</span> <span class="n">topk_inds</span><span class="p">,</span> <span class="n">topk_clses</span><span class="p">,</span> <span class="n">topk_ys</span><span class="p">,</span> <span class="n">topk_xs</span>  <span class="c1"># 前k个分值最大的目标的分值、在宽高上的索引、类别、y坐标、x坐标
</span></pre></table></code></div></div></details><h3 id="p365-crop_image">P3.6.5 crop_image</h3><p>位于core\sample\utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">crop_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">output_size</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">output_size</span> <span class="o">=</span> <span class="n">size</span>

    <span class="n">cty</span><span class="p">,</span> <span class="n">ctx</span>            <span class="o">=</span> <span class="n">center</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span>       <span class="o">=</span> <span class="n">size</span>
    <span class="n">o_height</span><span class="p">,</span> <span class="n">o_width</span>   <span class="o">=</span> <span class="n">output_size</span>
    <span class="n">im_height</span><span class="p">,</span> <span class="n">im_width</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">cropped_image</span>       <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">o_height</span><span class="p">,</span> <span class="n">o_width</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="p">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ctx</span> <span class="o">-</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="nf">min</span><span class="p">(</span><span class="n">ctx</span> <span class="o">+</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">im_width</span><span class="p">)</span>
    <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cty</span> <span class="o">-</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="nf">min</span><span class="p">(</span><span class="n">cty</span> <span class="o">+</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">im_height</span><span class="p">)</span>

    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">ctx</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">ctx</span>
    <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">cty</span> <span class="o">-</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">cty</span>

    <span class="n">cropped_cty</span><span class="p">,</span> <span class="n">cropped_ctx</span> <span class="o">=</span> <span class="n">o_height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">o_width</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">y_slice</span> <span class="o">=</span> <span class="nf">slice</span><span class="p">(</span><span class="n">cropped_cty</span> <span class="o">-</span> <span class="n">top</span><span class="p">,</span> <span class="n">cropped_cty</span> <span class="o">+</span> <span class="n">bottom</span><span class="p">)</span>
    <span class="n">x_slice</span> <span class="o">=</span> <span class="nf">slice</span><span class="p">(</span><span class="n">cropped_ctx</span> <span class="o">-</span> <span class="n">left</span><span class="p">,</span> <span class="n">cropped_ctx</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span>
    <span class="n">cropped_image</span><span class="p">[</span><span class="n">y_slice</span><span class="p">,</span> <span class="n">x_slice</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="n">border</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span>
       <span class="n">cropped_cty</span> <span class="o">-</span> <span class="n">top</span><span class="p">,</span>
       <span class="n">cropped_cty</span> <span class="o">+</span> <span class="n">bottom</span><span class="p">,</span>
       <span class="n">cropped_ctx</span> <span class="o">-</span> <span class="n">left</span><span class="p">,</span>
       <span class="n">cropped_ctx</span> <span class="o">+</span> <span class="n">right</span>
    <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span>
        <span class="n">cty</span> <span class="o">-</span> <span class="n">o_height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">ctx</span> <span class="o">-</span> <span class="n">o_width</span>  <span class="o">//</span> <span class="mi">2</span>
    <span class="p">])</span>

    <span class="k">return</span> <span class="n">cropped_image</span><span class="p">,</span> <span class="n">border</span><span class="p">,</span> <span class="n">offset</span>
</pre></table></code></div></div></details></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div class="post-tags"> <span>标签(Tags)</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a href="/tags/deep-learning/" class="post-tag no-text-decoration" >deep learning</a> <a href="/tags/algorithm/" class="post-tag no-text-decoration" >algorithm</a> <a href="/tags/detection/" class="post-tag no-text-decoration" >detection</a></div></div><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/UbuntuAgent/">Ubuntu使用代理</a><li><a href="/posts/SunloginDisconnectWin10/">windows10使用向日葵访问ubuntu 20.04显示连接已断开</a><li><a href="/posts/TimeWin10Ubuntu/">windows10和ubuntu双系统的时间差</a><li><a href="/posts/markdown/">markdown基本语法</a><li><a href="/posts/MountDriverInWin10Ubuntu/">windows10的ubuntu子系统挂载移动硬盘</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/deep-learning/">deep learning</a> <a class="post-tag" href="/tags/detection/">detection</a> <a class="post-tag" href="/tags/normalization/">normalization</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/transformers/">transformers</a> <a class="post-tag" href="/tags/demo/">demo</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h6 align="left"><br>未设置提醒，因而不一定能看到回复，见谅</h6><div class="post-navigation d-flex justify-content-between"> <a href="/posts/SSD/" class="btn btn-outline-primary" prompt="Older"><p>SSD Single Shot MultiBox Detector</p></a> <a href="/posts/MTCNN/" class="btn btn-outline-primary" prompt="Newer"><p>MTCNN Joint Face Detection and Alignment using Multi-task Cascaded Convolutional Networks</p></a></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script> <script src="https://code.jquery.com/jquery-3.2.0.min.js"></script> <script>AV.initialize("7DUQTBuCCKLjnutJOa6ko5cn-MdYXbMMI", "lxmthTQ8ESa2HrVQiIVyXtYo");</script> <script> //新增访问次数 function addCount(Counter) { // 页面（博客文章）中的信息：leancloud_visitors // id为page.url， data-flag-title为page.title var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(Counter); // 只根据文章的url查询LeanCloud服务器中的数据 query.equalTo("post_url", url); query.find({ success: function(results) { if (results.length > 0) {//说明LeanCloud中已经记录了这篇文章 var counter = results[0]; counter.fetchWhenSave(true); counter.increment("visited_times");// 将点击次数加1 counter.save(null, { success: function(counter) { var $element = $(document.getElementById(url)); var newTimes = counter.get('visited_times'); $element.find('.leancloud-visitors-count').text(newTimes); }, error: function(counter, error) { console.log('Failed to save Visitor num, with error message: ' + error.message); } }); } else { // 执行这里，说明LeanCloud中还没有记录此文章 var newcounter = new Counter(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); newcounter.setACL(acl); /* End Set ACL */ newcounter.set("post_title", title);// 把文章标题 newcounter.set("post_url", url); // 文章url newcounter.set("visited_times", 1); // 初始点击次数：1次 newcounter.save(null, { // 上传到LeanCloud服务器中 success: function(newcounter) { var $element = $(document.getElementById(url)); var newTimes = newcounter.get('visited_times'); $element.find('.leancloud-visitors-count').text(newTimes); }, error: function(newcounter, error) { console.log('Failed to create'); } }); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); } }); } //仅根据url和title查出当前访问次数，不做+1操作 function showCount(Counter) { var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(Counter); // 只根据文章的url查询LeanCloud服务器中的数据 query.equalTo("post_url", url); query.find({ success: function(results) { if (results.length > 0) {//说明LeanCloud中已经记录了这篇文章 var counter = results[0]; var $element = $(document.getElementById(url)); var newTimes = counter.get('visited_times'); $element.find('.leancloud-visitors-count').text(newTimes); } else { //如果表里没查到记录，那就是异常情况了 console.log('异常情况，不应该没记录的'); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); } }); } //调用API获取IP function getVisitorIpAndJudge() { var ip; var options = { type: 'POST', dataType: "json", //async: false, //jquery3中可以直接使用回调函数，不用再指定async url: "https://freegeoip.net/json/?callback=?" }; $.ajax(options) .done(function(data, textStatus, jqXHR) { if(textStatus == "success") { ip = data.ip; } judgeVisitor(ip) }); } //判断访客是否已访问过该文章，及访问时间，符合条件则增加一次访问次数 function judgeVisitor(ip) { var Counter = AV.Object.extend("visited_times"); var Visitor = AV.Object.extend("visitors_record"); var $postInfo = $(".leancloud_visitors"); var post_url = $postInfo.attr('id').trim(); var query = new AV.Query(Visitor); query.equalTo("visitor_ip", ip); query.equalTo("post_url", post_url); query.find({ success: function(results) { if (results.length > 0) { console.log('该IP已访问过该文章'); var oldVisitor = results[0]; var lastTime = oldVisitor.updatedAt; var curTime = new Date(); var timePassed = curTime.getTime() - lastTime.getTime(); if(timePassed > 1 * 60 * 1000) { console.log('距离该IP上一次访问该文章已超过了1分钟，更新访问记录，并增加访问次数'); addCount(Counter); oldVisitor.fetchWhenSave(true); oldVisitor.save(null, { success: function(oldVisitor) { }, error: function(oldVisitor, error) { console.log('Failed to save visitor record, with error message: ' + error.message); } }); } else { console.log('这是该IP 1分钟内重复访问该文章，不更新访问记录，不增加访问次数'); showCount(Counter); } } else { console.log('该IP第一次访问该文章，保存新的访问记录，并增加访问次数'); addCount(Counter); var newVisitor = new Visitor(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); newVisitor.setACL(acl); newVisitor.set("visitor_ip", ip); newVisitor.set("post_url", post_url); newVisitor.save(null, { // 上传到LeanCloud服务器中 success: function(newVisitor) { }, error: function(newVisitor, error) { console.log('Failed to create visitor record, with error message: ' + error.message); } }); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); addCount(Counter); } }); } $(function() { if ($('.leancloud_visitors').length == 1) { // 文章页面，调用判断方法，对符合条件的访问增加访问次数 getVisitorIpAndJudge(); } else if ($('.post-link').length > 1){ // 首页 暂未使用 // showHitCount(Counter); } }); </script><div> <span id="/posts/CornerNet/" class="leancloud_visitors" data-flag-title="CornerNet: Detecting Objects as Paired Keypoints"> <a href="#">Pageviews:<span class="leancloud-visitors-count"></span> times</a></span></div><h4 align="left">用户留言：</h4><div id="comments"></div><script src='//unpkg.com/valine/dist/Valine.min.js'></script> <script> new Valine({ av: AV, el: '#comments', app_id: '7DUQTBuCCKLjnutJOa6ko5cn-MdYXbMMI', app_key: 'lxmthTQ8ESa2HrVQiIVyXtYo', placeholder: '', avatar: 'mp', notify: 'true', verify: 'true', recordIP: 'true', enableQQ: 'true', visitor: true }); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#main > div.row:first-child > div:first-child img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="">darkknightzh</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/deep-learning/">deep learning</a> <a class="post-tag" href="/tags/detection/">detection</a> <a class="post-tag" href="/tags/normalization/">normalization</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/transformers/">transformers</a> <a class="post-tag" href="/tags/demo/">demo</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://darkknightzh.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
