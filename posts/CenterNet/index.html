<!DOCTYPE html><html lang="en-US" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="CenterNet Objects as Points" /><meta name="author" content="darkknightzh" /><meta property="og:locale" content="en_US" /><meta name="description" content="仅供学习交流使用，错误之处在所难免，欢迎指正." /><meta property="og:description" content="仅供学习交流使用，错误之处在所难免，欢迎指正." /><link rel="canonical" href="https://darkknightzh.github.io/posts/CenterNet/" /><meta property="og:url" content="https://darkknightzh.github.io/posts/CenterNet/" /><meta property="og:site_name" content="darkknightzh" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-23T16:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CenterNet Objects as Points" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"darkknightzh"},"dateModified":"2021-09-27T16:17:59+08:00","datePublished":"2021-08-23T16:00:00+08:00","description":"仅供学习交流使用，错误之处在所难免，欢迎指正.","headline":"CenterNet Objects as Points","mainEntityOfPage":{"@type":"WebPage","@id":"https://darkknightzh.github.io/posts/CenterNet/"},"url":"https://darkknightzh.github.io/posts/CenterNet/"}</script><title>CenterNet Objects as Points | darkknightzh</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] }, // chtml: { displayAlign: 'left' } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">darkknightzh</a></div><div class="site-subtitle font-italic">忘记一个人，从忘记那个声音开始</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>主页</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>时间轴</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/darkknightzh" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>CenterNet Objects as Points</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>CenterNet Objects as Points</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> darkknightzh </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Aug 23, 2021, 4:00 PM +0800" prep="on" > Aug 23, 2021 <i class="unloaded">2021-08-23T16:00:00+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Sep 27, 2021, 4:17 PM +0800" prefix="Updated " > Sep 27, 2021 <i class="unloaded">2021-09-27T16:17:59+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="15381 words">85 min</span></div></div><div class="post-content"><style> h1 { border-bottom: none }</style><p>转载请注明出处：</p><p><a href="https://darkknightzh.github.io/posts/CenterNet">https://darkknightzh.github.io/posts/CenterNet</a></p><p>论文：</p><p><a href="https://arxiv.org/abs/1904.07850">https://arxiv.org/abs/1904.07850</a></p><p>官方代码：</p><p><a href="https://github.com/xingyizhou/CenterNet">https://github.com/xingyizhou/CenterNet</a></p><h2 id="p1-摘要">P1. 摘要</h2><p>CenterNet为anchor-free的方法。如图1所示，本文将目标建模为其边界框的中心点。边界框的大小和其他属性可以通过目标中心关键点的特征推断。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-23-CenterNet/1centernet.png" alt="1" /> <em>图1 centernet</em></p><p>本文算法可以认为是一个单形不可知的anchor（single shape-agnostic anchor），如图2所示。优点：① CenterNet基于位置，而不是框的重叠。本文对于前景和背景分类，无需手动设定阈值。② 对于每个目标，本文只有一个正的“anchor”，因而不需要NMS。在特征图上直接提取局部峰值。③ CenterNet使用更大的输出分辨率（stride=4）。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-23-CenterNet/2centerpixel.png" alt="2" /> <em>图2</em></p><h2 id="p2-预备知识">P2. 预备知识</h2><p>假定 \(I\in { {R}^{W\times H\times 3}}\) 为W*H的彩色图像。本文目标是得到关键点热图 \(\hat{Y}\in { {\left[ 0,1 \right]}^{\frac{W}{R}\times \frac{H}{R}\times C}}\) ，其中R为输入相比于输出的步长（stride）。如果是人体姿态估计，则C=17；如果是目标检测，则C=80（COCO数据库）。本文使用默认步长R=4，即输出分辨率为输入分辨率的1/4。预测的 \({ {\hat{Y}}_{x,y,c}}=1\) 为检测的关键点， \({ {\hat{Y}}_{x,y,c}}=0\) 为背景。本文使用不同的网络来预测图像对应的 \({ {\hat{Y}}_{x,y,c}}\) ：堆叠hourglass网络（stacked hourglass network），ResNet，deep layer aggregation (DLA)。 对于每个类别为c的GT关键点 \(p\in { {R}^{2}}\) ，计算低分辨率的特征 \(\tilde{p}\in \left\lfloor \frac{p}{R} \right\rfloor\) 。</p><p>而后将GT关键点使用高斯核映 \({ {Y}_{xyc}}\in \exp \left( -\frac{ { {\left( x-{ { {\tilde{p}}}_{x}} \right)}^{2}}+{ {\left( y-{ { {\tilde{p}}}_{y}} \right)}^{2}}}{2\sigma _{p}^{2}} \right)\) 射到热图 \(Y\in { {\left[ 0,1 \right]}^{\frac{W}{R}\times \frac{H}{R}\times C}}\) 上，其中 \({ {\sigma }_{p}}\) 为目标尺寸自适应的标准差。若相同类别的的两个高斯核重叠，则使用两个高斯核中的更大值。训练时的损失函数为使用focal loss的逻辑回归：</p>\[{ {L}_{k}}=\frac{-1}{N}\sum\limits_{xyc}{\left\{ \begin{matrix} { {\left( 1-{ { {\hat{Y}}}_{xyc}} \right)}^{\alpha }}\log \left( { { {\hat{Y}}}_{xyc}} \right) &amp; if\text{ }{ {Y}_{xyc}}=1 \\ { {\left( 1-{ {Y}_{xyc}} \right)}^{\beta }}\log { {\left( { { {\hat{Y}}}_{xyc}} \right)}^{\alpha }}\log \left( 1-{ { {\hat{Y}}}_{xyc}} \right) &amp; otherwise \\ \end{matrix} \right.} \tag{1}\]<p>其中 \(\alpha\) 和 \(\beta\) 为focal loss中的超参。N为图像I中的关键点数量。除以N是为了使所有正focal loss的实例归一化到1。本文使用 \(\alpha =2\) ， \(\beta \text{=}4\)。</p><p><strong>说明</strong>：公式1中，第一行， \({ {Y}_{xyc}}\) 为1时：当预测值 \({ {\hat{Y}}_{xyc}}\) 接近1，第一项给予小的惩罚；否则给予大的惩罚。第二行， \({ {Y}_{xyc}}\) 不为1时：①若 \({ {Y}_{xyc}}\) 在中心点周围，理论上 \({ {\hat{Y}}_{xyc}}\) 为0，实际上 \({ {\hat{Y}}_{xyc}}\) 接近1时，第二项给予大的惩罚，由于距离中心点较近， \({ {\hat{Y}}_{xyc}}\) 接近1有可能，因而使用第一项降低一下惩罚；②若 \({ {Y}_{xyc}}\) 远离中心点，理论上 \({ {\hat{Y}}_{xyc}}\) 为0，实际上 \({ {\hat{Y}}_{xyc}}\) 接近1时，第二项给予大的惩罚，第一项保证距离中心越远的点的损失的权重越大，保证负样本检测。</p><p>由于对输出取整使用离散化，会带来预测误差，论文预测每个中心点的局部偏移，使用L1损失，偏移和类别无关，即只预测中心点的偏移，而不管是哪个类别的中心点，这样可以降低输出通道个数。L1损失如下：</p>\[{ {L}_{off}}=\frac{1}{N}\sum\limits_{p}{\left| { { {\hat{O}}}_{ {\tilde{p}}}}-\left( \frac{p}{R}-\tilde{p} \right) \right|} \tag{2}\]<p>其中 \({ {\hat{O}}_{ {\tilde{p}}}}\) 为中心点预测坐标偏移， \(\left( \frac{p}{R}-\tilde{p} \right)\) 为中心点实际坐标偏移。该L1损失只考虑关键点位置 \(\tilde{p}\) ，而不考虑其他位置。</p><p><strong>说明</strong>：</p><p>① 不考虑具体类别时，偏移只考虑目标的x和y坐标，参数量：2*目标个数；</p><p>② 考虑具体类别时，偏移需要考虑每个类别的目标的x和y坐标，参数量：2*目标个数*分类类别。</p><h2 id="p3-objects-as-points">P3. Objects as Points</h2><p>假定 \(\left( x_{1}^{\left( k \right)},y_{1}^{\left( k \right)},x_{2}^{\left( k \right)},y_{2}^{\left( k \right)} \right)\) 为类别为 \({ {c}_{k}}\) 的目标k的边界框。其中心为 \(\left( \frac{x_{1}^{\left( k \right)}+x_{2}^{\left( k \right)}}{2},\frac{y_{1}^{\left( k \right)}+y_{2}^{\left( k \right)}}{2} \right)\) ，本文使用关键点预测器 \(\hat{Y}\) 来预测所有的中心点。另外，对每个目标k，还拟合目标大小 \({ {s}_{k}}=\left( x_{2}^{\left( k \right)}-x_{1}^{\left( k \right)},y_{2}^{\left( k \right)}-y_{1}^{\left( k \right)} \right)\) 。为了降低计算负担，对所有目标类别使用单独的预测器 \(\hat{S}\in { {R}^{\frac{W}{R}\times \frac{H}{R}\times 2}}\) 来预测目标宽高：</p>\[{ {L}_{size}}=\frac{1}{N}\sum\limits_{k=1}^{N}{\left| { { {\hat{S}}}_{pk}}-{ {s}_{k}} \right|} \tag{3}\]<p>本文不缩放宽高，而是直接预测宽高的值。并且给预测宽高的损失较小的权重 \({ {\lambda }_{size}}\) 。总体的损失函数为：</p>\[{ {L}_{\det }}\text{=}{ {L}_{k}}+{ {\lambda }_{size}}{ {L}_{size}}+{ {\lambda }_{off}}{ {L}_{off}} \tag{4}\]<p>其中 \({ {\lambda }_{size}}\text{=}0.1\) ， \({ {\lambda }_{off}}\text{=}0.01\) 。本文使用一个网络来预测关键点 \(\hat{Y}\) （目标中心），目标中心偏移 \(\hat{O}\) 和目标宽高 \(\hat{S}\) 。因而每个位置网络有C+4个输出。所有输出共享相同的骨干网络。骨干网络会通过独立的子网络得到每个预测信息，子网络为：3*3 卷积+ReLU+1*1 卷积。图3显示了网络输出。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-23-CenterNet/3output.png" alt="3" /> <em>图3 output</em></p><p><strong>从点到边界框</strong>：推断阶段，首先提取每个类别的峰值（该点值大于等于其周围8个点的值作为峰值），并保留100个分值最高的峰值。令 \({ {\hat{P}}_{c}}\) 为n个检测到的类别为c的中心点集合： \(\hat{P}=\left\{ \left( { { {\hat{x}}}_{i}},{ { {\hat{y}}}_{i}} \right) \right\}_{i=1}^{n}\) 。每个关键点位置为 \(\left( { {x}_{i}},{ {y}_{i}} \right)\) 。本文使用关键点的值 \({ {\hat{Y}}_{xiyic}}\) 作为其检测的置信度，从而得到检测框</p><p>\(\left( { { {\hat{x}}}_{i}}+\delta { { {\hat{x}}}_{i}}-{ { { {\hat{w}}}_{i}}}/{2}\;,\text{ }{ { {\hat{y}}}_{i}}+\delta { { {\hat{y}}}_{i}}-{ { { {\hat{h}}}_{i}}}/{2}\;,\text{ }{ { {\hat{x}}}_{i}}+\delta { { {\hat{x}}}_{i}}+{ { { {\hat{w}}}_{i}}}/{2,\text{ }{ { {\hat{y}}}_{i}}+\delta { { {\hat{y}}}_{i}}+{ { { {\hat{h}}}_{i}}}/{2}\;}\; \right)\)  </p><p>其中 \(\left( \delta { { {\hat{x}}}_{i}},\delta { { {\hat{y}}}_{i}} \right)={ {\hat{O}}_{ { { {\hat{x}}}_{i}},{ { {\hat{y}}}_{i}}}}\) 为预测的偏移， \(\left( { { {\hat{w}}}_{i}},{ { {\hat{h}}}_{i}} \right)={ {\hat{S}}_{ { { {\hat{x}}}_{i}},{ { {\hat{y}}}_{i}}}}\) 为预测的宽高。所有的输出直接通过关键点估计，不需要NMS。关键点峰值提取可以代替NMS，并且可以使用3*3 max pooling高效得到关键点峰值。</p><p>说明：可以将CenterNet应用于3D检测和人体姿态估计。具体请看论文。</p><p><strong>网络结构</strong>：如图4所示</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/post/2021-08-23-CenterNet/4model.png" alt="4" /> <em>图4 model diagrams</em></p><h2 id="p4代码">P4.代码</h2><h3 id="p41-训练">P4.1 训练</h3><p>训练代码位于main.py中</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
    <span class="n">torch</span><span class="p">.</span><span class="nf">manual_seed</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">cudnn</span><span class="p">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">.</span><span class="n">not_cuda_benchmark</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">.</span><span class="n">test</span>
    <span class="n">Dataset</span> <span class="o">=</span> <span class="nf">get_dataset</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>   <span class="c1"># 得到自定义的dataset
</span>    <span class="n">opt</span> <span class="o">=</span> <span class="nf">opts</span><span class="p">().</span><span class="nf">update_dataset_info_and_set_heads</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">)</span>   <span class="c1"># 使用opt参数更新Dataset的相关参数
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="nc">Logger</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">CUDA_VISIBLE_DEVICES</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">gpus_str</span>
    <span class="n">opt</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">device</span><span class="p">(</span><span class="sh">'</span><span class="s">cuda</span><span class="sh">'</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="sh">'</span><span class="s">cpu</span><span class="sh">'</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Creating model...</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nf">create_model</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">arch</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">heads</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">head_conv</span><span class="p">)</span>   <span class="c1"># arch为dla_34等，heads为相关参数，head_conv为通道数量，最终得到相关模型
</span>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">parameters</span><span class="p">(),</span> <span class="n">opt</span><span class="p">.</span><span class="n">lr</span><span class="p">)</span>
    <span class="n">start_epoch</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">load_model</span> <span class="o">!=</span> <span class="sh">''</span><span class="p">:</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">start_epoch</span> <span class="o">=</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">load_model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">resume</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">lr_step</span><span class="p">)</span>  <span class="c1"># 载入之前模型
</span>
    <span class="n">Trainer</span> <span class="o">=</span> <span class="n">train_factory</span><span class="p">[</span><span class="n">opt</span><span class="p">.</span><span class="n">task</span><span class="p">]</span>  
    <span class="n">trainer</span> <span class="o">=</span> <span class="nc">Trainer</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>  <span class="c1"># 得到训练迭代器，还是叫什么名字？？？
</span>    <span class="n">trainer</span><span class="p">.</span><span class="nf">set_device</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">gpus</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">chunk_sizes</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># Trainer继承自BaseTrainer，里面有set_device
</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Setting up data...</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">val_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nc">DataLoader</span><span class="p">(</span><span class="nc">Dataset</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="sh">'</span><span class="s">val</span><span class="sh">'</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">test</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">trainer</span><span class="p">.</span><span class="nf">val</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">)</span>   <span class="c1"># Trainer继承自BaseTrainer，里面有val
</span>        <span class="n">val_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">.</span><span class="nf">run_eval</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">save_dir</span><span class="p">)</span>   <span class="c1"># 测试结果
</span>        <span class="k">return</span>
    
    <span class="c1"># 得到loader，比如CTDetDataset，里面有__getitem__，可以取数据
</span>    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nc">DataLoader</span><span class="p">(</span><span class="nc">Dataset</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">opt</span><span class="p">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">opt</span><span class="p">.</span><span class="n">num_workers</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Starting training...</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">best</span> <span class="o">=</span> <span class="mf">1e10</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">start_epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">mark</span> <span class="o">=</span> <span class="n">epoch</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">save_all</span> <span class="k">else</span> <span class="sh">'</span><span class="s">last</span><span class="sh">'</span>
        <span class="n">log_dict_train</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">trainer</span><span class="p">.</span><span class="nf">train</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">)</span>   <span class="c1"># Trainer继承自BaseTrainer，里面有train，训练一个epoch
</span>        <span class="n">logger</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">'</span><span class="s">epoch: {} |</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">log_dict_train</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">scalar_summary</span><span class="p">(</span><span class="sh">'</span><span class="s">train_{}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">'</span><span class="s">{} {:8f} | </span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">val_intervals</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">opt</span><span class="p">.</span><span class="n">val_intervals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nf">save_model</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">model_{}.pth</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">mark</span><span class="p">)),</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>  <span class="c1"># 保存模型
</span>            <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
                <span class="n">log_dict_val</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">trainer</span><span class="p">.</span><span class="nf">val</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">)</span>  <span class="c1"># 测试训练一个epoch后的结果
</span>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">log_dict_val</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">scalar_summary</span><span class="p">(</span><span class="sh">'</span><span class="s">val_{}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">'</span><span class="s">{} {:8f} | </span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">log_dict_val</span><span class="p">[</span><span class="n">opt</span><span class="p">.</span><span class="n">metric</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>  <span class="c1"># opt.metric=loss，此处指损失更低
</span>                <span class="n">best</span> <span class="o">=</span> <span class="n">log_dict_val</span><span class="p">[</span><span class="n">opt</span><span class="p">.</span><span class="n">metric</span><span class="p">]</span>
                <span class="nf">save_model</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">model_best.pth</span><span class="sh">'</span><span class="p">),</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">save_model</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">model_last.pth</span><span class="sh">'</span><span class="p">),</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">opt</span><span class="p">.</span><span class="n">lr_step</span><span class="p">:</span>   <span class="c1"># 保存模型，更新lr
</span>            <span class="nf">save_model</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">model_{}.pth</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">)),</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">lr</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">**</span> <span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">lr_step</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Drop LR to</span><span class="sh">'</span><span class="p">,</span> <span class="n">lr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param_group</span> <span class="ow">in</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">param_groups</span><span class="p">:</span>
                <span class="n">param_group</span><span class="p">[</span><span class="sh">'</span><span class="s">lr</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">lr</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="nf">opts</span><span class="p">().</span><span class="nf">parse</span><span class="p">()</span>
    <span class="nf">main</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
</pre></table></code></div></div></details><h3 id="p42-测试">P4.2 测试</h3><p>测试代码位于test.py中</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">PrefetchDataset</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">pre_process_func</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">images</span>
        <span class="n">self</span><span class="p">.</span><span class="n">load_image_func</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">coco</span><span class="p">.</span><span class="n">loadImgs</span>
        <span class="n">self</span><span class="p">.</span><span class="n">img_dir</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">img_dir</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pre_process_func</span> <span class="o">=</span> <span class="n">pre_process_func</span>
        <span class="n">self</span><span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">opt</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">img_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">img_info</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">load_image_func</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">img_id</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">img_info</span><span class="p">[</span><span class="sh">'</span><span class="s">file_name</span><span class="sh">'</span><span class="p">])</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
        <span class="n">images</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">scale</span> <span class="ow">in</span> <span class="n">opt</span><span class="p">.</span><span class="n">test_scales</span><span class="p">:</span>   <span class="c1"># 缩放图像
</span>            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">task</span> <span class="o">==</span> <span class="sh">'</span><span class="s">ddd</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">images</span><span class="p">[</span><span class="n">scale</span><span class="p">],</span> <span class="n">meta</span><span class="p">[</span><span class="n">scale</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pre_process_func</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">img_info</span><span class="p">[</span><span class="sh">'</span><span class="s">calib</span><span class="sh">'</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">images</span><span class="p">[</span><span class="n">scale</span><span class="p">],</span> <span class="n">meta</span><span class="p">[</span><span class="n">scale</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pre_process_func</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img_id</span><span class="p">,</span> <span class="p">{</span><span class="sh">'</span><span class="s">images</span><span class="sh">'</span><span class="p">:</span> <span class="n">images</span><span class="p">,</span> <span class="sh">'</span><span class="s">image</span><span class="sh">'</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span> <span class="sh">'</span><span class="s">meta</span><span class="sh">'</span><span class="p">:</span> <span class="n">meta</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">images</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">prefetch_test</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>   <span class="c1">#  对coco图像缩放，并测试最终结果
</span>    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">CUDA_VISIBLE_DEVICES</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">gpus_str</span>

    <span class="n">Dataset</span> <span class="o">=</span> <span class="n">dataset_factory</span><span class="p">[</span><span class="n">opt</span><span class="p">.</span><span class="n">dataset</span><span class="p">]</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="nf">opts</span><span class="p">().</span><span class="nf">update_dataset_info_and_set_heads</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="nc">Logger</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">Detector</span> <span class="o">=</span> <span class="n">detector_factory</span><span class="p">[</span><span class="n">opt</span><span class="p">.</span><span class="n">task</span><span class="p">]</span>

    <span class="n">split</span> <span class="o">=</span> <span class="sh">'</span><span class="s">val</span><span class="sh">'</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">.</span><span class="n">trainval</span> <span class="k">else</span> <span class="sh">'</span><span class="s">test</span><span class="sh">'</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="nc">Dataset</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">split</span><span class="p">)</span>
    <span class="n">detector</span> <span class="o">=</span> <span class="nc">Detector</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

    <span class="n">data_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nc">DataLoader</span><span class="p">(</span><span class="nc">PrefetchDataset</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">detector</span><span class="p">.</span><span class="n">pre_process</span><span class="p">),</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">num_iters</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="nc">Bar</span><span class="p">(</span><span class="sh">'</span><span class="s">{}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">exp_id</span><span class="p">),</span> <span class="nb">max</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span>
    <span class="n">time_stats</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">tot</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">load</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pre</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">net</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dec</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">post</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">merge</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">avg_time_stats</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="nc">AverageMeter</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_stats</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="p">(</span><span class="n">img_id</span><span class="p">,</span> <span class="n">pre_processed_images</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">detector</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">pre_processed_images</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="n">img_id</span><span class="p">.</span><span class="nf">numpy</span><span class="p">().</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int32</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="sh">'</span><span class="s">results</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">Bar</span><span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="sh">'</span><span class="s">[{0}/{1}]|Tot: {total:} |ETA: {eta:} </span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span>
            <span class="n">ind</span><span class="p">,</span> <span class="n">num_iters</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">bar</span><span class="p">.</span><span class="n">elapsed_td</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">bar</span><span class="p">.</span><span class="n">eta_td</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">avg_time_stats</span><span class="p">:</span>
            <span class="n">avg_time_stats</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="nf">update</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
            <span class="n">Bar</span><span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">Bar</span><span class="p">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="sh">'</span><span class="s">|{} {tm.val:.3f}s ({tm.avg:.3f}s) </span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tm</span><span class="o">=</span><span class="n">avg_time_stats</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
        <span class="n">bar</span><span class="p">.</span><span class="nf">next</span><span class="p">()</span>
    <span class="n">bar</span><span class="p">.</span><span class="nf">finish</span><span class="p">()</span>
    <span class="n">dataset</span><span class="p">.</span><span class="nf">run_eval</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">save_dir</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>   <span class="c1"># 测试coco的原始分辨率图像
</span>    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">CUDA_VISIBLE_DEVICES</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">gpus_str</span>

    <span class="n">Dataset</span> <span class="o">=</span> <span class="n">dataset_factory</span><span class="p">[</span><span class="n">opt</span><span class="p">.</span><span class="n">dataset</span><span class="p">]</span> 
    <span class="n">opt</span> <span class="o">=</span> <span class="nf">opts</span><span class="p">().</span><span class="nf">update_dataset_info_and_set_heads</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="nc">Logger</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">Detector</span> <span class="o">=</span> <span class="n">detector_factory</span><span class="p">[</span><span class="n">opt</span><span class="p">.</span><span class="n">task</span><span class="p">]</span>     <span class="c1"># 得到相应的检测器，如CtdetDetector
</span>
    <span class="n">split</span> <span class="o">=</span> <span class="sh">'</span><span class="s">val</span><span class="sh">'</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">.</span><span class="n">trainval</span> <span class="k">else</span> <span class="sh">'</span><span class="s">test</span><span class="sh">'</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="nc">Dataset</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">split</span><span class="p">)</span>
    <span class="n">detector</span> <span class="o">=</span> <span class="nc">Detector</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">num_iters</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="nc">Bar</span><span class="p">(</span><span class="sh">'</span><span class="s">{}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">exp_id</span><span class="p">),</span> <span class="nb">max</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span>
    <span class="n">time_stats</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">tot</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">load</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pre</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">net</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dec</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">post</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">merge</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">avg_time_stats</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="nc">AverageMeter</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_stats</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_iters</span><span class="p">):</span>   <span class="c1"># 测试的时候，batchsize=1
</span>        <span class="n">img_id</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">images</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">img_info</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">coco</span><span class="p">.</span><span class="nf">loadImgs</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">img_id</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">dataset</span><span class="p">.</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">img_info</span><span class="p">[</span><span class="sh">'</span><span class="s">file_name</span><span class="sh">'</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">task</span> <span class="o">==</span> <span class="sh">'</span><span class="s">ddd</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">detector</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">img_info</span><span class="p">[</span><span class="sh">'</span><span class="s">calib</span><span class="sh">'</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">detector</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>   <span class="c1"># 调用CtdetDetector的基类BaseDetector的run函数
</span>
        <span class="n">results</span><span class="p">[</span><span class="n">img_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="sh">'</span><span class="s">results</span><span class="sh">'</span><span class="p">]</span>

        <span class="n">Bar</span><span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="sh">'</span><span class="s">[{0}/{1}]|Tot: {total:} |ETA: {eta:} </span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">num_iters</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">bar</span><span class="p">.</span><span class="n">elapsed_td</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">bar</span><span class="p">.</span><span class="n">eta_td</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">avg_time_stats</span><span class="p">:</span>
            <span class="n">avg_time_stats</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="nf">update</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
            <span class="n">Bar</span><span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">Bar</span><span class="p">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="sh">'</span><span class="s">|{} {:.3f} </span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">avg_time_stats</span><span class="p">[</span><span class="n">t</span><span class="p">].</span><span class="n">avg</span><span class="p">)</span>
        <span class="n">bar</span><span class="p">.</span><span class="nf">next</span><span class="p">()</span>
    <span class="n">bar</span><span class="p">.</span><span class="nf">finish</span><span class="p">()</span>
    <span class="n">dataset</span><span class="p">.</span><span class="nf">run_eval</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">save_dir</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="nf">opts</span><span class="p">().</span><span class="nf">parse</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">not_prefetch_test</span><span class="p">:</span>  
        <span class="nf">test</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>   <span class="c1"># 测试coco的原始分辨率图像
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="nf">prefetch_test</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>  <span class="c1"># 对coco图像缩放，并测试最终结果
</span></pre></table></code></div></div></details><h3 id="p43-demo">P4.3 demo</h3><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="n">image_ext</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">jpg</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">jpeg</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">png</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">webp</span><span class="sh">'</span><span class="p">]</span>
<span class="n">video_ext</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">mp4</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">mov</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">avi</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">mkv</span><span class="sh">'</span><span class="p">]</span>
<span class="n">time_stats</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">tot</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">load</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pre</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">net</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dec</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">post</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">merge</span><span class="sh">'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">demo</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">CUDA_VISIBLE_DEVICES</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">gpus_str</span>
    <span class="n">opt</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">debug</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">Detector</span> <span class="o">=</span> <span class="n">detector_factory</span><span class="p">[</span><span class="n">opt</span><span class="p">.</span><span class="n">task</span><span class="p">]</span>
    <span class="n">detector</span> <span class="o">=</span> <span class="nc">Detector</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>   <span class="c1"># 得到相应的检测器，如CtdetDetector
</span>
    <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">demo</span> <span class="o">==</span> <span class="sh">'</span><span class="s">webcam</span><span class="sh">'</span> <span class="ow">or</span> <span class="n">opt</span><span class="p">.</span><span class="n">demo</span><span class="p">[</span><span class="n">opt</span><span class="p">.</span><span class="n">demo</span><span class="p">.</span><span class="nf">rfind</span><span class="p">(</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:].</span><span class="nf">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">video_ext</span><span class="p">:</span>   <span class="c1"># webcam或者视频
</span>        <span class="n">cam</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nc">VideoCapture</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">demo</span> <span class="o">==</span> <span class="sh">'</span><span class="s">webcam</span><span class="sh">'</span> <span class="k">else</span> <span class="n">opt</span><span class="p">.</span><span class="n">demo</span><span class="p">)</span>
        <span class="n">detector</span><span class="p">.</span><span class="n">pause</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">img</span> <span class="o">=</span> <span class="n">cam</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
            <span class="n">cv2</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">detector</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">time_str</span> <span class="o">=</span> <span class="sh">''</span>
            <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">time_stats</span><span class="p">:</span>
                <span class="n">time_str</span> <span class="o">=</span> <span class="n">time_str</span> <span class="o">+</span> <span class="sh">'</span><span class="s">{} {:.3f}s |</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="n">stat</span><span class="p">])</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">time_str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">27</span><span class="p">:</span>
                <span class="k">return</span>  <span class="c1"># esc to quit
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">demo</span><span class="p">):</span>  <span class="c1"># 图像文件夹
</span>            <span class="n">image_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">demo</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">ls</span><span class="p">):</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">file_name</span><span class="p">[</span><span class="n">file_name</span><span class="p">.</span><span class="nf">rfind</span><span class="p">(</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:].</span><span class="nf">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">image_ext</span><span class="p">:</span>
                    <span class="n">image_names</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">demo</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">opt</span><span class="p">.</span><span class="n">demo</span><span class="p">]</span>   <span class="c1"># 图像文件
</span>
        <span class="nf">for </span><span class="p">(</span><span class="n">image_name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">image_names</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">detector</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">image_name</span><span class="p">)</span>    <span class="c1"># 调用CtdetDetector的基类BaseDetector的run函数
</span>            <span class="n">time_str</span> <span class="o">=</span> <span class="sh">''</span>
            <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">time_stats</span><span class="p">:</span>
                <span class="n">time_str</span> <span class="o">=</span> <span class="n">time_str</span> <span class="o">+</span> <span class="sh">'</span><span class="s">{} {:.3f}s |</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="n">stat</span><span class="p">])</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">time_str</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="nf">opts</span><span class="p">().</span><span class="nf">init</span><span class="p">()</span>
    <span class="nf">demo</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
</pre></table></code></div></div></details><h3 id="p44-默认参数opt">P4.4 默认参数opt</h3><p>位于lib/opts.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">opts</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">()</span>
        <span class="c1"># basic experiment setting
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">task</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">ctdet</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">ctdet | ddd | multi_pose | exdet</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--dataset</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">coco</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">coco | kitti | coco_hp | pascal</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--exp_id</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">default</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--test</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--debug</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">level of visualization.</span><span class="sh">'</span>
                                      <span class="sh">'</span><span class="s">1: only show the final detection results</span><span class="sh">'</span>
                                      <span class="sh">'</span><span class="s">2: show the network output features</span><span class="sh">'</span>
                                      <span class="sh">'</span><span class="s">3: use matplot to display</span><span class="sh">'</span>  <span class="c1"># useful when lunching training with ipython notebook
</span>                                      <span class="sh">'</span><span class="s">4: save all visualizations to disk</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--demo</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">''</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">path to image/ image folders/ video. or </span><span class="sh">"</span><span class="s">webcam</span><span class="sh">"'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--load_model</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">''</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">path to pretrained model</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--resume</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">resume an experiment. </span><span class="sh">'</span>
                                      <span class="sh">'</span><span class="s">Reloaded the optimizer parameter and set load_model to model_last.pth in the exp dir if load_model is empty.</span><span class="sh">'</span><span class="p">)</span>

        <span class="c1"># system
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--gpus</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">0</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">-1 for CPU, use comma for multiple gpus</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--num_workers</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">dataloader threads. 0 for single-thread.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--not_cuda_benchmark</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">disable when the input size is not fixed.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--seed</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">317</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">random seed</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># from CornerNet
</span>
        <span class="c1"># log
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--print_iter</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">disable progress bar and print to screen.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--hide_data_time</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">not display time during training.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--save_all</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">save model to disk every 5 epochs.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--metric</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">loss</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">main metric to save best model</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--vis_thresh</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">visualization threshold.</span><span class="sh">'</span><span class="p">)</span>   <span class="c1"># 显示检测结果的阈值
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--debugger_theme</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">white</span><span class="sh">'</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">white</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">])</span>

        <span class="c1"># model
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--arch</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">dla_34</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">model architecture. Currently tested res_18 | res_101 | resdcn_18 | resdcn_101 | dlav0_34 | dla_34 | hourglass</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--head_conv</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">conv layer channels for output head</span><span class="sh">'</span>
                                      <span class="sh">'</span><span class="s">0 for no conv layer</span><span class="sh">'</span>
                                      <span class="sh">'</span><span class="s">-1 for default setting: </span><span class="sh">'</span>
                                      <span class="sh">'</span><span class="s">64 for resnets and 256 for dla.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--down_ratio</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">output stride. Currently only supports 4.</span><span class="sh">'</span><span class="p">)</span>

        <span class="c1"># input
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--input_res</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">input height and width. -1 for default from dataset. Will be overriden by input_h | input_w</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--input_h</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">input height. -1 for default from dataset.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--input_w</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">input width. -1 for default from dataset.</span><span class="sh">'</span><span class="p">)</span>

        <span class="c1"># train
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--lr</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.25e-4</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">learning rate for batch size 32.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--lr_step</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">90,120</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">drop learning rate by 10.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--num_epochs</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">total training epochs.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--batch_size</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">batch size</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--master_batch_size</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">batch size on the master gpu.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--num_iters</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">default: #samples / batch_size.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--val_intervals</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">number of epochs to run validation.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--trainval</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">include validation in training and test on test set</span><span class="sh">'</span><span class="p">)</span>

        <span class="c1"># test
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--flip_test</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">flip data augmentation.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--test_scales</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">multi scale test augmentation.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--nms</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">run nms in testing.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--K</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">max number of output objects.</span><span class="sh">'</span><span class="p">)</span>   <span class="c1"># 做多检测的目标数量
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--not_prefetch_test</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">not use parallal data pre-processing.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--fix_res</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">fix testing resolution or keep the original resolution</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--keep_res</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">keep the original resolution during validation.</span><span class="sh">'</span><span class="p">)</span>

        <span class="c1"># dataset
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--not_rand_crop</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">not use the random crop data augmentation from CornerNet.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--shift</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">when not using random crop apply shift augmentation.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--scale</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">when not using random crop apply scale augmentation.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--rotate</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">when not using random crop apply rotation augmentation.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--flip</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">probability of applying flip augmentation.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--no_color_aug</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">not use the color augmenation from CornerNet</span><span class="sh">'</span><span class="p">)</span>
        <span class="c1"># multi_pose
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--aug_rot</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">probability of applying rotation augmentation.</span><span class="sh">'</span><span class="p">)</span>
        <span class="c1"># ddd
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--aug_ddd</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">probability of applying crop augmentation.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--rect_mask</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">for ignored object, apply mask on the rectangular region or just center point.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--kitti_split</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">3dop</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">different validation split for kitti: 3dop | subcnn</span><span class="sh">'</span><span class="p">)</span>

        <span class="c1"># loss
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--mse_loss</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">use mse loss or focal loss to train keypoint heatmaps.</span><span class="sh">'</span><span class="p">)</span>   <span class="c1"># 为False，否则lib\datasets\sample\ctdet.py中hm_gauss未定义
</span>        <span class="c1"># ctdet
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--reg_loss</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">l1</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">regression loss: sl1 | l1 | l2</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--hm_weight</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">loss weight for keypoint heatmaps.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--off_weight</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">loss weight for keypoint local offsets.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--wh_weight</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">loss weight for bounding box size.</span><span class="sh">'</span><span class="p">)</span>
        <span class="c1"># multi_pose
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--hp_weight</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">loss weight for human pose offset.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--hm_hp_weight</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">loss weight for human keypoint heatmap.</span><span class="sh">'</span><span class="p">)</span>
        <span class="c1"># ddd
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--dep_weight</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">loss weight for depth.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--dim_weight</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">loss weight for 3d bounding box size.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--rot_weight</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">loss weight for orientation.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--peak_thresh</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="c1"># task
</span>        <span class="c1"># ctdet
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--norm_wh</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">L1(\hat(y) / y, 1) or L1(\hat(y), y)</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--dense_wh</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">apply weighted regression near center or just apply regression on center point.</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># 目标中心是否加权
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--cat_spec_wh</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">category specific bounding box size.</span><span class="sh">'</span><span class="p">)</span>   <span class="c1"># 特定类别的box size
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--not_reg_offset</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">not regress local offset.</span><span class="sh">'</span><span class="p">)</span>
        <span class="c1"># exdet
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--agnostic_ex</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">use category agnostic extreme points.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--scores_thresh</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">threshold for extreme point heatmap.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--center_thresh</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">threshold for centermap.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--aggr_weight</span><span class="sh">'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">edge aggregation weight.</span><span class="sh">'</span><span class="p">)</span>
        <span class="c1"># multi_pose
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--dense_hp</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">apply weighted pose regression near center </span><span class="sh">'</span>
                                      <span class="sh">'</span><span class="s">or just apply regression on center point.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--not_hm_hp</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">not estimate human joint heatmap, directly use the joint offset from center.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--not_reg_hp_offset</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">not regress local offset for human joint heatmaps.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--not_reg_bbox</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">not regression bounding box size.</span><span class="sh">'</span><span class="p">)</span>

        <span class="c1"># ground truth validation
</span>        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--eval_oracle_hm</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">use ground center heatmap.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--eval_oracle_wh</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">use ground truth bounding box size.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--eval_oracle_offset</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">use ground truth local heatmap offset.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--eval_oracle_kps</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">use ground truth human pose offset.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--eval_oracle_hmhp</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">use ground truth human joint heatmaps.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--eval_oracle_hp_offset</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">use ground truth human joint local offset.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--eval_oracle_dep</span><span class="sh">'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="sh">'</span><span class="s">store_true</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">use ground truth depth.</span><span class="sh">'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="sh">''</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span> <span class="o">==</span> <span class="sh">''</span><span class="p">:</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="n">opt</span><span class="p">.</span><span class="n">gpus_str</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">gpus</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">gpus</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">gpu</span><span class="p">)</span> <span class="k">for</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="n">opt</span><span class="p">.</span><span class="n">gpus</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="p">)]</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">gpus</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">gpus</span><span class="p">))]</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">lr_step</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">opt</span><span class="p">.</span><span class="n">lr_step</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="p">)]</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">test_scales</span> <span class="o">=</span> <span class="p">[</span><span class="nf">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">opt</span><span class="p">.</span><span class="n">test_scales</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="p">)]</span>

        <span class="n">opt</span><span class="p">.</span><span class="n">fix_res</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">.</span><span class="n">keep_res</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Fix size testing.</span><span class="sh">'</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">fix_res</span> <span class="k">else</span> <span class="sh">'</span><span class="s">Keep resolution testing.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">reg_offset</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">.</span><span class="n">not_reg_offset</span>   <span class="c1"># 约束局部偏移
</span>        <span class="n">opt</span><span class="p">.</span><span class="n">reg_bbox</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">.</span><span class="n">not_reg_bbox</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">hm_hp</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">.</span><span class="n">not_hm_hp</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">reg_hp_offset</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">opt</span><span class="p">.</span><span class="n">not_reg_hp_offset</span><span class="p">)</span> <span class="ow">and</span> <span class="n">opt</span><span class="p">.</span><span class="n">hm_hp</span>

        <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">head_conv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># init default head_conv
</span>            <span class="n">opt</span><span class="p">.</span><span class="n">head_conv</span> <span class="o">=</span> <span class="mi">256</span> <span class="k">if</span> <span class="sh">'</span><span class="s">dla</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">opt</span><span class="p">.</span><span class="n">arch</span> <span class="k">else</span> <span class="mi">64</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="mi">127</span> <span class="k">if</span> <span class="sh">'</span><span class="s">hourglass</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">opt</span><span class="p">.</span><span class="n">arch</span> <span class="k">else</span> <span class="mi">31</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">num_stacks</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">arch</span> <span class="o">==</span> <span class="sh">'</span><span class="s">hourglass</span><span class="sh">'</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">trainval</span><span class="p">:</span>
            <span class="n">opt</span><span class="p">.</span><span class="n">val_intervals</span> <span class="o">=</span> <span class="mi">100000000</span>

        <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">opt</span><span class="p">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">opt</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">opt</span><span class="p">.</span><span class="n">gpus</span> <span class="o">=</span> <span class="p">[</span><span class="n">opt</span><span class="p">.</span><span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">opt</span><span class="p">.</span><span class="n">master_batch_size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">master_batch_size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">opt</span><span class="p">.</span><span class="n">master_batch_size</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">//</span> <span class="nf">len</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">gpus</span><span class="p">)</span>
        <span class="n">rest_batch_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">-</span> <span class="n">opt</span><span class="p">.</span><span class="n">master_batch_size</span><span class="p">)</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">chunk_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">opt</span><span class="p">.</span><span class="n">master_batch_size</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">gpus</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">slave_chunk_size</span> <span class="o">=</span> <span class="n">rest_batch_size</span> <span class="o">//</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">gpus</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rest_batch_size</span> <span class="o">%</span> <span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">gpus</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">slave_chunk_size</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">opt</span><span class="p">.</span><span class="n">chunk_sizes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">slave_chunk_size</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">training chunk_sizes:</span><span class="sh">'</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">chunk_sizes</span><span class="p">)</span>

        <span class="n">opt</span><span class="p">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="sh">'</span><span class="s">..</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">..</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">exp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">exp</span><span class="sh">'</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">task</span><span class="p">)</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">exp_dir</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">exp_id</span><span class="p">)</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">debug_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="sh">'</span><span class="s">debug</span><span class="sh">'</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">The output will be saved to </span><span class="sh">'</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">save_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">resume</span> <span class="ow">and</span> <span class="n">opt</span><span class="p">.</span><span class="n">load_model</span> <span class="o">==</span> <span class="sh">''</span><span class="p">:</span>
            <span class="n">model_path</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">save_dir</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">save_dir</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">'</span><span class="s">TEST</span><span class="sh">'</span><span class="p">)</span> <span class="k">else</span> <span class="n">opt</span><span class="p">.</span><span class="n">save_dir</span>
            <span class="n">opt</span><span class="p">.</span><span class="n">load_model</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">model_last.pth</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">opt</span>

    <span class="k">def</span> <span class="nf">update_dataset_info_and_set_heads</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>  <span class="c1"># 更新dataset，设置检测的head
</span>        <span class="n">input_h</span><span class="p">,</span> <span class="n">input_w</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">default_resolution</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">dataset</span><span class="p">.</span><span class="n">std</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">num_classes</span>

        <span class="c1"># input_h(w): opt.input_h overrides opt.input_res overrides dataset default
</span>        <span class="n">input_h</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">input_res</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">input_res</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">input_h</span>   <span class="c1"># 更新默认值
</span>        <span class="n">input_w</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">input_res</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">input_res</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">input_w</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">input_h</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">input_h</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">input_h</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">input_h</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">input_w</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">input_w</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">input_w</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">input_w</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">output_h</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">input_h</span> <span class="o">//</span> <span class="n">opt</span><span class="p">.</span><span class="n">down_ratio</span>   <span class="c1"># down_ratio默认为4
</span>        <span class="n">opt</span><span class="p">.</span><span class="n">output_w</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">input_w</span> <span class="o">//</span> <span class="n">opt</span><span class="p">.</span><span class="n">down_ratio</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">input_res</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">input_h</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">input_w</span><span class="p">)</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">output_res</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">output_h</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">output_w</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">task</span> <span class="o">==</span> <span class="sh">'</span><span class="s">exdet</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># assert opt.dataset in ['coco']
</span>            <span class="n">num_hm</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">agnostic_ex</span> <span class="k">else</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_classes</span>
            <span class="n">opt</span><span class="p">.</span><span class="n">heads</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">hm_t</span><span class="sh">'</span><span class="p">:</span> <span class="n">num_hm</span><span class="p">,</span> <span class="sh">'</span><span class="s">hm_l</span><span class="sh">'</span><span class="p">:</span> <span class="n">num_hm</span><span class="p">,</span> <span class="sh">'</span><span class="s">hm_b</span><span class="sh">'</span><span class="p">:</span> <span class="n">num_hm</span><span class="p">,</span> <span class="sh">'</span><span class="s">hm_r</span><span class="sh">'</span><span class="p">:</span> <span class="n">num_hm</span><span class="p">,</span> <span class="sh">'</span><span class="s">hm_c</span><span class="sh">'</span><span class="p">:</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_classes</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">reg_offset</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">.</span><span class="n">heads</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">'</span><span class="s">reg_t</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="sh">'</span><span class="s">reg_l</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="sh">'</span><span class="s">reg_b</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="sh">'</span><span class="s">reg_r</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="k">elif</span> <span class="n">opt</span><span class="p">.</span><span class="n">task</span> <span class="o">==</span> <span class="sh">'</span><span class="s">ddd</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># assert opt.dataset in ['gta', 'kitti', 'viper']
</span>            <span class="n">opt</span><span class="p">.</span><span class="n">heads</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">:</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="sh">'</span><span class="s">dep</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">'</span><span class="s">rot</span><span class="sh">'</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="sh">'</span><span class="s">dim</span><span class="sh">'</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">reg_bbox</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">.</span><span class="n">heads</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">reg_offset</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">.</span><span class="n">heads</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">'</span><span class="s">reg</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="k">elif</span> <span class="n">opt</span><span class="p">.</span><span class="n">task</span> <span class="o">==</span> <span class="sh">'</span><span class="s">ctdet</span><span class="sh">'</span><span class="p">:</span>    <span class="c1"># 检测
</span>            <span class="c1"># assert opt.dataset in ['pascal', 'coco']
</span>            <span class="n">opt</span><span class="p">.</span><span class="n">heads</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">:</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">.</span><span class="n">cat_spec_wh</span> <span class="k">else</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_classes</span><span class="p">}</span>  <span class="c1"># hm 热图数量   wh：不限定特定类别box大小的话，就是2。否则，就是2*类别数量
</span>            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">reg_offset</span><span class="p">:</span>   <span class="c1"># 约束局部偏移
</span>                <span class="n">opt</span><span class="p">.</span><span class="n">heads</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">'</span><span class="s">reg</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="k">elif</span> <span class="n">opt</span><span class="p">.</span><span class="n">task</span> <span class="o">==</span> <span class="sh">'</span><span class="s">multi_pose</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># assert opt.dataset in ['coco_hp']
</span>            <span class="n">opt</span><span class="p">.</span><span class="n">flip_idx</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">flip_idx</span>
            <span class="n">opt</span><span class="p">.</span><span class="n">heads</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">:</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="sh">'</span><span class="s">hps</span><span class="sh">'</span><span class="p">:</span> <span class="mi">34</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">reg_offset</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">.</span><span class="n">heads</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">'</span><span class="s">reg</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">hm_hp</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">.</span><span class="n">heads</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">'</span><span class="s">hm_hp</span><span class="sh">'</span><span class="p">:</span> <span class="mi">17</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">reg_hp_offset</span><span class="p">:</span>
                <span class="n">opt</span><span class="p">.</span><span class="n">heads</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">'</span><span class="s">hp_offset</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="mi">0</span><span class="p">,</span> <span class="sh">'</span><span class="s">task not defined!</span><span class="sh">'</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">heads</span><span class="sh">'</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">heads</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">opt</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="sh">''</span><span class="p">):</span>
        <span class="n">default_dataset_info</span> <span class="o">=</span> <span class="p">{</span>   <span class="c1"># 默认dataset的信息
</span>            <span class="sh">'</span><span class="s">ctdet</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">default_resolution</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">],</span> <span class="sh">'</span><span class="s">num_classes</span><span class="sh">'</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.408</span><span class="p">,</span> <span class="mf">0.447</span><span class="p">,</span> <span class="mf">0.470</span><span class="p">],</span> <span class="sh">'</span><span class="s">std</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.289</span><span class="p">,</span> <span class="mf">0.274</span><span class="p">,</span> <span class="mf">0.278</span><span class="p">],</span> <span class="sh">'</span><span class="s">dataset</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">coco</span><span class="sh">'</span><span class="p">},</span>
            <span class="sh">'</span><span class="s">exdet</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">default_resolution</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">],</span> <span class="sh">'</span><span class="s">num_classes</span><span class="sh">'</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.408</span><span class="p">,</span> <span class="mf">0.447</span><span class="p">,</span> <span class="mf">0.470</span><span class="p">],</span> <span class="sh">'</span><span class="s">std</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.289</span><span class="p">,</span> <span class="mf">0.274</span><span class="p">,</span> <span class="mf">0.278</span><span class="p">],</span> <span class="sh">'</span><span class="s">dataset</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">coco</span><span class="sh">'</span><span class="p">},</span>
            <span class="sh">'</span><span class="s">multi_pose</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">default_resolution</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">],</span> <span class="sh">'</span><span class="s">num_classes</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.408</span><span class="p">,</span> <span class="mf">0.447</span><span class="p">,</span> <span class="mf">0.470</span><span class="p">],</span> <span class="sh">'</span><span class="s">std</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.289</span><span class="p">,</span> <span class="mf">0.274</span><span class="p">,</span> <span class="mf">0.278</span><span class="p">],</span>
                    <span class="sh">'</span><span class="s">dataset</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">coco_hp</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">num_joints</span><span class="sh">'</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="sh">'</span><span class="s">flip_idx</span><span class="sh">'</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">]]},</span>
            <span class="sh">'</span><span class="s">ddd</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">default_resolution</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">384</span><span class="p">,</span> <span class="mi">1280</span><span class="p">],</span> <span class="sh">'</span><span class="s">num_classes</span><span class="sh">'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="sh">'</span><span class="s">std</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">],</span> <span class="sh">'</span><span class="s">dataset</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">kitti</span><span class="sh">'</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="k">class</span> <span class="nc">Struct</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">__setattr__</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="nc">Struct</span><span class="p">(</span><span class="n">default_dataset_info</span><span class="p">[</span><span class="n">opt</span><span class="p">.</span><span class="n">task</span><span class="p">])</span>
        <span class="n">opt</span><span class="p">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">dataset</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">update_dataset_info_and_set_heads</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">opt</span>
</pre></table></code></div></div></details><h3 id="p45-模型相关">P4.5 模型相关</h3><h4 id="p451-create_model">P4.5.1 create_model</h4><p>均位于lib/models/model.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="n">_model_factory</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">res</span><span class="sh">'</span><span class="p">:</span> <span class="n">get_pose_net</span><span class="p">,</span>  <span class="c1"># default Resnet with deconv  含有deconv的resnet
</span>    <span class="sh">'</span><span class="s">dlav0</span><span class="sh">'</span><span class="p">:</span> <span class="n">get_dlav0</span><span class="p">,</span>  <span class="c1"># default DLAup
</span>    <span class="sh">'</span><span class="s">dla</span><span class="sh">'</span><span class="p">:</span> <span class="n">get_dla_dcn</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">resdcn</span><span class="sh">'</span><span class="p">:</span> <span class="n">get_pose_net_dcn</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">hourglass</span><span class="sh">'</span><span class="p">:</span> <span class="n">get_large_hourglass_net</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">head_conv</span><span class="p">):</span>   <span class="c1"># arch为dla_34等，heads为相关参数，head_conv为通道数量
</span>    <span class="n">num_layers</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">arch</span><span class="p">[</span><span class="n">arch</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:])</span> <span class="k">if</span> <span class="sh">'</span><span class="s">_</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">arch</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">arch</span> <span class="o">=</span> <span class="n">arch</span><span class="p">[:</span><span class="n">arch</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">)]</span> <span class="k">if</span> <span class="sh">'</span><span class="s">_</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">arch</span> <span class="k">else</span> <span class="n">arch</span>
    <span class="n">get_model</span> <span class="o">=</span> <span class="n">_model_factory</span><span class="p">[</span><span class="n">arch</span><span class="p">]</span>   <span class="c1"># 得到实际模型的名字
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nf">get_model</span><span class="p">(</span><span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">,</span> <span class="n">heads</span><span class="o">=</span><span class="n">heads</span><span class="p">,</span> <span class="n">head_conv</span><span class="o">=</span><span class="n">head_conv</span><span class="p">)</span>   <span class="c1"># 得到实际模型
</span><span class="k">return</span> <span class="n">model</span>
</pre></table></code></div></div></details><h4 id="p452-load_model">P4.5.2 load_model</h4><p>均位于lib/models/model.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lr_step</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">start_epoch</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="k">lambda</span> <span class="n">storage</span><span class="p">,</span> <span class="n">loc</span><span class="p">:</span> <span class="n">storage</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">loaded {}, epoch {}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">[</span><span class="sh">'</span><span class="s">epoch</span><span class="sh">'</span><span class="p">]))</span>
    <span class="n">state_dict_</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="sh">'</span><span class="s">state_dict</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">state_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># convert data_parallal to model
</span>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">state_dict_</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">module</span><span class="sh">'</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">k</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">module_list</span><span class="sh">'</span><span class="p">):</span>
            <span class="n">state_dict</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">7</span><span class="p">:]]</span> <span class="o">=</span> <span class="n">state_dict_</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_dict_</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">model_state_dict</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">state_dict</span><span class="p">()</span>

    <span class="c1"># check loaded parameters and created model parameters
</span>    <span class="n">msg</span> <span class="o">=</span> <span class="sh">'</span><span class="s">If you see this, your model does not fully load the pre-trained weight. Please make sure </span><span class="sh">'</span> <span class="o">+</span> \
          <span class="sh">'</span><span class="s">you have correctly specified --arch xxx or set the correct --num_classes for your own dataset.</span><span class="sh">'</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">model_state_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state_dict</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">model_state_dict</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">shape</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Skip loading parameter {}, required shape{}, </span><span class="sh">'</span>
                      <span class="sh">'</span><span class="s">loaded shape{}. {}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">model_state_dict</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">shape</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">shape</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
                <span class="n">state_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_state_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Drop parameter {}.</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">model_state_dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">state_dict</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">No param {}.</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
            <span class="n">state_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_state_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># resume optimizer parameters
</span>    <span class="k">if</span> <span class="n">optimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">resume</span><span class="p">:</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">optimizer</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="p">:</span>
            <span class="n">optimizer</span><span class="p">.</span><span class="nf">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="sh">'</span><span class="s">optimizer</span><span class="sh">'</span><span class="p">])</span>
            <span class="n">start_epoch</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="sh">'</span><span class="s">epoch</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">start_lr</span> <span class="o">=</span> <span class="n">lr</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">lr_step</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start_epoch</span> <span class="o">&gt;=</span> <span class="n">step</span><span class="p">:</span>
                    <span class="n">start_lr</span> <span class="o">*=</span> <span class="mf">0.1</span>
            <span class="k">for</span> <span class="n">param_group</span> <span class="ow">in</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">param_groups</span><span class="p">:</span>
                <span class="n">param_group</span><span class="p">[</span><span class="sh">'</span><span class="s">lr</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_lr</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Resumed optimizer with start lr</span><span class="sh">'</span><span class="p">,</span> <span class="n">start_lr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">No optimizer parameters in checkpoint.</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">optimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">start_epoch</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">model</span>
</pre></table></code></div></div></details><h4 id="p453-save_model">P4.5.3 save_model</h4><p>均位于lib/models/model.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">DataParallel</span><span class="p">):</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="nf">state_dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">state_dict</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">epoch</span><span class="sh">'</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span> <span class="sh">'</span><span class="s">state_dict</span><span class="sh">'</span><span class="p">:</span> <span class="n">state_dict</span><span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">optimizer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">optimizer</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">state_dict</span><span class="p">()</span>
    <span class="n">torch</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</pre></table></code></div></div></details><h4 id="454-get_pose_net">4.5.4 get_pose_net</h4><p>位于lib/models/networks/msra_resnet.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">conv3x3</span><span class="p">(</span><span class="n">in_planes</span><span class="p">,</span> <span class="n">out_planes</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">3x3 convolution with padding</span><span class="sh">"""</span>
    <span class="k">return</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="n">in_planes</span><span class="p">,</span> <span class="n">out_planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BasicBlock</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>   <span class="c1"># ((x or downsample(x))  +  (conv+bn+relu  +  conv+bn))  +  relu
</span>    <span class="n">expansion</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">downsample</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">BasicBlock</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="nf">conv3x3</span><span class="p">(</span><span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="n">BN_MOMENTUM</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="nf">conv3x3</span><span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">planes</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bn2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="n">BN_MOMENTUM</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">downsample</span> <span class="o">=</span> <span class="n">downsample</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> 
        <span class="n">residual</span> <span class="o">=</span> <span class="n">x</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bn1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bn2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">downsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">downsample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">+=</span> <span class="n">residual</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">Bottleneck</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>   <span class="c1"># ((x or downsample(x))  +  (conv+bn+relu  +  conv+bn+relu  +  conv+bn))  +  relu
</span>    <span class="n">expansion</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">downsample</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Bottleneck</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="n">BN_MOMENTUM</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bn2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="n">BN_MOMENTUM</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">planes</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">expansion</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bn3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">expansion</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="n">BN_MOMENTUM</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">downsample</span> <span class="o">=</span> <span class="n">downsample</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> 
        <span class="n">residual</span> <span class="o">=</span> <span class="n">x</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bn1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bn2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv3</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bn3</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">downsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">downsample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">+=</span> <span class="n">residual</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">PoseResNet</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">head_conv</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">inplanes</span> <span class="o">=</span> <span class="mi">64</span>
        <span class="n">self</span><span class="p">.</span><span class="n">deconv_with_bias</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">heads</span> <span class="o">=</span> <span class="n">heads</span>

        <span class="nf">super</span><span class="p">(</span><span class="n">PoseResNet</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="n">BN_MOMENTUM</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">maxpool</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">layer1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_layer</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">layer2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_layer</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">layer3</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_layer</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">layer4</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_layer</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>   <span class="c1"># 输出特征宽高为图像宽高的1/32
</span>
        <span class="n">self</span><span class="p">.</span><span class="n">deconv_layers</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_make_deconv_layer</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">)</span>   <span class="c1"># 输出特征宽高为图像宽高的1/4    # used for deconv layers
</span>        <span class="c1"># self.final_layer = []
</span>
        <span class="k">for</span> <span class="n">head</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">heads</span><span class="p">):</span>  <span class="c1"># {'hm': num_classes, 'reg': 2, 'wh': 2}
</span>            <span class="n">num_output</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">heads</span><span class="p">[</span><span class="n">head</span><span class="p">]</span>  <span class="c1"># 分别得到num_classes,2,2
</span>            <span class="k">if</span> <span class="n">head_conv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>   <span class="c1"># head_conv=256
</span>                <span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span>
                    <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">head_conv</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
                    <span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
                    <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="n">head_conv</span><span class="p">,</span> <span class="n">num_output</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># 最后的1*1 conv作为分类层，得到num_output维度的特征
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="n">num_output</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   <span class="c1"># 直接使用1*1 conv作为分类层，得到num_output维度的特征
</span>            <span class="n">self</span><span class="p">.</span><span class="nf">__setattr__</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">fc</span><span class="p">)</span>   <span class="c1"># 设置hm，reg，wh这些层
</span>
        <span class="c1"># self.final_layer = nn.ModuleList(self.final_layer)
</span>
    <span class="k">def</span> <span class="nf">_make_layer</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># block：BasicBlock or Bottleneck
</span>        <span class="n">downsample</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">stride</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">inplanes</span> <span class="o">!=</span> <span class="n">planes</span> <span class="o">*</span> <span class="n">block</span><span class="p">.</span><span class="n">expansion</span><span class="p">:</span>
            <span class="n">downsample</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span>
                <span class="n">nn</span><span class="p">.</span><span class="nc">Conv2d</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span> <span class="o">*</span> <span class="n">block</span><span class="p">.</span><span class="n">expansion</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                <span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span> <span class="o">*</span> <span class="n">block</span><span class="p">.</span><span class="n">expansion</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="n">BN_MOMENTUM</span><span class="p">),)</span>

        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">layers</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">block</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">downsample</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">inplanes</span> <span class="o">=</span> <span class="n">planes</span> <span class="o">*</span> <span class="n">block</span><span class="p">.</span><span class="n">expansion</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
            <span class="n">layers</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">block</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_deconv_cfg</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">deconv_kernel</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">deconv_kernel</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">output_padding</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">deconv_kernel</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">output_padding</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">deconv_kernel</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">output_padding</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">deconv_kernel</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">output_padding</span>

    <span class="k">def</span> <span class="nf">_make_deconv_layer</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">,</span> <span class="n">num_filters</span><span class="p">,</span> <span class="n">num_kernels</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">num_layers</span> <span class="o">==</span> <span class="nf">len</span><span class="p">(</span><span class="n">num_filters</span><span class="p">),</span> <span class="sh">'</span><span class="s">ERROR: num_deconv_layers is different len(num_deconv_filters)</span><span class="sh">'</span>
        <span class="k">assert</span> <span class="n">num_layers</span> <span class="o">==</span> <span class="nf">len</span><span class="p">(</span><span class="n">num_kernels</span><span class="p">),</span> <span class="sh">'</span><span class="s">ERROR: num_deconv_layers is different len(num_deconv_filters)</span><span class="sh">'</span>

        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>   <span class="c1"># num_layers=3
</span>            <span class="n">kernel</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">output_padding</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_deconv_cfg</span><span class="p">(</span><span class="n">num_kernels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>   <span class="c1"># num_kernels=[4, 4, 4]   输出4,1,0
</span>
            <span class="n">planes</span> <span class="o">=</span> <span class="n">num_filters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="c1"># num_filters=[256, 256, 256]
</span>            <span class="c1"># 转置卷积，增加输出特征分辨率
</span>            <span class="n">layers</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="nc">ConvTranspose2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">inplanes</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="n">planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span> <span class="n">output_padding</span><span class="o">=</span><span class="n">output_padding</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">deconv_with_bias</span><span class="p">))</span> 
            <span class="n">layers</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="n">BN_MOMENTUM</span><span class="p">))</span>
            <span class="n">layers</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
            <span class="n">self</span><span class="p">.</span><span class="n">inplanes</span> <span class="o">=</span> <span class="n">planes</span>

        <span class="k">return</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bn1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">maxpool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">layer1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">layer2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">layer3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">layer4</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">deconv_layers</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">head</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">heads</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">head</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">__getattr__</span><span class="p">(</span><span class="n">head</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ret</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">num_layers</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pretrained</span><span class="p">:</span>
            <span class="c1"># print('=&gt; init resnet deconv weights from normal distribution')
</span>            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">deconv_layers</span><span class="p">.</span><span class="nf">named_modules</span><span class="p">():</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="p">.</span><span class="n">ConvTranspose2d</span><span class="p">):</span>
                    <span class="c1"># print('=&gt; init {}.weight as normal(0, 0.001)'.format(name))
</span>                    <span class="c1"># print('=&gt; init {}.bias as 0'.format(name))
</span>                    <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">normal_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">deconv_with_bias</span><span class="p">:</span>
                        <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="p">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
                    <span class="c1"># print('=&gt; init {}.weight as 1'.format(name))
</span>                    <span class="c1"># print('=&gt; init {}.bias as 0'.format(name))
</span>                    <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># print('=&gt; init final conv weights from normal distribution')
</span>            <span class="k">for</span> <span class="n">head</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">heads</span><span class="p">:</span>   <span class="c1"># hm，reg，wh这些层
</span>                <span class="n">final_layer</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">__getattr__</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">final_layer</span><span class="p">.</span><span class="nf">modules</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">):</span>
                        <span class="c1"># nn.init.kaiming_normal_(m.weight, mode='fan_out', nonlinearity='relu')
</span>                        <span class="c1"># print('=&gt; init {}.weight as normal(0, 0.001)'.format(name))
</span>                        <span class="c1"># print('=&gt; init {}.bias as 0'.format(name))
</span>                        <span class="k">if</span> <span class="n">m</span><span class="p">.</span><span class="n">weight</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">heads</span><span class="p">[</span><span class="n">head</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="sh">'</span><span class="s">hm</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">head</span><span class="p">:</span>
                                <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">bias</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.19</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">normal_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
                                <span class="n">nn</span><span class="p">.</span><span class="n">init</span><span class="p">.</span><span class="nf">constant_</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">bias</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1">#pretrained_state_dict = torch.load(pretrained)
</span>            <span class="n">url</span> <span class="o">=</span> <span class="n">model_urls</span><span class="p">[</span><span class="sh">'</span><span class="s">resnet{}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">num_layers</span><span class="p">)]</span>
            <span class="n">pretrained_state_dict</span> <span class="o">=</span> <span class="n">model_zoo</span><span class="p">.</span><span class="nf">load_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">=&gt; loading pretrained model {}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">load_state_dict</span><span class="p">(</span><span class="n">pretrained_state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">=&gt; imagenet pretrained model dose not exist</span><span class="sh">'</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">=&gt; please download it first</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">'</span><span class="s">imagenet pretrained model does not exist</span><span class="sh">'</span><span class="p">)</span>

<span class="n">resnet_spec</span> <span class="o">=</span> <span class="p">{</span><span class="mi">18</span><span class="p">:</span> <span class="p">(</span><span class="n">BasicBlock</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
               <span class="mi">34</span><span class="p">:</span> <span class="p">(</span><span class="n">BasicBlock</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
               <span class="mi">50</span><span class="p">:</span> <span class="p">(</span><span class="n">Bottleneck</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
               <span class="mi">101</span><span class="p">:</span> <span class="p">(</span><span class="n">Bottleneck</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
               <span class="mi">152</span><span class="p">:</span> <span class="p">(</span><span class="n">Bottleneck</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">3</span><span class="p">])}</span>

<span class="k">def</span> <span class="nf">get_pose_net</span><span class="p">(</span><span class="n">num_layers</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">head_conv</span><span class="p">):</span>  <span class="c1"># head_conv=256
</span>    <span class="n">block_class</span><span class="p">,</span> <span class="n">layers</span> <span class="o">=</span> <span class="n">resnet_spec</span><span class="p">[</span><span class="n">num_layers</span><span class="p">]</span>

    <span class="n">model</span> <span class="o">=</span> <span class="nc">PoseResNet</span><span class="p">(</span><span class="n">block_class</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">head_conv</span><span class="o">=</span><span class="n">head_conv</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">init_weights</span><span class="p">(</span><span class="n">num_layers</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</pre></table></code></div></div></details><h3 id="p46-得到数据get_dataset">P4.6 得到数据get_dataset</h3><p>得到数据数据，供dataloader使用的get_dataset位于src/lib/datasets/dataset_factory.py。其根据输入得到实际的Dataset。</p><h4 id="p461-get_dataset">P4.6.1 get_dataset</h4><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="n">dataset_factory</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">coco</span><span class="sh">'</span><span class="p">:</span> <span class="n">COCO</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">pascal</span><span class="sh">'</span><span class="p">:</span> <span class="n">PascalVOC</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">kitti</span><span class="sh">'</span><span class="p">:</span> <span class="n">KITTI</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">coco_hp</span><span class="sh">'</span><span class="p">:</span> <span class="n">COCOHP</span>
<span class="p">}</span>

<span class="n">_sample_factory</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">exdet</span><span class="sh">'</span><span class="p">:</span> <span class="n">EXDetDataset</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">ctdet</span><span class="sh">'</span><span class="p">:</span> <span class="n">CTDetDataset</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">ddd</span><span class="sh">'</span><span class="p">:</span> <span class="n">DddDataset</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">multi_pose</span><span class="sh">'</span><span class="p">:</span> <span class="n">MultiPoseDataset</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Dataset</span><span class="p">(</span><span class="n">dataset_factory</span><span class="p">[</span><span class="n">dataset</span><span class="p">],</span> <span class="n">_sample_factory</span><span class="p">[</span><span class="n">task</span><span class="p">]):</span>   <span class="c1"># 自定义的dataset
</span>        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">Dataset</span>
</pre></table></code></div></div></details><h4 id="p462-ctdetdataset">P4.6.2 CTDetDataset</h4><p>其位于src/lib/datasets/sample/ctdet.py。</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">CTDetDataset</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_coco_box_to_bbox</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>  <span class="c1"># 从coco的[x_start,y_start_w,h]变换到bbox的[x1,y1,x2,y2]
</span>        <span class="n">bbox</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bbox</span>

    <span class="k">def</span> <span class="nf">_get_border</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">border</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">size</span> <span class="o">-</span> <span class="n">border</span> <span class="o">//</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">border</span> <span class="o">//</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">border</span> <span class="o">//</span> <span class="n">i</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>      <span class="c1"># 以下均使用COCO做注释，如果使用lib\datasets\dataset_factory.py中其他类（如PascalVOC、KITTI），应该类似
</span>        <span class="n">img_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>   <span class="c1"># 得到图像id
</span>        <span class="n">file_name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">coco</span><span class="p">.</span><span class="nf">loadImgs</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">img_id</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">file_name</span><span class="sh">'</span><span class="p">]</span>   <span class="c1"># loadImgs为代码中类的COCO的self.coco的函数，返回list，因而使用[0]，最终得到文件名字
</span>        <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>   <span class="c1"># self.img_dir为代码中类的COCO自带的变量
</span>        <span class="n">ann_ids</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">coco</span><span class="p">.</span><span class="nf">getAnnIds</span><span class="p">(</span><span class="n">imgIds</span><span class="o">=</span><span class="p">[</span><span class="n">img_id</span><span class="p">])</span>   <span class="c1"># getAnnIds为代码中类的COCO的self.coco的函数
</span>        <span class="n">anns</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">coco</span><span class="p">.</span><span class="nf">loadAnns</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="n">ann_ids</span><span class="p">)</span>          <span class="c1"># loadAnnsgetAnnIds为代码中类的COCO的self.coco的函数
</span>        <span class="n">num_objs</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">anns</span><span class="p">),</span> <span class="n">self</span><span class="p">.</span><span class="n">max_objs</span><span class="p">)</span>        <span class="c1"># 目标数量的最小值
</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>  <span class="c1"># 读取图像
</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>   <span class="c1"># 图像中心，即仿射变换的中心
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">keep_res</span><span class="p">:</span>    <span class="c1"># 验证时是否保持图像原始分辨率
</span>            <span class="n">input_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">|</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>   <span class="c1"># pad = 127 if 'hourglass' in opt.arch else 31   此处为按位或，+1后得到2的整数倍（与height及pad实际数值有关）
</span>            <span class="n">input_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">|</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">input_w</span><span class="p">,</span> <span class="n">input_h</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>   <span class="c1"># 仿射变换输入宽高
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1.0</span>    <span class="c1"># 宽高较大者
</span>            <span class="n">input_h</span><span class="p">,</span> <span class="n">input_w</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">input_h</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">input_w</span>   <span class="c1"># 输入宽高
</span>
        <span class="n">flipped</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">split</span> <span class="o">==</span> <span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">:</span>   <span class="c1"># 训练集   # 下面需要使用的是c（仿射变换的中心）、s（仿射变换的缩放倍数）
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">not_rand_crop</span><span class="p">:</span>   <span class="c1"># not self.opt.not_rand_crop默认True
</span>                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>   <span class="c1"># 随机缩放一定倍数
</span>                <span class="n">w_border</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_border</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>    <span class="c1"># 仿射变换使用，不懂为何这样计算？？？
</span>                <span class="n">h_border</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_border</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>    <span class="c1"># 仿射变换使用，不懂为何这样计算？？？
</span>                <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">w_border</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">w_border</span><span class="p">)</span>   <span class="c1"># 随机选一个值
</span>                <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">h_border</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">h_border</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>   <span class="c1"># 下面需要使用的是c（仿射变换的中心）、s（仿射变换的缩放倍数）
</span>                <span class="n">sf</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">scale</span>   <span class="c1"># 0.4
</span>                <span class="n">cf</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">shift</span>   <span class="c1"># 0.1
</span>                <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randn</span><span class="p">()</span><span class="o">*</span><span class="n">cf</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cf</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">cf</span><span class="p">)</span>
                <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randn</span><span class="p">()</span><span class="o">*</span><span class="n">cf</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cf</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">cf</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randn</span><span class="p">()</span><span class="o">*</span><span class="n">sf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sf</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">sf</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">flip</span><span class="p">:</span>   <span class="c1"># 0.5的概率左右翻转图像
</span>                <span class="n">flipped</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">trans_input</span> <span class="o">=</span> <span class="nf">get_affine_transform</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">input_w</span><span class="p">,</span> <span class="n">input_h</span><span class="p">])</span>  <span class="c1"># 得到仿射变换的矩阵
</span>        <span class="n">inp</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">warpAffine</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">trans_input</span><span class="p">,</span> <span class="p">(</span><span class="n">input_w</span><span class="p">,</span> <span class="n">input_h</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>  <span class="c1"># 对图像进行仿射变换
</span>        <span class="n">inp</span> <span class="o">=</span> <span class="p">(</span><span class="n">inp</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span><span class="p">)</span>   <span class="c1"># 图像缩放到0-1之间
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">split</span> <span class="o">==</span> <span class="sh">'</span><span class="s">train</span><span class="sh">'</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">no_color_aug</span><span class="p">:</span> 
            <span class="nf">color_aug</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_data_rng</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_eig_val</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_eig_vec</span><span class="p">)</span>    <span class="c1"># 对图像进行色彩扰动，self._data_rng为初始化种子的state
</span>        <span class="n">inp</span> <span class="o">=</span> <span class="p">(</span><span class="n">inp</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">std</span>   <span class="c1"># 归一化
</span>        <span class="n">inp</span> <span class="o">=</span> <span class="n">inp</span><span class="p">.</span><span class="nf">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>       <span class="c1"># HWC转CHW
</span>
        <span class="n">output_h</span> <span class="o">=</span> <span class="n">input_h</span> <span class="o">//</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">down_ratio</span>    <span class="c1"># down_ratio=4
</span>        <span class="n">output_w</span> <span class="o">=</span> <span class="n">input_w</span> <span class="o">//</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">down_ratio</span>
        <span class="n">num_classes</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">num_classes</span>
        <span class="n">trans_output</span> <span class="o">=</span> <span class="nf">get_affine_transform</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">output_w</span><span class="p">,</span> <span class="n">output_h</span><span class="p">])</span>   <span class="c1"># 输出的仿射变换矩阵，用于变换相应bbox
</span>
        <span class="n">hm</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">output_h</span><span class="p">,</span> <span class="n">output_w</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>   <span class="c1"># 热图数量
</span>        <span class="n">wh</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">max_objs</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>             <span class="c1"># 每个目标的wh（供预测的wh和真实目标的wh计算损失）  max_objs*2
</span>        <span class="n">dense_wh</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">output_h</span><span class="p">,</span> <span class="n">output_w</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># 目标权重矩阵（中心和非中心）
</span>        <span class="n">reg</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">max_objs</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>            <span class="c1"># 每个目标中心的偏移   max_objs*2
</span>        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">max_objs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">int64</span><span class="p">)</span>                 <span class="c1"># 输出特征图上每个目标中心的索引：y*w+hT    max_objs
</span>        <span class="n">reg_mask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">max_objs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>            <span class="c1"># 每个目标的mask：1代表有目标，0代表没目标（默认）   max_objs
</span>        <span class="n">cat_spec_wh</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">max_objs</span><span class="p">,</span> <span class="n">num_classes</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>   <span class="c1"># 每个目标包含label的wh     max_objs*(num_classes*2)
</span>        <span class="n">cat_spec_mask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">max_objs</span><span class="p">,</span> <span class="n">num_classes</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>   <span class="c1"># 每个目标包含label的mask   max_objs*(num_classes*2)
</span>
        <span class="n">draw_gaussian</span> <span class="o">=</span> <span class="n">draw_msra_gaussian</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">mse_loss</span> <span class="k">else</span> <span class="n">draw_umich_gaussian</span>   <span class="c1"># 使用mse 损失，则为draw_msra_gaussian；使用focal loss，则为draw_umich_gaussian
</span>
        <span class="n">gt_det</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_objs</span><span class="p">):</span>  <span class="c1"># 依次遍历每个目标
</span>            <span class="n">ann</span> <span class="o">=</span> <span class="n">anns</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_coco_box_to_bbox</span><span class="p">(</span><span class="n">ann</span><span class="p">[</span><span class="sh">'</span><span class="s">bbox</span><span class="sh">'</span><span class="p">])</span>   <span class="c1"># 得到bbox
</span>            <span class="n">cls_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cat_ids</span><span class="p">[</span><span class="n">ann</span><span class="p">[</span><span class="sh">'</span><span class="s">category_id</span><span class="sh">'</span><span class="p">]])</span>   <span class="c1"># 得到目标类别
</span>            <span class="k">if</span> <span class="n">flipped</span><span class="p">:</span>
                <span class="n">bbox</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="mi">1</span>   <span class="c1"># 水平反转目标信息
</span>            <span class="n">bbox</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nf">affine_transform</span><span class="p">(</span><span class="n">bbox</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">trans_output</span><span class="p">)</span>     <span class="c1"># 计算仿射变换后的xy
</span>            <span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="nf">affine_transform</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">trans_output</span><span class="p">)</span>     <span class="c1"># 计算仿射变换后的wh
</span>            <span class="n">bbox</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">bbox</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">output_w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># 裁剪bbox
</span>            <span class="n">bbox</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">bbox</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">output_h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>             <span class="c1"># 最终目标宽高
</span>            <span class="k">if</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="nf">gaussian_radius</span><span class="p">((</span><span class="n">math</span><span class="p">.</span><span class="nf">ceil</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="n">math</span><span class="p">.</span><span class="nf">ceil</span><span class="p">(</span><span class="n">w</span><span class="p">)))</span>   <span class="c1"># 得到目标的半径？？？
</span>                <span class="n">radius</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="n">radius</span><span class="p">))</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">hm_gauss</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">mse_loss</span> <span class="k">else</span> <span class="n">radius</span>   <span class="c1"># 无hm_gauss，因而opt.mse_loss为False，另外使用Focal loss计算热图的损失
</span>                <span class="n">ct</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># 目标中心
</span>                <span class="n">ct_int</span> <span class="o">=</span> <span class="n">ct</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="nf">draw_gaussian</span><span class="p">(</span><span class="n">hm</span><span class="p">[</span><span class="n">cls_id</span><span class="p">],</span> <span class="n">ct_int</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>  <span class="c1"># 根据目标类别、目标中心、半径画高斯热图
</span>                <span class="n">wh</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">h</span>   <span class="c1"># 第k个目标的wh的值设置为相应目标的宽高
</span>                <span class="n">ind</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_int</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">output_w</span> <span class="o">+</span> <span class="n">ct_int</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># y*w+h，得到第k个ind的值
</span>                <span class="n">reg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span> <span class="o">-</span> <span class="n">ct_int</span>       <span class="c1"># 第k个目标中心的偏移
</span>                <span class="n">reg_mask</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c1"># mask为1，代表有目标
</span>                <span class="n">cat_spec_wh</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">cls_id</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span> <span class="n">cls_id</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">wh</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>   <span class="c1"># 第k个目标包含label的wh的值设置为相应目标的宽高
</span>                <span class="n">cat_spec_mask</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">cls_id</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span> <span class="n">cls_id</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>     <span class="c1"># 第k个目标包含label的mask的值设置为1
</span>                <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">dense_wh</span><span class="p">:</span>    <span class="c1"># 目标中心是否加权（True是加权）
</span>                    <span class="nf">draw_dense_reg</span><span class="p">(</span><span class="n">dense_wh</span><span class="p">,</span> <span class="n">hm</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">ct_int</span><span class="p">,</span> <span class="n">wh</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">radius</span><span class="p">)</span>   <span class="c1"># 更新dense_wh（目标中心和边缘的权重矩阵）
</span>                <span class="n">gt_det</span><span class="p">.</span><span class="nf">append</span><span class="p">([</span><span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ct</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cls_id</span><span class="p">])</span>   <span class="c1"># 实际目标box  [x1,y1,x2,y2]
</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">:</span> <span class="n">inp</span><span class="p">,</span> <span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">:</span> <span class="n">hm</span><span class="p">,</span> <span class="sh">'</span><span class="s">reg_mask</span><span class="sh">'</span><span class="p">:</span> <span class="n">reg_mask</span><span class="p">,</span> <span class="sh">'</span><span class="s">ind</span><span class="sh">'</span><span class="p">:</span> <span class="n">ind</span><span class="p">,</span> <span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">:</span> <span class="n">wh</span><span class="p">}</span>  <span class="c1"># 返回值（图像，热图，是否有目标的mask，每个目标中心的索引，每个目标的wh）
</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">dense_wh</span><span class="p">:</span>
            <span class="n">hm_a</span> <span class="o">=</span> <span class="n">hm</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>   <span class="c1"># 热图最大值
</span>            <span class="n">dense_wh_mask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">([</span><span class="n">hm_a</span><span class="p">,</span> <span class="n">hm_a</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 2*output_h*output_h
</span>            <span class="n">ret</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">'</span><span class="s">dense_wh</span><span class="sh">'</span><span class="p">:</span> <span class="n">dense_wh</span><span class="p">,</span> <span class="sh">'</span><span class="s">dense_wh_mask</span><span class="sh">'</span><span class="p">:</span> <span class="n">dense_wh_mask</span><span class="p">})</span>  <span class="c1"># 更新相关返回值
</span>            <span class="k">del</span> <span class="n">ret</span><span class="p">[</span><span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">cat_spec_wh</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">'</span><span class="s">cat_spec_wh</span><span class="sh">'</span><span class="p">:</span> <span class="n">cat_spec_wh</span><span class="p">,</span> <span class="sh">'</span><span class="s">cat_spec_mask</span><span class="sh">'</span><span class="p">:</span> <span class="n">cat_spec_mask</span><span class="p">})</span>
            <span class="k">del</span> <span class="n">ret</span><span class="p">[</span><span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">reg_offset</span><span class="p">:</span>  <span class="c1"># 更新目标中心的偏移offset
</span>            <span class="n">ret</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">'</span><span class="s">reg</span><span class="sh">'</span><span class="p">:</span> <span class="n">reg</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">split</span> <span class="o">==</span> <span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">gt_det</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">gt_det</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">gt_det</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">c</span><span class="sh">'</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="sh">'</span><span class="s">s</span><span class="sh">'</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span> <span class="sh">'</span><span class="s">gt_det</span><span class="sh">'</span><span class="p">:</span> <span class="n">gt_det</span><span class="p">,</span> <span class="sh">'</span><span class="s">img_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">img_id</span><span class="p">}</span>
            <span class="n">ret</span><span class="p">[</span><span class="sh">'</span><span class="s">meta</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
        
        <span class="k">return</span> <span class="n">ret</span>
</pre></table></code></div></div></details><h4 id="p463-color_aug">P4.6.3 color_aug</h4><p>位于src/lib/utils/image.py。</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">grayscale</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">lighting_</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">alphastd</span><span class="p">,</span> <span class="n">eigval</span><span class="p">,</span> <span class="n">eigvec</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">data_rng</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">alphastd</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">image</span> <span class="o">+=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">eigvec</span><span class="p">,</span> <span class="n">eigval</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span>   <span class="c1"># 不懂这个为什么，光照？？？
</span>
<span class="k">def</span> <span class="nf">blend_</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">):</span>   <span class="c1"># 对图像加权融合
</span>    <span class="n">image1</span> <span class="o">*=</span> <span class="n">alpha</span>
    <span class="n">image2</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>
    <span class="n">image1</span> <span class="o">+=</span> <span class="n">image2</span>

<span class="k">def</span> <span class="nf">saturation_</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">gs_mean</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">data_rng</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="n">var</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>
    <span class="nf">blend_</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">gs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">None</span><span class="p">])</span>  <span class="c1"># 对图像加权融合
</span>
<span class="k">def</span> <span class="nf">brightness_</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">gs_mean</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">data_rng</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="n">var</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">*=</span> <span class="n">alpha</span>   <span class="c1"># 直接乘系数
</span>
<span class="k">def</span> <span class="nf">contrast_</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">gs_mean</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">data_rng</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="n">var</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>
    <span class="nf">blend_</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">gs_mean</span><span class="p">)</span>   <span class="c1"># 对图像加权融合
</span>
<span class="k">def</span> <span class="nf">color_aug</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">eig_val</span><span class="p">,</span> <span class="n">eig_vec</span><span class="p">):</span>  <span class="c1"># _data_rng为初始化种子的state
</span>    <span class="n">functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">brightness_</span><span class="p">,</span> <span class="n">contrast_</span><span class="p">,</span> <span class="n">saturation_</span><span class="p">]</span>   <span class="c1"># 亮度，对比度，饱和度
</span>    <span class="n">random</span><span class="p">.</span><span class="nf">shuffle</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="nf">grayscale</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">gs_mean</span> <span class="o">=</span> <span class="n">gs</span><span class="p">.</span><span class="nf">mean</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
        <span class="nf">f</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">gs_mean</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
    <span class="nf">lighting_</span><span class="p">(</span><span class="n">data_rng</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">eig_val</span><span class="p">,</span> <span class="n">eig_vec</span><span class="p">)</span>   <span class="c1"># 调整亮度
</span></pre></table></code></div></div></details><h4 id="p464-draw_msra_gaussian">P4.6.4 draw_msra_gaussian</h4><p>位于src/lib/utils/image.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">draw_msra_gaussian</span><span class="p">(</span><span class="n">heatmap</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>   <span class="c1"># sigma为radius
</span>    <span class="n">tmp_size</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="n">mu_x</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">mu_y</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">heatmap</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ul</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">mu_x</span> <span class="o">-</span> <span class="n">tmp_size</span><span class="p">),</span> <span class="nf">int</span><span class="p">(</span><span class="n">mu_y</span> <span class="o">-</span> <span class="n">tmp_size</span><span class="p">)]</span>   <span class="c1"># 左上角
</span>    <span class="n">br</span> <span class="o">=</span> <span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">mu_x</span> <span class="o">+</span> <span class="n">tmp_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nf">int</span><span class="p">(</span><span class="n">mu_y</span> <span class="o">+</span> <span class="n">tmp_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>   <span class="c1"># 右下角
</span>    <span class="k">if</span> <span class="n">ul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">h</span> <span class="ow">or</span> <span class="n">ul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">w</span> <span class="ow">or</span> <span class="n">br</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">br</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">heatmap</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">tmp_size</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">np</span><span class="p">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>   <span class="c1"># 临时高斯分布g的中心
</span>    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>   <span class="c1"># 高斯分布的临时变量g
</span>    <span class="n">g_x</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">ul</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">min</span><span class="p">(</span><span class="n">br</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span> <span class="o">-</span> <span class="n">ul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># -ul[0]是减去各自的偏移，得到g上的xy坐标（各自的起点和终点）  
</span>    <span class="n">g_y</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">ul</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nf">min</span><span class="p">(</span><span class="n">br</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">ul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">img_x</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ul</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">min</span><span class="p">(</span><span class="n">br</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h</span><span class="p">)</span>     <span class="c1"># 热图上额xy坐标（各自的起点和终点）
</span>    <span class="n">img_y</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ul</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nf">min</span><span class="p">(</span><span class="n">br</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">heatmap</span><span class="p">[</span><span class="n">img_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">img_y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">img_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">maximum</span><span class="p">(</span><span class="n">heatmap</span><span class="p">[</span><span class="n">img_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">img_y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">img_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">g</span><span class="p">[</span><span class="n">g_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">g_y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">g_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">g_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>   <span class="c1"># 得到以center为中心高斯分布的热图
</span>    <span class="k">return</span> <span class="n">heatmap</span>
</pre></table></code></div></div></details><h4 id="p465-draw_umich_gaussian">P4.6.5 draw_umich_gaussian</h4><p>位于src/lib/utils/image.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">gaussian2D</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ss</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">]</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">ogrid</span><span class="p">[</span><span class="o">-</span><span class="n">m</span><span class="p">:</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># y：k1*1， x：1：k2    和meshgrid的区别是，meshgrid两个返回值都是k1*k2的
</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">))</span>   <span class="c1"># 得到高斯分布的矩阵   k1*k2
</span>    <span class="n">h</span><span class="p">[</span><span class="n">h</span> <span class="o">&lt;</span> <span class="n">np</span><span class="p">.</span><span class="nf">finfo</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">dtype</span><span class="p">).</span><span class="n">eps</span> <span class="o">*</span> <span class="n">h</span><span class="p">.</span><span class="nf">max</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># 将太小的设置为0
</span>    <span class="k">return</span> <span class="n">h</span>

<span class="k">def</span> <span class="nf">draw_umich_gaussian</span><span class="p">(</span><span class="n">heatmap</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">diameter</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">gaussian</span> <span class="o">=</span> <span class="nf">gaussian2D</span><span class="p">((</span><span class="n">diameter</span><span class="p">,</span> <span class="n">diameter</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="n">diameter</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">int</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">radius</span><span class="p">),</span> <span class="nf">min</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">radius</span><span class="p">),</span> <span class="nf">min</span><span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">masked_heatmap</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">[</span><span class="n">y</span> <span class="o">-</span> <span class="n">top</span><span class="p">:</span><span class="n">y</span> <span class="o">+</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">left</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="n">right</span><span class="p">]</span>
    <span class="n">masked_gaussian</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">[</span><span class="n">radius</span> <span class="o">-</span> <span class="n">top</span><span class="p">:</span><span class="n">radius</span> <span class="o">+</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">left</span><span class="p">:</span><span class="n">radius</span> <span class="o">+</span> <span class="n">right</span><span class="p">]</span>
    <span class="k">if</span> <span class="nf">min</span><span class="p">(</span><span class="n">masked_gaussian</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nf">min</span><span class="p">(</span><span class="n">masked_heatmap</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># TODO debug
</span>        <span class="n">np</span><span class="p">.</span><span class="nf">maximum</span><span class="p">(</span><span class="n">masked_heatmap</span><span class="p">,</span> <span class="n">masked_gaussian</span> <span class="o">*</span> <span class="n">k</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">masked_heatmap</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">heatmap</span>
</pre></table></code></div></div></details><h4 id="p466-draw_dense_reg">P4.6.6 draw_dense_reg</h4><p>位于src/lib/utils/image.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">draw_dense_reg</span><span class="p">(</span><span class="n">regmap</span><span class="p">,</span> <span class="n">heatmap</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">is_offset</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">diameter</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">gaussian</span> <span class="o">=</span> <span class="nf">gaussian2D</span><span class="p">((</span><span class="n">diameter</span><span class="p">,</span> <span class="n">diameter</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="n">diameter</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>   <span class="c1"># 得到高斯分布的矩阵 
</span>    <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># value为第k个目标的wh（[2]的向量）    2*1*1
</span>    <span class="n">dim</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># 2
</span>    <span class="n">reg</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">diameter</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">diameter</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="n">value</span>   <span class="c1"># 第k个目标的宽高的mask
</span>    <span class="k">if</span> <span class="n">is_offset</span> <span class="ow">and</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>   <span class="c1"># 默认不执行
</span>        <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">diameter</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">radius</span>
        <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nf">int</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>    <span class="c1"># heatmap为height*width的矩阵（原始热图不同目标取最大值）
</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">radius</span><span class="p">),</span> <span class="nf">min</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># 以center为中心，radius为半径的框（圆转换成正方形）的边界
</span>    <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">radius</span><span class="p">),</span> <span class="nf">min</span><span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 以center为中心，radius为半径的框（圆转换成正方形）的边界
</span>
    <span class="n">masked_heatmap</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">[</span><span class="n">y</span> <span class="o">-</span> <span class="n">top</span><span class="p">:</span><span class="n">y</span> <span class="o">+</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">left</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="n">right</span><span class="p">]</span>   <span class="c1"># heatmap上该区域的mask
</span>    <span class="n">masked_regmap</span> <span class="o">=</span> <span class="n">regmap</span><span class="p">[:,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">top</span><span class="p">:</span><span class="n">y</span> <span class="o">+</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">left</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="n">right</span><span class="p">]</span>  <span class="c1"># regmap上该区域的mask
</span>    <span class="n">masked_gaussian</span> <span class="o">=</span> <span class="n">gaussian</span><span class="p">[</span><span class="n">radius</span> <span class="o">-</span> <span class="n">top</span><span class="p">:</span><span class="n">radius</span> <span class="o">+</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">left</span><span class="p">:</span><span class="n">radius</span> <span class="o">+</span> <span class="n">right</span><span class="p">]</span>   <span class="c1"># gaussian上该区域的mask
</span>    <span class="n">masked_reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[:,</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">top</span><span class="p">:</span><span class="n">radius</span> <span class="o">+</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">left</span><span class="p">:</span><span class="n">radius</span> <span class="o">+</span> <span class="n">right</span><span class="p">]</span>          <span class="c1"># reg上该区域的mask
</span>    <span class="k">if</span> <span class="nf">min</span><span class="p">(</span><span class="n">masked_gaussian</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nf">min</span><span class="p">(</span><span class="n">masked_heatmap</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># TODO debug
</span>        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">masked_gaussian</span> <span class="o">&gt;=</span> <span class="n">masked_heatmap</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked_gaussian</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">masked_gaussian</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>   <span class="c1"># 目标区域目标权重&gt;热图权重的索引
</span>        <span class="n">masked_regmap</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">idx</span><span class="p">)</span> <span class="o">*</span> <span class="n">masked_regmap</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">masked_reg</span>   <span class="c1"># 目标区域目标权重&lt;热图的位置，使用原来的权重；否则使用新的权重？？？
</span>    <span class="n">regmap</span><span class="p">[:,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">top</span><span class="p">:</span><span class="n">y</span> <span class="o">+</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">left</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="n">right</span><span class="p">]</span> <span class="o">=</span> <span class="n">masked_regmap</span>   <span class="c1"># 更新相应位置的权重
</span>    <span class="k">return</span> <span class="n">regmap</span>
</pre></table></code></div></div></details><h4 id="p467-gaussian_radius">P4.6.7 gaussian_radius</h4><p>位于src/lib/utils/image.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">gaussian_radius</span><span class="p">(</span><span class="n">det_size</span><span class="p">,</span> <span class="n">min_overlap</span><span class="o">=</span><span class="mf">0.7</span><span class="p">):</span>   <span class="c1"># 得到目标的半径？？？不清楚下面计算步骤
</span>    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">det_size</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">width</span><span class="p">)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">min_overlap</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">min_overlap</span><span class="p">)</span>
    <span class="n">sq1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">b1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">c1</span><span class="p">)</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="n">b1</span> <span class="o">+</span> <span class="n">sq1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">a2</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">width</span><span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">min_overlap</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span>
    <span class="n">sq2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">b2</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">c2</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="p">(</span><span class="n">b2</span> <span class="o">+</span> <span class="n">sq2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">a3</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">min_overlap</span>
    <span class="n">b3</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">min_overlap</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">width</span><span class="p">)</span>
    <span class="n">c3</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_overlap</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span>
    <span class="n">sq3</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">b3</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">c3</span><span class="p">)</span>
    <span class="n">r3</span> <span class="o">=</span> <span class="p">(</span><span class="n">b3</span> <span class="o">+</span> <span class="n">sq3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="nf">min</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span><span class="p">)</span>
</pre></table></code></div></div></details><h3 id="p47-训练迭代器train_factory">P4.7 训练迭代器train_factory</h3><p>位于src/lib/trains/train_factory.py。</p><p>4.7.1 train_factory</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">train_factory</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">exdet</span><span class="sh">'</span><span class="p">:</span> <span class="n">ExdetTrainer</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">ddd</span><span class="sh">'</span><span class="p">:</span> <span class="n">DddTrainer</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">ctdet</span><span class="sh">'</span><span class="p">:</span> <span class="n">CtdetTrainer</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">multi_pose</span><span class="sh">'</span><span class="p">:</span> <span class="n">MultiPoseTrainer</span><span class="p">,</span>
<span class="p">}</span>
</pre></table></code></div></div></details><h4 id="p472-ctdettrainer">P4.7.2 CtdetTrainer</h4><p>位于src/lib/trains/ctdet.py。</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">CtdetTrainer</span><span class="p">(</span><span class="n">BaseTrainer</span><span class="p">):</span>  <span class="c1"># 继承自BaseTrainer，里面包含相应的训练代码（前向，loss反向等）
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">CtdetTrainer</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_losses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
        <span class="n">loss_states</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">loss</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">hm_loss</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">wh_loss</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">off_loss</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="nc">CtdetLoss</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss_states</span><span class="p">,</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">iter_id</span><span class="p">):</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">reg</span><span class="sh">'</span><span class="p">]</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">reg_offset</span> <span class="k">else</span> <span class="bp">None</span>   <span class="c1"># 目标中心偏移的输出
</span>        <span class="n">dets</span> <span class="o">=</span> <span class="nf">ctdet_decode</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">],</span> <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">cat_spec_wh</span><span class="o">=</span><span class="n">opt</span><span class="p">.</span><span class="n">cat_spec_wh</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">opt</span><span class="p">.</span><span class="n">K</span><span class="p">)</span>  <span class="c1"># k为最多检测的目标数量
</span>        <span class="n">dets</span> <span class="o">=</span> <span class="n">dets</span><span class="p">.</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">().</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dets</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">dets</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">*=</span> <span class="n">opt</span><span class="p">.</span><span class="n">down_ratio</span>
        <span class="n">dets_gt</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">meta</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">gt_det</span><span class="sh">'</span><span class="p">].</span><span class="nf">numpy</span><span class="p">().</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dets</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">dets_gt</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">*=</span> <span class="n">opt</span><span class="p">.</span><span class="n">down_ratio</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">debugger</span> <span class="o">=</span> <span class="nc">Debugger</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">opt</span><span class="p">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">ipynb</span><span class="o">=</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">debug</span> <span class="o">==</span> <span class="mi">3</span><span class="p">),</span> <span class="n">theme</span><span class="o">=</span><span class="n">opt</span><span class="p">.</span><span class="n">debugger_theme</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">().</span><span class="nf">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">clip</span><span class="p">(((</span><span class="n">img</span> <span class="o">*</span> <span class="n">opt</span><span class="p">.</span><span class="n">std</span> <span class="o">+</span> <span class="n">opt</span><span class="p">.</span><span class="n">mean</span><span class="p">)</span> <span class="o">*</span> <span class="mf">255.</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">debugger</span><span class="p">.</span><span class="nf">gen_colormap</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">())</span>
            <span class="n">gt</span> <span class="o">=</span> <span class="n">debugger</span><span class="p">.</span><span class="nf">gen_colormap</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">())</span>
            <span class="n">debugger</span><span class="p">.</span><span class="nf">add_blend_img</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="sh">'</span><span class="s">pred_hm</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">debugger</span><span class="p">.</span><span class="nf">add_blend_img</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">gt</span><span class="p">,</span> <span class="sh">'</span><span class="s">gt_hm</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">debugger</span><span class="p">.</span><span class="nf">add_img</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img_id</span><span class="o">=</span><span class="sh">'</span><span class="s">out_pred</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">opt</span><span class="p">.</span><span class="n">center_thresh</span><span class="p">:</span>
                    <span class="n">debugger</span><span class="p">.</span><span class="nf">add_coco_bbox</span><span class="p">(</span><span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">img_id</span><span class="o">=</span><span class="sh">'</span><span class="s">out_pred</span><span class="sh">'</span><span class="p">)</span>

            <span class="n">debugger</span><span class="p">.</span><span class="nf">add_img</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img_id</span><span class="o">=</span><span class="sh">'</span><span class="s">out_gt</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">dets_gt</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">dets_gt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">opt</span><span class="p">.</span><span class="n">center_thresh</span><span class="p">:</span>
                    <span class="n">debugger</span><span class="p">.</span><span class="nf">add_coco_bbox</span><span class="p">(</span><span class="n">dets_gt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">dets_gt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dets_gt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">img_id</span><span class="o">=</span><span class="sh">'</span><span class="s">out_gt</span><span class="sh">'</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">debug</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">debugger</span><span class="p">.</span><span class="nf">save_all_imgs</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">debug_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sh">'</span><span class="s">{}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">iter_id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">debugger</span><span class="p">.</span><span class="nf">show_all_imgs</span><span class="p">(</span><span class="n">pause</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_result</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">reg</span><span class="sh">'</span><span class="p">]</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">reg_offset</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">dets</span> <span class="o">=</span> <span class="nf">ctdet_decode</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">],</span> <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">cat_spec_wh</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">cat_spec_wh</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">K</span><span class="p">)</span>
        <span class="n">dets</span> <span class="o">=</span> <span class="n">dets</span><span class="p">.</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">().</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dets</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">dets_out</span> <span class="o">=</span> <span class="nf">ctdet_post_process</span><span class="p">(</span>
            <span class="n">dets</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">meta</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">c</span><span class="sh">'</span><span class="p">].</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">(),</span>
            <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">meta</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">s</span><span class="sh">'</span><span class="p">].</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">(),</span>
            <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">results</span><span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">meta</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">img_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dets_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Hello, World!</span><span class="sh">"</span><span class="p">);</span>
</pre></table></code></div></div></details><h4 id="p473-basetrainer">P4.7.3 BaseTrainer</h4><p>CtdetTrainer继承自BaseTrainer。BaseTrainer位于src/lib/trains/base_trainer.py。</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ModelWithLoss</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">ModelWithLoss</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">model</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">])</span>  <span class="c1"># 得到模型输出
</span>        <span class="n">loss</span><span class="p">,</span> <span class="n">loss_stats</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>  <span class="c1"># 计算模型损失
</span>        <span class="k">return</span> <span class="n">outputs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">loss</span><span class="p">,</span> <span class="n">loss_stats</span>   <span class="c1"># 返回模型输出，总损失，各自损失
</span>
<span class="k">class</span> <span class="nc">BaseTrainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">opt</span>
        <span class="n">self</span><span class="p">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span>
        <span class="n">self</span><span class="p">.</span><span class="n">loss_stats</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_losses</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>  <span class="c1"># 派生类（如CtdetTrainer）有相应的实现
</span>        <span class="n">self</span><span class="p">.</span><span class="n">model_with_loss</span> <span class="o">=</span> <span class="nc">ModelWithLoss</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">loss</span><span class="p">)</span>  <span class="c1"># 得到模型输出，总损失，各自损失
</span>
    <span class="k">def</span> <span class="nf">set_device</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">gpus</span><span class="p">,</span> <span class="n">chunk_sizes</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model_with_loss</span> <span class="o">=</span> <span class="nc">DataParallel</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model_with_loss</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="n">gpus</span><span class="p">,</span> <span class="n">chunk_sizes</span><span class="o">=</span><span class="n">chunk_sizes</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">model_with_loss</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model_with_loss</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="nf">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">):</span>
                    <span class="n">state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_epoch</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">):</span>
        <span class="n">model_with_loss</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model_with_loss</span>   <span class="c1"># 得到模型输出，总损失，各自损失
</span>        <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">:</span>  <span class="c1"># 训练阶段
</span>            <span class="n">model_with_loss</span><span class="p">.</span><span class="nf">train</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># 测试阶段
</span>            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">gpus</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">model_with_loss</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model_with_loss</span><span class="p">.</span><span class="n">module</span>
            <span class="n">model_with_loss</span><span class="p">.</span><span class="nf">eval</span><span class="p">()</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">empty_cache</span><span class="p">()</span>

        <span class="n">opt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data_time</span><span class="p">,</span> <span class="n">batch_time</span> <span class="o">=</span> <span class="nc">AverageMeter</span><span class="p">(),</span> <span class="nc">AverageMeter</span><span class="p">()</span>
        <span class="n">avg_loss_stats</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="p">:</span> <span class="nc">AverageMeter</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">loss_stats</span><span class="p">}</span>
        <span class="n">num_iters</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_iters</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_iters</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="nc">Bar</span><span class="p">(</span><span class="sh">'</span><span class="s">{}/{}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">exp_id</span><span class="p">),</span> <span class="nb">max</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iter_id</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">iter_id</span> <span class="o">&gt;=</span> <span class="n">num_iters</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">data_time</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">end</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="sh">'</span><span class="s">meta</span><span class="sh">'</span><span class="p">:</span>
                    <span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">opt</span><span class="p">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">loss_stats</span> <span class="o">=</span> <span class="nf">model_with_loss</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>   <span class="c1"># 得到实际的模型输出，总损失，各自损失
</span>            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="p">.</span><span class="nf">mean</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="nf">zero_grad</span><span class="p">()</span>
                <span class="n">loss</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span>
                <span class="n">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="nf">step</span><span class="p">()</span>
            <span class="n">batch_time</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">end</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

            <span class="n">Bar</span><span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="sh">'</span><span class="s">{phase}: [{0}][{1}/{2}]|Tot: {total:} |ETA: {eta:} </span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">iter_id</span><span class="p">,</span> <span class="n">num_iters</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="n">phase</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">bar</span><span class="p">.</span><span class="n">elapsed_td</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">bar</span><span class="p">.</span><span class="n">eta_td</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">avg_loss_stats</span><span class="p">:</span>
                <span class="n">avg_loss_stats</span><span class="p">[</span><span class="n">l</span><span class="p">].</span><span class="nf">update</span><span class="p">(</span><span class="n">loss_stats</span><span class="p">[</span><span class="n">l</span><span class="p">].</span><span class="nf">mean</span><span class="p">().</span><span class="nf">item</span><span class="p">(),</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">].</span><span class="nf">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">Bar</span><span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">Bar</span><span class="p">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="sh">'</span><span class="s">|{} {:.4f} </span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">avg_loss_stats</span><span class="p">[</span><span class="n">l</span><span class="p">].</span><span class="n">avg</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">.</span><span class="n">hide_data_time</span><span class="p">:</span>
                <span class="n">Bar</span><span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">Bar</span><span class="p">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="sh">'</span><span class="s">|Data {dt.val:.3f}s({dt.avg:.3f}s) | Net {bt.avg:.3f}s</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="n">data_time</span><span class="p">,</span> <span class="n">bt</span><span class="o">=</span><span class="n">batch_time</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">print_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iter_id</span> <span class="o">%</span> <span class="n">opt</span><span class="p">.</span><span class="n">print_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">{}/{}| {}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">exp_id</span><span class="p">,</span> <span class="n">Bar</span><span class="p">.</span><span class="n">suffix</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bar</span><span class="p">.</span><span class="nf">next</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">iter_id</span><span class="p">)</span>  <span class="c1"># 调试结果
</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">test</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">save_result</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">output</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">loss_stats</span>

        <span class="n">bar</span><span class="p">.</span><span class="nf">finish</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">.</span><span class="n">avg</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">avg_loss_stats</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
        <span class="n">ret</span><span class="p">[</span><span class="sh">'</span><span class="s">time</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">bar</span><span class="p">.</span><span class="n">elapsed_td</span><span class="p">.</span><span class="nf">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mf">60.</span>
        <span class="k">return</span> <span class="n">ret</span><span class="p">,</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">iter_id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>   <span class="c1"># 派生类（如CtdetTrainer）有相应的实现
</span>
    <span class="k">def</span> <span class="nf">save_result</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_get_losses</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>  <span class="c1"># 派生类（如CtdetTrainer）有相应的实现
</span>
    <span class="k">def</span> <span class="nf">val</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_epoch</span><span class="p">(</span><span class="sh">'</span><span class="s">val</span><span class="sh">'</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">run_epoch</span><span class="p">(</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Hello, World!</span><span class="sh">"</span><span class="p">);</span>
</pre></table></code></div></div></details><h4 id="p474-后处理ctdet_post_process">P4.7.4 后处理ctdet_post_process</h4><p>位于src/lib/utils/post_process.py。</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">ctdet_post_process</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
    <span class="c1"># dets: batch x max_dets x dim
</span>    <span class="c1"># return 1-based class det dict
</span>    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">dets</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>   <span class="c1"># 依次遍历batch中每个结果
</span>        <span class="n">top_preds</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nf">transform_preds</span><span class="p">(</span><span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>  <span class="c1"># 得到预测目标对应的原始图像上的xy坐标
</span>        <span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nf">transform_preds</span><span class="p">(</span><span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span> <span class="c1"># 得到预测目标对应的原始图像上的wh
</span>        <span class="n">classes</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># 得到预测的类别
</span>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>   <span class="c1"># 得到每个类别的预测信息（bbox、分值），其中0为背景
</span>            <span class="n">inds</span> <span class="o">=</span> <span class="p">(</span><span class="n">classes</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span>
            <span class="n">top_preds</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">([</span><span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">tolist</span><span class="p">()</span>   <span class="c1"># 当前结果转成list（后面还会转成np。。。）
</span>        <span class="n">ret</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">top_preds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>  <span class="c1"># 得到当前batch中每个图像各类别的预测信息（bbox、分值）
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Hello, World!</span><span class="sh">"</span><span class="p">);</span>
</pre></table></code></div></div></details><h4 id="p475-transform_preds">P4.7.5 transform_preds</h4><p>ctdet_post_process调用transform_preds，其位于src/lib/utils/image.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">transform_preds</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">output_size</span><span class="p">):</span>
    <span class="n">target_coords</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">coords</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="nf">get_affine_transform</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># 得到目标矩阵向原始矩阵的仿射变换矩阵
</span>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">coords</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">target_coords</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nf">affine_transform</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">trans</span><span class="p">)</span>  <span class="c1"># 计算仿射变换后的坐标，得到预测目标对应的原始图像上的坐标
</span>    <span class="k">return</span> <span class="n">target_coords</span>

<span class="k">def</span> <span class="nf">get_affine_transform</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">inv</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>   <span class="c1"># 得到仿射变换矩阵
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">scale</span><span class="p">,</span> <span class="n">scale</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">scale_tmp</span> <span class="o">=</span> <span class="n">scale</span>
    <span class="n">src_w</span> <span class="o">=</span> <span class="n">scale_tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dst_w</span> <span class="o">=</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dst_h</span> <span class="o">=</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">rot_rad</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rot</span> <span class="o">/</span> <span class="mi">180</span>
    <span class="n">src_dir</span> <span class="o">=</span> <span class="nf">get_dir</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">src_w</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">rot_rad</span><span class="p">)</span>
    <span class="n">dst_dir</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">dst_w</span> <span class="o">*</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">src</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">center</span> <span class="o">+</span> <span class="n">scale_tmp</span> <span class="o">*</span> <span class="n">shift</span>
    <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">center</span> <span class="o">+</span> <span class="n">src_dir</span> <span class="o">+</span> <span class="n">scale_tmp</span> <span class="o">*</span> <span class="n">shift</span>
    <span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dst_w</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">dst_h</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">dst_w</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">dst_h</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="n">dst_dir</span>

    <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="nf">get_3rd_point</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">dst</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="nf">get_3rd_point</span><span class="p">(</span><span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dst</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

    <span class="k">if</span> <span class="n">inv</span><span class="p">:</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">getAffineTransform</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">float32</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">float32</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>   <span class="c1"># 目标矩阵向原始矩阵的仿射变换矩阵
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">getAffineTransform</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">float32</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">float32</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span>   <span class="c1"># 原始矩阵向目标矩阵的仿射变换矩阵
</span>
    <span class="k">return</span> <span class="n">trans</span>

<span class="k">def</span> <span class="nf">affine_transform</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>   <span class="c1"># 计算仿射变换后的坐标
</span>    <span class="n">new_pt</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">).</span><span class="n">T</span>
    <span class="n">new_pt</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">new_pt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_pt</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_3rd_point</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">direct</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">b</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="o">-</span><span class="n">direct</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">direct</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_dir</span><span class="p">(</span><span class="n">src_point</span><span class="p">,</span> <span class="n">rot_rad</span><span class="p">):</span>
    <span class="n">sn</span><span class="p">,</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">rot_rad</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">rot_rad</span><span class="p">)</span>

    <span class="n">src_result</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">src_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cs</span> <span class="o">-</span> <span class="n">src_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sn</span>
    <span class="n">src_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sn</span> <span class="o">+</span> <span class="n">src_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cs</span>

    <span class="k">return</span> <span class="n">src_result</span>
</pre></table></code></div></div></details><h4 id="p476-ctdet_decode">P4.7.6 ctdet_decode</h4><p>位于src/lib/models/decode.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_nms</span><span class="p">(</span><span class="n">heat</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">kernel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="n">hmax</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="nf">max_pool2d</span><span class="p">(</span><span class="n">heat</span><span class="p">,</span> <span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">kernel</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">pad</span><span class="p">)</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="p">(</span><span class="n">hmax</span> <span class="o">==</span> <span class="n">heat</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>  <span class="c1"># 热图和对热图maxpool之后的值相等的点，是局部极大值点。
</span>    <span class="k">return</span> <span class="n">heat</span> <span class="o">*</span> <span class="n">keep</span>   <span class="c1"># 得到极大值点矩阵
</span>
<span class="k">def</span> <span class="nf">_topk</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">40</span><span class="p">):</span>
    <span class="n">batch</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">scores</span><span class="p">.</span><span class="nf">size</span><span class="p">()</span>

    <span class="n">topk_scores</span><span class="p">,</span> <span class="n">topk_inds</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">topk</span><span class="p">(</span><span class="n">scores</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">K</span><span class="p">)</span>   <span class="c1"># 得到当前batch中不同通道的总共K个极值点，用于得到每个类别极值点（即目标中心）的坐标  b*C*K
</span>
    <span class="n">topk_inds</span> <span class="o">=</span> <span class="n">topk_inds</span> <span class="o">%</span> <span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>       <span class="c1"># 每个类别极值点的yx坐标  b*C*K
</span>    <span class="n">topk_ys</span> <span class="o">=</span> <span class="p">(</span><span class="n">topk_inds</span> <span class="o">/</span> <span class="n">width</span><span class="p">).</span><span class="nf">int</span><span class="p">().</span><span class="nf">float</span><span class="p">()</span>    <span class="c1"># b*C*K
</span>    <span class="n">topk_xs</span> <span class="o">=</span> <span class="p">(</span><span class="n">topk_inds</span> <span class="o">%</span> <span class="n">width</span><span class="p">).</span><span class="nf">int</span><span class="p">().</span><span class="nf">float</span><span class="p">()</span>    <span class="c1"># b*C*K
</span>
    <span class="n">topk_score</span><span class="p">,</span> <span class="n">topk_ind</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">topk</span><span class="p">(</span><span class="n">topk_scores</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">K</span><span class="p">)</span>   <span class="c1"># 用于得到极值点（即目标）的得分及类别索引  b*K
</span>    <span class="n">topk_clses</span> <span class="o">=</span> <span class="p">(</span><span class="n">topk_ind</span> <span class="o">/</span> <span class="n">K</span><span class="p">).</span><span class="nf">int</span><span class="p">()</span>     <span class="c1">#  极值点（即目标）的类别
</span>
    <span class="n">topk_inds</span> <span class="o">=</span> <span class="nf">_gather_feat</span><span class="p">(</span><span class="n">topk_inds</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">topk_ind</span><span class="p">).</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>   <span class="c1"># _gather_feat得到ind指定的点的channel上的特征，此处得到前k个目标的索引
</span>    <span class="n">topk_ys</span> <span class="o">=</span> <span class="nf">_gather_feat</span><span class="p">(</span><span class="n">topk_ys</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">topk_ind</span><span class="p">).</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>    <span class="c1"># 得到前k个目标的y坐标
</span>    <span class="n">topk_xs</span> <span class="o">=</span> <span class="nf">_gather_feat</span><span class="p">(</span><span class="n">topk_xs</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">topk_ind</span><span class="p">).</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>   <span class="c1"># 得到前k个目标的x坐标
</span>
    <span class="k">return</span> <span class="n">topk_score</span><span class="p">,</span> <span class="n">topk_inds</span><span class="p">,</span> <span class="n">topk_clses</span><span class="p">,</span> <span class="n">topk_ys</span><span class="p">,</span> <span class="n">topk_xs</span>   <span class="c1"># 分值最高的前k个分值，对应的索引(w*i+j)，对应的类别，对应的y坐标，对应的x坐标
</span>
<span class="k">def</span> <span class="nf">ctdet_decode</span><span class="p">(</span><span class="n">heat</span><span class="p">,</span> <span class="n">wh</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cat_spec_wh</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">batch</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">heat</span><span class="p">.</span><span class="nf">size</span><span class="p">()</span>

    <span class="c1"># heat = torch.sigmoid(heat)
</span>    <span class="c1"># perform nms on heatmaps
</span>    <span class="n">heat</span> <span class="o">=</span> <span class="nf">_nms</span><span class="p">(</span><span class="n">heat</span><span class="p">)</span>   <span class="c1"># 得到极大值点矩阵（和热图shape一样）
</span>
    <span class="n">scores</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">clses</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="nf">_topk</span><span class="p">(</span><span class="n">heat</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>    <span class="c1"># 分值最高的前k个分值，对应的索引(w*i+j)，对应的类别，对应的y坐标，对应的x坐标
</span>    <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="nf">_transpose_and_gather_feat</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">inds</span><span class="p">)</span>   <span class="c1"># 得到当前batch中每个feat相应索引处的2维特征，此处得到前k个目标预测坐标的偏移
</span>        <span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">xs</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">reg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>    <span class="c1"># 极值点的整数坐标+预测偏移，得到目标的预测坐标的中心
</span>        <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">reg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">xs</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="n">wh</span> <span class="o">=</span> <span class="nf">_transpose_and_gather_feat</span><span class="p">(</span><span class="n">wh</span><span class="p">,</span> <span class="n">inds</span><span class="p">)</span>   <span class="c1"># 得到预测的目标宽高
</span>    <span class="k">if</span> <span class="n">cat_spec_wh</span><span class="p">:</span>
        <span class="n">wh</span> <span class="o">=</span> <span class="n">wh</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">clses_ind</span> <span class="o">=</span> <span class="n">clses</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">expand</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nf">long</span><span class="p">()</span>
        <span class="n">wh</span> <span class="o">=</span> <span class="n">wh</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">clses_ind</span><span class="p">).</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wh</span> <span class="o">=</span> <span class="n">wh</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">clses</span> <span class="o">=</span> <span class="n">clses</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">([</span><span class="n">xs</span> <span class="o">-</span> <span class="n">wh</span><span class="p">[...,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ys</span> <span class="o">-</span> <span class="n">wh</span><span class="p">[...,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">wh</span><span class="p">[...,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ys</span> <span class="o">+</span> <span class="n">wh</span><span class="p">[...,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 预测的bbox
</span>    <span class="n">detections</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">([</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">clses</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>   <span class="c1"># b*K*6
</span>
    <span class="k">return</span> <span class="n">detections</span>   <span class="c1"># 得到预测的bbox、分值、类别
</span></pre></table></code></div></div></details><h3 id="p48-损失函数">P4.8 损失函数</h3><p>CtdetTrainer调用CtdetLoss。其位于src/lib/trains/ctdet.py。</p><h4 id="p481-ctdetloss">P4.8.1 CtdetLoss</h4><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">CtdetLoss</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">CtdetLoss</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">crit</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">MSELoss</span><span class="p">()</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">mse_loss</span> <span class="k">else</span> <span class="nc">FocalLoss</span><span class="p">()</span>  <span class="c1"># 使用MSe loss或者focal loss训练关键点热图的损失，实际使用的是focal loss
</span>        <span class="n">self</span><span class="p">.</span><span class="n">crit_reg</span> <span class="o">=</span> <span class="nc">RegL1Loss</span><span class="p">()</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">reg_loss</span> <span class="o">==</span> <span class="sh">'</span><span class="s">l1</span><span class="sh">'</span> <span class="k">else</span> <span class="nc">RegLoss</span><span class="p">()</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">reg_loss</span> <span class="o">==</span> <span class="sh">'</span><span class="s">sl1</span><span class="sh">'</span> <span class="k">else</span> <span class="bp">None</span>  <span class="c1"># 训练回归的损失
</span>        <span class="n">self</span><span class="p">.</span><span class="n">crit_wh</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">L1Loss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">)</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">dense_wh</span> <span class="k">else</span> <span class="nc">NormRegL1Loss</span><span class="p">()</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">norm_wh</span> <span class="k">else</span> <span class="nc">RegWeightedL1Loss</span><span class="p">()</span> <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">cat_spec_wh</span> <span class="k">else</span> <span class="n">self</span><span class="p">.</span><span class="n">crit_reg</span>  <span class="c1"># 预测目标宽高的损失
</span>        <span class="n">self</span><span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">opt</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span>
        <span class="n">hm_loss</span><span class="p">,</span> <span class="n">wh_loss</span><span class="p">,</span> <span class="n">off_loss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">num_stacks</span><span class="p">):</span>   <span class="c1"># 模型为hourglass时num_stacks=2。其他情况为1
</span>            <span class="n">output</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">.</span><span class="n">mse_loss</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">_sigmoid</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">eval_oracle_hm</span><span class="p">:</span>  <span class="c1"># use ground center heatmap
</span>                <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">eval_oracle_wh</span><span class="p">:</span>  <span class="c1"># use ground truth bounding box size
</span>                <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="nf">gen_oracle_map</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">].</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">(),</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">ind</span><span class="sh">'</span><span class="p">].</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">(),</span> <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])).</span><span class="nf">to</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">eval_oracle_offset</span><span class="p">:</span>  <span class="c1"># use ground truth local heatmap offset
</span>                <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">reg</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="nf">gen_oracle_map</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">reg</span><span class="sh">'</span><span class="p">].</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">(),</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">ind</span><span class="sh">'</span><span class="p">].</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">(),</span> <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">reg</span><span class="sh">'</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">reg</span><span class="sh">'</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])).</span><span class="nf">to</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>

            <span class="n">hm_loss</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nf">crit</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">])</span> <span class="o">/</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_stacks</span>  <span class="c1"># 热图的损失
</span>            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">wh_weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 默认0.1  计算预测wh的损失
</span>                <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">dense_wh</span><span class="p">:</span>    <span class="c1"># torch.nn.L1Loss   预测值和真值的绝对值的平均值
</span>                    <span class="n">mask_weight</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">dense_wh_mask</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-4</span>   <span class="c1"># dense_wh_mask为2个热图的最大值concatenate而成：2*output_h*output_h  dense_wh:目标中心和边缘的权重矩阵
</span>                    <span class="n">wh_loss</span> <span class="o">+=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">crit_wh</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">dense_wh_mask</span><span class="sh">'</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">dense_wh</span><span class="sh">'</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">dense_wh_mask</span><span class="sh">'</span><span class="p">])</span> <span class="o">/</span> <span class="n">mask_weight</span><span class="p">)</span> <span class="o">/</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_stacks</span>   <span class="c1"># 模型为hourglass时num_stacks=2。其他情况为1
</span>                <span class="k">elif</span> <span class="n">opt</span><span class="p">.</span><span class="n">cat_spec_wh</span><span class="p">:</span>  <span class="c1"># RegWeightedL1Loss  实际上还是L1 loss   output['wh']：B*2*H*W
</span>                    <span class="n">wh_loss</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nf">crit_wh</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">cat_spec_mask</span><span class="sh">'</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">ind</span><span class="sh">'</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">cat_spec_wh</span><span class="sh">'</span><span class="p">])</span> <span class="o">/</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_stacks</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># NormRegL1Loss(l1_loss(pred/targe1, 1))或者RegL1Loss(l1_loss(pred, targe1))
</span>                    <span class="n">wh_loss</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nf">crit_reg</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">reg_mask</span><span class="sh">'</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">ind</span><span class="sh">'</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">])</span> <span class="o">/</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_stacks</span>

            <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">reg_offset</span> <span class="ow">and</span> <span class="n">opt</span><span class="p">.</span><span class="n">off_weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>   <span class="c1"># off_weight默认1，reg_offset默认True  计算预测wh偏移的损失
</span>                <span class="n">off_loss</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="nf">crit_reg</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">reg</span><span class="sh">'</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">reg_mask</span><span class="sh">'</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">ind</span><span class="sh">'</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="sh">'</span><span class="s">reg</span><span class="sh">'</span><span class="p">])</span> <span class="o">/</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_stacks</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">hm_weight</span> <span class="o">*</span> <span class="n">hm_loss</span> <span class="o">+</span> <span class="n">opt</span><span class="p">.</span><span class="n">wh_weight</span> <span class="o">*</span> <span class="n">wh_loss</span> <span class="o">+</span> <span class="n">opt</span><span class="p">.</span><span class="n">off_weight</span> <span class="o">*</span> <span class="n">off_loss</span>   <span class="c1"># 总的损失
</span>        <span class="n">loss_stats</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">loss</span><span class="sh">'</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span> <span class="sh">'</span><span class="s">hm_loss</span><span class="sh">'</span><span class="p">:</span> <span class="n">hm_loss</span><span class="p">,</span> <span class="sh">'</span><span class="s">wh_loss</span><span class="sh">'</span><span class="p">:</span> <span class="n">wh_loss</span><span class="p">,</span> <span class="sh">'</span><span class="s">off_loss</span><span class="sh">'</span><span class="p">:</span> <span class="n">off_loss</span><span class="p">}</span>  <span class="c1"># 各自的损失
</span>        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">loss_stats</span>
</pre></table></code></div></div></details><h4 id="p482-focalloss">P4.8.2 FocalLoss</h4><p>位于src/lib/models/losses.py。</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_neg_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">gt</span><span class="p">):</span>  <span class="c1"># focal loss，通过class FocalLoss调用
</span>    <span class="sh">'''</span><span class="s"> Modified focal loss. Exactly the same as CornerNet.
        Runs faster and costs a little bit more memory
      Arguments:
        pred (batch x c x h x w)
        gt_regr (batch x c x h x w)
    </span><span class="sh">'''</span>
    <span class="n">pos_inds</span> <span class="o">=</span> <span class="n">gt</span><span class="p">.</span><span class="nf">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>
    <span class="n">neg_inds</span> <span class="o">=</span> <span class="n">gt</span><span class="p">.</span><span class="nf">lt</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>

    <span class="n">neg_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">pow</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">gt</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">pos_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="nf">pow</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pred</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">pos_inds</span>
    <span class="n">neg_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pred</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="nf">pow</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">neg_weights</span> <span class="o">*</span> <span class="n">neg_inds</span>

    <span class="n">num_pos</span> <span class="o">=</span> <span class="n">pos_inds</span><span class="p">.</span><span class="nf">float</span><span class="p">().</span><span class="nf">sum</span><span class="p">()</span>
    <span class="n">pos_loss</span> <span class="o">=</span> <span class="n">pos_loss</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>
    <span class="n">neg_loss</span> <span class="o">=</span> <span class="n">neg_loss</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">num_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">-</span> <span class="n">neg_loss</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_loss</span> <span class="o">+</span> <span class="n">neg_loss</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_pos</span>
    <span class="k">return</span> <span class="n">loss</span>

<span class="k">class</span> <span class="nc">FocalLoss</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">nn.Module warpper for focal loss</span><span class="sh">'''</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">FocalLoss</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">neg_loss</span> <span class="o">=</span> <span class="n">_neg_loss</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">neg_loss</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</pre></table></code></div></div></details><h4 id="p483-regloss">P4.8.3 RegLoss</h4><p>位于src/lib/models/losses.py。</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_reg_loss</span><span class="p">(</span><span class="n">regr</span><span class="p">,</span> <span class="n">gt_regr</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s"> L1 regression loss
      Arguments:
        regr (batch x max_objects x dim)
        gt_regr (batch x max_objects x dim)
        mask (batch x max_objects)
    </span><span class="sh">'''</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">mask</span><span class="p">.</span><span class="nf">float</span><span class="p">().</span><span class="nf">sum</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">expand_as</span><span class="p">(</span><span class="n">gt_regr</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>

    <span class="n">regr</span> <span class="o">=</span> <span class="n">regr</span> <span class="o">*</span> <span class="n">mask</span>
    <span class="n">gt_regr</span> <span class="o">=</span> <span class="n">gt_regr</span> <span class="o">*</span> <span class="n">mask</span>

    <span class="n">regr_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="nf">smooth_l1_loss</span><span class="p">(</span><span class="n">regr</span><span class="p">,</span> <span class="n">gt_regr</span><span class="p">,</span> <span class="n">size_average</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">regr_loss</span> <span class="o">=</span> <span class="n">regr_loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">num</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">regr_loss</span>

<span class="k">class</span> <span class="nc">RegLoss</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">Regression loss for an output tensor
      Arguments:
        output (batch x dim x h x w)
        mask (batch x max_objects)
        ind (batch x max_objects)
        target (batch x max_objects x dim)
    </span><span class="sh">'''</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">RegLoss</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="nf">_transpose_and_gather_feat</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="nf">_reg_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>
</pre></table></code></div></div></details><h4 id="p484-regl1loss">P4.8.4 RegL1Loss</h4><p>位于src/lib/models/losses.py。</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">RegL1Loss</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>    <span class="c1"># l1_loss(pred, targe1)
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">RegL1Loss</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span> 
        <span class="n">pred</span> <span class="o">=</span> <span class="nf">_transpose_and_gather_feat</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>   <span class="c1"># 得到当前batch中每个feat相应索引处的2维特征，不知道ind在哪里转的batch？？？   B*k*2
</span>        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">expand_as</span><span class="p">(</span><span class="n">pred</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>
        <span class="c1"># loss = F.l1_loss(pred * mask, target * mask, reduction='elementwise_mean')
</span>        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="nf">l1_loss</span><span class="p">(</span><span class="n">pred</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">target</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">size_average</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">mask</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>
</pre></table></code></div></div></details><h4 id="p485-normregl1loss">P4.8.5 NormRegL1Loss</h4><p>位于src/lib/models/losses.py。</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">NormRegL1Loss</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>    <span class="c1"># l1_loss(pred/targe1, 1)
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">NormRegL1Loss</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span> 
        <span class="n">pred</span> <span class="o">=</span> <span class="nf">_transpose_and_gather_feat</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>    <span class="c1"># 得到当前batch中每个feat相应索引处的2维特征，不知道ind在哪里转的batch？？？   B*k*2
</span>        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">expand_as</span><span class="p">(</span><span class="n">pred</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>
        <span class="c1"># loss = F.l1_loss(pred * mask, target * mask, reduction='elementwise_mean')
</span>        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span> <span class="o">/</span> <span class="p">(</span><span class="n">target</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="p">)</span>    
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="nf">l1_loss</span><span class="p">(</span><span class="n">pred</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">target</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">size_average</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">mask</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>
</pre></table></code></div></div></details><h4 id="p486-regweightedl1loss">P4.8.6 RegWeightedL1Loss</h4><p>位于src/lib/models/losses.py。</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">RegWeightedL1Loss</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">RegWeightedL1Loss</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>   <span class="c1"># output：B*2*H*W    mask：max_objs*(num_classes*2)    target：max_objs*(num_classes*2)
</span>        <span class="n">pred</span> <span class="o">=</span> <span class="nf">_transpose_and_gather_feat</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>  <span class="c1"># 得到当前batch中每个feat相应索引处的2维特征，不知道ind在哪里转的batch？？？   B*k*2
</span>        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">.</span><span class="nf">float</span><span class="p">()</span>
        <span class="c1"># loss = F.l1_loss(pred * mask, target * mask, reduction='elementwise_mean')
</span>        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="nf">l1_loss</span><span class="p">(</span><span class="n">pred</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">target</span> <span class="o">*</span> <span class="n">mask</span><span class="p">,</span> <span class="n">size_average</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">mask</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>    <span class="c1"># 得到损失
</span></pre></table></code></div></div></details><h4 id="p487-其他函数">P4.8.7 其他函数</h4><p>位于src/lib/models/utils.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">_sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">clamp</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">sigmoid_</span><span class="p">(),</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="mf">1e-4</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="k">def</span> <span class="nf">_gather_feat</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>  <span class="c1"># 得到ind指定的点的channel上的特征  ind是2维（不知代码中什么地方加上的batch）
</span>    <span class="n">dim</span> <span class="o">=</span> <span class="n">feat</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">expand</span><span class="p">(</span><span class="n">ind</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ind</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dim</span><span class="p">)</span>
    <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>       <span class="c1"># 依次得到当前batch中每个feat相应索引处的2维特征  B*k*2
</span>    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">expand_as</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
        <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">feat</span>

<span class="k">def</span> <span class="nf">_transpose_and_gather_feat</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">ind</span><span class="p">):</span>  <span class="c1"># feat：B*2*H*W
</span>    <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="p">.</span><span class="nf">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">contiguous</span><span class="p">()</span>   <span class="c1"># BCHW变成BHWC
</span>    <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="n">feat</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">feat</span><span class="p">.</span><span class="nf">size</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>   <span class="c1"># BHWC变成B*(HW)*C
</span>    <span class="n">feat</span> <span class="o">=</span> <span class="nf">_gather_feat</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>  <span class="c1"># 得到当前batch中每个feat相应索引处的2维特征   B*k*2
</span>    <span class="k">return</span> <span class="n">feat</span>

<span class="k">def</span> <span class="nf">flip_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="p">.</span><span class="nf">flip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="c1"># tmp = x.detach().cpu().numpy()[..., ::-1].copy()
</span>    <span class="c1"># return torch.from_numpy(tmp).to(x.device)
</span></pre></table></code></div></div></details><h3 id="p49-测试时的检测类detector_factory">P4.9 测试时的检测类detector_factory</h3><p>位于src/lib/detectors/detector_factory.py。</p><h4 id="p491-detector_factory">P4.9.1 detector_factory</h4><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">detector_factory</span> <span class="o">=</span> <span class="p">{</span>
  <span class="sh">'</span><span class="s">exdet</span><span class="sh">'</span><span class="p">:</span> <span class="n">ExdetDetector</span><span class="p">,</span> 
  <span class="sh">'</span><span class="s">ddd</span><span class="sh">'</span><span class="p">:</span> <span class="n">DddDetector</span><span class="p">,</span>
  <span class="sh">'</span><span class="s">ctdet</span><span class="sh">'</span><span class="p">:</span> <span class="n">CtdetDetector</span><span class="p">,</span>
  <span class="sh">'</span><span class="s">multi_pose</span><span class="sh">'</span><span class="p">:</span> <span class="n">MultiPoseDetector</span><span class="p">,</span> 
<span class="p">}</span>
</pre></table></code></div></div></details><h4 id="p492-ctdetdetector">P4.9.2 CtdetDetector</h4><p>位于src/lib/detectors/ctdet.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">CtdetDetector</span><span class="p">(</span><span class="n">BaseDetector</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">CtdetDetector</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">return_time</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">model</span><span class="p">(</span><span class="n">images</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 得到模型输出，默认输出为[]，因而取[-1]得到实际输出
</span>            <span class="n">hm</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">].</span><span class="nf">sigmoid_</span><span class="p">()</span>   <span class="c1"># 预测的目标热图
</span>            <span class="n">wh</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">wh</span><span class="sh">'</span><span class="p">]</span>              <span class="c1"># 预测的目标宽高
</span>            <span class="n">reg</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">reg</span><span class="sh">'</span><span class="p">]</span> <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">reg_offset</span> <span class="k">else</span> <span class="bp">None</span>   <span class="c1"># 预测的目标偏移
</span>            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">flip_test</span><span class="p">:</span>   <span class="c1"># 若flip_test为True，则输入网络的batchsize为2，否则为1
</span>                <span class="n">hm</span> <span class="o">=</span> <span class="p">(</span><span class="n">hm</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nf">flip_tensor</span><span class="p">(</span><span class="n">hm</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span> <span class="o">/</span> <span class="mi">2</span>    <span class="c1"># flip_tensor：torch.flip(x, [3])   hm[1]的为水平反转的图像的结果，因而将hm[1]也水平反转，使用[0:1]是为了保持batch维度
</span>                <span class="n">wh</span> <span class="o">=</span> <span class="p">(</span><span class="n">wh</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nf">flip_tensor</span><span class="p">(</span><span class="n">wh</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">synchronize</span><span class="p">()</span>
            <span class="n">forward_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">dets</span> <span class="o">=</span> <span class="nf">ctdet_decode</span><span class="p">(</span><span class="n">hm</span><span class="p">,</span> <span class="n">wh</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span> <span class="n">cat_spec_wh</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">cat_spec_wh</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">K</span><span class="p">)</span>  <span class="c1"># 得到预测的bbox、分值、类别
</span>
        <span class="k">if</span> <span class="n">return_time</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">dets</span><span class="p">,</span> <span class="n">forward_time</span>  <span class="c1"># 返回模型输出，预测信息，前向时间
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">dets</span>

    <span class="k">def</span> <span class="nf">post_process</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dets</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">dets</span> <span class="o">=</span> <span class="n">dets</span><span class="p">.</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">()</span>
        <span class="n">dets</span> <span class="o">=</span> <span class="n">dets</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dets</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">dets</span> <span class="o">=</span> <span class="nf">ctdet_post_process</span><span class="p">(</span><span class="n">dets</span><span class="p">.</span><span class="nf">copy</span><span class="p">(),</span> <span class="p">[</span><span class="n">meta</span><span class="p">[</span><span class="sh">'</span><span class="s">c</span><span class="sh">'</span><span class="p">]],</span> <span class="p">[</span><span class="n">meta</span><span class="p">[</span><span class="sh">'</span><span class="s">s</span><span class="sh">'</span><span class="p">]],</span> <span class="n">meta</span><span class="p">[</span><span class="sh">'</span><span class="s">out_height</span><span class="sh">'</span><span class="p">],</span> <span class="n">meta</span><span class="p">[</span><span class="sh">'</span><span class="s">out_width</span><span class="sh">'</span><span class="p">],</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">num_classes</span><span class="p">)</span> <span class="c1"># 得到当前batch中每个图像各类别的预测信息（bbox、分值），其中0为背景
</span>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>   <span class="c1"># j从1开始，去掉背景
</span>            <span class="n">dets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">dets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>   <span class="c1"># 之前转成list的结果在转会np。。。
</span>            <span class="n">dets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">/=</span> <span class="n">scale</span>
        <span class="k">return</span> <span class="n">dets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># 测试的时候，bs为1，因而返回第0个结果，即当前图像各类别的预测信息（bbox、分值），其中0为背景
</span>
    <span class="k">def</span> <span class="nf">merge_outputs</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">detections</span><span class="p">):</span>   <span class="c1"># detections：当前图像各缩放尺度的各类别的预测信息（bbox、分值）
</span>        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">([</span><span class="n">detection</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">detection</span> <span class="ow">in</span> <span class="n">detections</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>   <span class="c1"># 当前类别在不同尺度上的结果拼接起来
</span>            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">scales</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">nms</span><span class="p">:</span>
                <span class="nf">soft_nms</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">Nt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>   <span class="c1"># 使用soft nms处理第j个类别的结果（对iou进行指数衰减，作为权重给后面的框的分值加权）
</span>        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">hstack</span><span class="p">([</span><span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][:,</span> <span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>  <span class="c1"># 检测到的所有目标的分值
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">max_per_image</span><span class="p">:</span>   <span class="c1"># 超出检测的最大数量
</span>            <span class="n">kth</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">max_per_image</span>  <span class="c1"># 需要去除的检测目标数量
</span>            <span class="n">thresh</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">partition</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">kth</span><span class="p">)[</span><span class="n">kth</span><span class="p">]</span>  <span class="c1"># np.partition将scores[kth]作为阈值，小于该值的都在kth前面，大于该值的都在kth后面。thresh为该阈值
</span>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">keep_inds</span> <span class="o">=</span> <span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">thresh</span><span class="p">)</span>   <span class="c1"># 得到每个类大于该阈值的索引
</span>                <span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">keep_inds</span><span class="p">]</span>      <span class="c1"># 保留每个类超过该阈值的结果
</span>        <span class="k">return</span> <span class="n">results</span>   <span class="c1"># 融合不同尺度各类别的预测信息，并返回各类别的预测信息（bbox、分值）
</span>
    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">debugger</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">dets</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">detection</span> <span class="o">=</span> <span class="n">dets</span><span class="p">.</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">().</span><span class="nf">copy</span><span class="p">()</span>
        <span class="n">detection</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">*=</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">down_ratio</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">().</span><span class="nf">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="p">((</span><span class="n">img</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">std</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">mean</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">debugger</span><span class="p">.</span><span class="nf">gen_colormap</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="sh">'</span><span class="s">hm</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="nf">detach</span><span class="p">().</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">numpy</span><span class="p">())</span>
            <span class="n">debugger</span><span class="p">.</span><span class="nf">add_blend_img</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="sh">'</span><span class="s">pred_hm_{:.1f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">scale</span><span class="p">))</span>
            <span class="n">debugger</span><span class="p">.</span><span class="nf">add_img</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img_id</span><span class="o">=</span><span class="sh">'</span><span class="s">out_pred_{:.1f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">scale</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">dets</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">detection</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">center_thresh</span><span class="p">:</span>
                    <span class="n">debugger</span><span class="p">.</span><span class="nf">add_coco_bbox</span><span class="p">(</span><span class="n">detection</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">detection</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">detection</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">img_id</span><span class="o">=</span><span class="sh">'</span><span class="s">out_pred_{:.1f}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">scale</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">show_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">debugger</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="n">debugger</span><span class="p">.</span><span class="nf">add_img</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">img_id</span><span class="o">=</span><span class="sh">'</span><span class="s">ctdet</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">vis_thresh</span><span class="p">:</span>
                    <span class="n">debugger</span><span class="p">.</span><span class="nf">add_coco_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">img_id</span><span class="o">=</span><span class="sh">'</span><span class="s">ctdet</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">debugger</span><span class="p">.</span><span class="nf">show_all_imgs</span><span class="p">(</span><span class="n">pause</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">pause</span><span class="p">)</span>
</pre></table></code></div></div></details><h4 id="p493-basedetector">P4.9.3 BaseDetector</h4><p>CtdetDetector继承自BaseDetector。BaseDetector位于src/lib/detectors/base_detector.py</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">BaseDetector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">opt</span><span class="p">.</span><span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">opt</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">device</span><span class="p">(</span><span class="sh">'</span><span class="s">cuda</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">opt</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">device</span><span class="p">(</span><span class="sh">'</span><span class="s">cpu</span><span class="sh">'</span><span class="p">)</span>

        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Creating model...</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nf">create_model</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">arch</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">heads</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">head_conv</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">opt</span><span class="p">.</span><span class="n">load_model</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">eval</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">opt</span><span class="p">.</span><span class="n">std</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_per_image</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">self</span><span class="p">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">num_classes</span>
        <span class="n">self</span><span class="p">.</span><span class="n">scales</span> <span class="o">=</span> <span class="n">opt</span><span class="p">.</span><span class="n">test_scales</span>   <span class="c1"># 缩放图像，进行检测
</span>        <span class="n">self</span><span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">opt</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pause</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">pre_process</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>  <span class="c1"># 仿射变换，归一化，转到CHW
</span>        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">new_height</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">new_width</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">fix_res</span><span class="p">:</span>
            <span class="n">inp_height</span><span class="p">,</span> <span class="n">inp_width</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">input_h</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">input_w</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">new_width</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">new_height</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inp_height</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_height</span> <span class="o">|</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">inp_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_width</span> <span class="o">|</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">pad</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">new_width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">new_height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">inp_width</span><span class="p">,</span> <span class="n">inp_height</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">trans_input</span> <span class="o">=</span> <span class="nf">get_affine_transform</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">inp_width</span><span class="p">,</span> <span class="n">inp_height</span><span class="p">])</span>
        <span class="n">resized_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">new_width</span><span class="p">,</span> <span class="n">new_height</span><span class="p">))</span>
        <span class="n">inp_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">warpAffine</span><span class="p">(</span><span class="n">resized_image</span><span class="p">,</span> <span class="n">trans_input</span><span class="p">,</span> <span class="p">(</span><span class="n">inp_width</span><span class="p">,</span> <span class="n">inp_height</span><span class="p">),</span> <span class="n">flags</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>
        <span class="n">inp_image</span> <span class="o">=</span> <span class="p">((</span><span class="n">inp_image</span> <span class="o">/</span> <span class="mf">255.</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">std</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">images</span> <span class="o">=</span> <span class="n">inp_image</span><span class="p">.</span><span class="nf">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">inp_height</span><span class="p">,</span> <span class="n">inp_width</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">flip_test</span><span class="p">:</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">((</span><span class="n">images</span><span class="p">,</span> <span class="n">images</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">c</span><span class="sh">'</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="sh">'</span><span class="s">s</span><span class="sh">'</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span> <span class="sh">'</span><span class="s">out_height</span><span class="sh">'</span><span class="p">:</span> <span class="n">inp_height</span> <span class="o">//</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">down_ratio</span><span class="p">,</span> <span class="sh">'</span><span class="s">out_width</span><span class="sh">'</span><span class="p">:</span> <span class="n">inp_width</span> <span class="o">//</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">down_ratio</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">meta</span>  <span class="c1"># 返回图像及缩放相关信息
</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">return_time</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>   <span class="c1"># 调用派生类的process
</span>        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">post_process</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dets</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>   <span class="c1"># 调用派生类的post_process
</span>        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">merge_outputs</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">detections</span><span class="p">):</span>   <span class="c1"># 调用派生类的merge_outputs
</span>        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">debugger</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">dets</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>     <span class="c1"># 调用派生类的debug
</span>        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">show_results</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">debugger</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>     <span class="c1"># 调用派生类的show_results
</span>        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">image_or_path_or_tensor</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">load_time</span><span class="p">,</span> <span class="n">pre_time</span><span class="p">,</span> <span class="n">net_time</span><span class="p">,</span> <span class="n">dec_time</span><span class="p">,</span> <span class="n">post_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">merge_time</span><span class="p">,</span> <span class="n">tot_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">debugger</span> <span class="o">=</span> <span class="nc">Debugger</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">ipynb</span><span class="o">=</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">debug</span> <span class="o">==</span> <span class="mi">3</span><span class="p">),</span> <span class="n">theme</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">debugger_theme</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">pre_processed</span> <span class="o">=</span> <span class="bp">False</span>   <span class="c1"># 是否已经预处理过了
</span>        <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">image_or_path_or_tensor</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">):</span>   <span class="c1"># 输入为tensor
</span>            <span class="n">image</span> <span class="o">=</span> <span class="n">image_or_path_or_tensor</span>
        <span class="k">elif</span> <span class="nf">type</span><span class="p">(</span><span class="n">image_or_path_or_tensor</span><span class="p">)</span> <span class="o">==</span> <span class="nf">type</span><span class="p">(</span><span class="sh">''</span><span class="p">):</span>       <span class="c1"># 输入为list
</span>            <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">image_or_path_or_tensor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>                                                 <span class="c1"># 输入为dict
</span>            <span class="n">image</span> <span class="o">=</span> <span class="n">image_or_path_or_tensor</span><span class="p">[</span><span class="sh">'</span><span class="s">image</span><span class="sh">'</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nf">numpy</span><span class="p">()</span>
            <span class="n">pre_processed_images</span> <span class="o">=</span> <span class="n">image_or_path_or_tensor</span>
            <span class="n">pre_processed</span> <span class="o">=</span> <span class="bp">True</span>    <span class="c1"># 为dict的话，应该是dataloader送进来的，已经预处理过了
</span>
        <span class="n">loaded_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">load_time</span> <span class="o">+=</span> <span class="p">(</span><span class="n">loaded_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>

        <span class="n">detections</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># 检测结果
</span>        <span class="k">for</span> <span class="n">scale</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">scales</span><span class="p">:</span>   <span class="c1"># 依次检测缩放的图像
</span>            <span class="n">scale_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pre_processed</span><span class="p">:</span>
                <span class="n">images</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pre_process</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>   <span class="c1"># 预处理图像, 返回图像及缩放相关信息
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># import pdb; pdb.set_trace()
</span>                <span class="n">images</span> <span class="o">=</span> <span class="n">pre_processed_images</span><span class="p">[</span><span class="sh">'</span><span class="s">images</span><span class="sh">'</span><span class="p">][</span><span class="n">scale</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">pre_processed_images</span><span class="p">[</span><span class="sh">'</span><span class="s">meta</span><span class="sh">'</span><span class="p">][</span><span class="n">scale</span><span class="p">]</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">.</span><span class="nf">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">synchronize</span><span class="p">()</span>
            <span class="n">pre_process_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">pre_time</span> <span class="o">+=</span> <span class="n">pre_process_time</span> <span class="o">-</span> <span class="n">scale_start_time</span>

            <span class="n">output</span><span class="p">,</span> <span class="n">dets</span><span class="p">,</span> <span class="n">forward_time</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">process</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">return_time</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>   <span class="c1"># 返回模型输出，预测信息，前向时间
</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">synchronize</span><span class="p">()</span>
            <span class="n">net_time</span> <span class="o">+=</span> <span class="n">forward_time</span> <span class="o">-</span> <span class="n">pre_process_time</span>
            <span class="n">decode_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">dec_time</span> <span class="o">+=</span> <span class="n">decode_time</span> <span class="o">-</span> <span class="n">forward_time</span>

            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="n">debugger</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">dets</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>

            <span class="n">dets</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">post_process</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>   <span class="c1"># 调用派生类，如CtdetDetector的post_process，得到当前图像各类别的预测信息（bbox、分值），其中0为背景
</span>            <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">synchronize</span><span class="p">()</span>
            <span class="n">post_process_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">post_time</span> <span class="o">+=</span> <span class="n">post_process_time</span> <span class="o">-</span> <span class="n">decode_time</span>

            <span class="n">detections</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">dets</span><span class="p">)</span>   <span class="c1"># 得到当前图像各缩放尺度的各类别的预测信息（bbox、分值）
</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">merge_outputs</span><span class="p">(</span><span class="n">detections</span><span class="p">)</span>   <span class="c1"># 融合不同尺度各类别的预测信息，并返回各类别的预测信息（bbox、分值）
</span>        <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">synchronize</span><span class="p">()</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
        <span class="n">merge_time</span> <span class="o">+=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">post_process_time</span>
        <span class="n">tot_time</span> <span class="o">+=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">opt</span><span class="p">.</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">show_results</span><span class="p">(</span><span class="n">debugger</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">'</span><span class="s">results</span><span class="sh">'</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span> <span class="sh">'</span><span class="s">tot</span><span class="sh">'</span><span class="p">:</span> <span class="n">tot_time</span><span class="p">,</span> <span class="sh">'</span><span class="s">load</span><span class="sh">'</span><span class="p">:</span> <span class="n">load_time</span><span class="p">,</span> <span class="sh">'</span><span class="s">pre</span><span class="sh">'</span><span class="p">:</span> <span class="n">pre_time</span><span class="p">,</span> <span class="sh">'</span><span class="s">net</span><span class="sh">'</span><span class="p">:</span> <span class="n">net_time</span><span class="p">,</span> <span class="sh">'</span><span class="s">dec</span><span class="sh">'</span><span class="p">:</span> <span class="n">dec_time</span><span class="p">,</span> <span class="sh">'</span><span class="s">post</span><span class="sh">'</span><span class="p">:</span> <span class="n">post_time</span><span class="p">,</span> <span class="sh">'</span><span class="s">merge</span><span class="sh">'</span><span class="p">:</span> <span class="n">merge_time</span><span class="p">}</span>  <span class="c1"># 返回相关结果
</span></pre></table></code></div></div></details><h3 id="p410-nms">P4.10 NMS</h3><p>位于src/lib/external/nms.pyx，包括nms和soft_nms（还有其他的nms，没看）</p><details><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
</pre><td class="rouge-code"><pre><span class="n">cdef</span> <span class="n">inline</span> <span class="n">np</span><span class="p">.</span><span class="n">float32_t</span> <span class="nf">max</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32_t</span> <span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">float32_t</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="n">b</span> <span class="k">else</span> <span class="n">b</span>

<span class="n">cdef</span> <span class="n">inline</span> <span class="n">np</span><span class="p">.</span><span class="n">float32_t</span> <span class="nf">min</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32_t</span> <span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">float32_t</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">b</span> <span class="k">else</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">nms</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">float32_t</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">]</span> <span class="n">dets</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nb">float</span> <span class="n">thresh</span><span class="p">):</span>  <span class="c1"># 原始的nms方式，先对分值降序排序（实际是得到索引order），然后依次抑制
</span>    <span class="n">cdef</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">float32_t</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">]</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">cdef</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">float32_t</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">]</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">cdef</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">float32_t</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">]</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">cdef</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">float32_t</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">]</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">cdef</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">float32_t</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">]</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>

    <span class="n">cdef</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">float32_t</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">]</span> <span class="n">areas</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">cdef</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">int_t</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">]</span> <span class="n">order</span> <span class="o">=</span> <span class="n">scores</span><span class="p">.</span><span class="nf">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># 对分值进行排序
</span>
    <span class="n">cdef</span> <span class="nb">int</span> <span class="n">ndets</span> <span class="o">=</span> <span class="n">dets</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cdef</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">int_t</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">]</span> <span class="n">suppressed</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">ndets</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># nominal indices
</span>    <span class="n">cdef</span> <span class="nb">int</span> <span class="n">_i</span><span class="p">,</span> <span class="n">_j</span>
    <span class="c1"># sorted indices
</span>    <span class="n">cdef</span> <span class="nb">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
    <span class="c1"># temp variables for box i's (the box currently under consideration)
</span>    <span class="n">cdef</span> <span class="n">np</span><span class="p">.</span><span class="n">float32_t</span> <span class="n">ix1</span><span class="p">,</span> <span class="n">iy1</span><span class="p">,</span> <span class="n">ix2</span><span class="p">,</span> <span class="n">iy2</span><span class="p">,</span> <span class="n">iarea</span>
    <span class="c1"># variables for computing overlap with box j (lower scoring box)
</span>    <span class="n">cdef</span> <span class="n">np</span><span class="p">.</span><span class="n">float32_t</span> <span class="n">xx1</span><span class="p">,</span> <span class="n">yy1</span><span class="p">,</span> <span class="n">xx2</span><span class="p">,</span> <span class="n">yy2</span>
    <span class="n">cdef</span> <span class="n">np</span><span class="p">.</span><span class="n">float32_t</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span>
    <span class="n">cdef</span> <span class="n">np</span><span class="p">.</span><span class="n">float32_t</span> <span class="n">inter</span><span class="p">,</span> <span class="n">ovr</span>

    <span class="n">keep</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">ndets</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">suppressed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">keep</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ix1</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">iy1</span> <span class="o">=</span> <span class="n">y1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ix2</span> <span class="o">=</span> <span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">iy2</span> <span class="o">=</span> <span class="n">y2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">iarea</span> <span class="o">=</span> <span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">_j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndets</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">suppressed</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">xx1</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">ix1</span><span class="p">,</span> <span class="n">x1</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">yy1</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">iy1</span><span class="p">,</span> <span class="n">y1</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">xx2</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">ix2</span><span class="p">,</span> <span class="n">x2</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">yy2</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">iy2</span><span class="p">,</span> <span class="n">y2</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">w</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xx2</span> <span class="o">-</span> <span class="n">xx1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">yy2</span> <span class="o">-</span> <span class="n">yy1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">inter</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">h</span>
            <span class="n">ovr</span> <span class="o">=</span> <span class="n">inter</span> <span class="o">/</span> <span class="p">(</span><span class="n">iarea</span> <span class="o">+</span> <span class="n">areas</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">inter</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ovr</span> <span class="o">&gt;=</span> <span class="n">thresh</span><span class="p">:</span>
                <span class="n">suppressed</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">keep</span>

<span class="k">def</span> <span class="nf">soft_nms</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">]</span> <span class="n">boxes</span><span class="p">,</span> <span class="nb">float</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">float</span> <span class="n">Nt</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="nb">float</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">method</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">cdef</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cdef</span> <span class="nb">float</span> <span class="n">iw</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">box_area</span>
    <span class="n">cdef</span> <span class="nb">float</span> <span class="n">ua</span>
    <span class="n">cdef</span> <span class="nb">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cdef</span> <span class="nb">float</span> <span class="n">maxscore</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cdef</span> <span class="nb">int</span> <span class="n">maxpos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cdef</span> <span class="nb">float</span> <span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">tx1</span><span class="p">,</span><span class="n">tx2</span><span class="p">,</span><span class="n">ty1</span><span class="p">,</span><span class="n">ty2</span><span class="p">,</span><span class="n">ts</span><span class="p">,</span><span class="n">area</span><span class="p">,</span><span class="n">weight</span><span class="p">,</span><span class="n">ov</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>   <span class="c1"># 检测到的当前类别目标总数
</span>        <span class="n">maxscore</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>  <span class="c1"># 取出第i个分值作为最大的分值
</span>        <span class="n">maxpos</span> <span class="o">=</span> <span class="n">i</span>  <span class="c1"># 最大分值的位置
</span>
        <span class="n">tx1</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 坐标和分值信息
</span>        <span class="n">ty1</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tx2</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ty2</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>   <span class="c1"># 依次遍历后面的目标
</span>        <span class="c1"># get max box
</span>        <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">maxscore</span> <span class="o">&lt;</span> <span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
                <span class="n">maxscore</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>   <span class="c1"># 得到从i开始的最大分值及位置
</span>                <span class="n">maxpos</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># add max box as a detection 
</span>        <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">maxpos</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 和下段一起，交换i和maxpos的信息
</span>        <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">maxpos</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">maxpos</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">maxpos</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">maxpos</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>

        <span class="c1"># swap ith box with position of max box
</span>        <span class="n">boxes</span><span class="p">[</span><span class="n">maxpos</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx1</span>  <span class="c1"># 和上段一起，交换i和maxpos的信息
</span>        <span class="n">boxes</span><span class="p">[</span><span class="n">maxpos</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ty1</span>
        <span class="n">boxes</span><span class="p">[</span><span class="n">maxpos</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx2</span>
        <span class="n">boxes</span><span class="p">[</span><span class="n">maxpos</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ty2</span>
        <span class="n">boxes</span><span class="p">[</span><span class="n">maxpos</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>

        <span class="n">tx1</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 更新当前位置的信息
</span>        <span class="n">ty1</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tx2</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ty2</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># NMS iterations, note that N changes if detection boxes fall below threshold
</span>        <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">:</span>   <span class="c1"># 依次遍历后面（pos处）的目标
</span>            <span class="n">x1</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>

            <span class="n">area</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 遍历的目标的面积
</span>            <span class="n">iw</span> <span class="o">=</span> <span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">tx2</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="n">tx1</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># 当前框和pos处框的交集的宽
</span>            <span class="k">if</span> <span class="n">iw</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ih</span> <span class="o">=</span> <span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">ty2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="n">ty1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 当前框和pos处框的交集的高
</span>                <span class="k">if</span> <span class="n">ih</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ua</span> <span class="o">=</span> <span class="nf">float</span><span class="p">((</span><span class="n">tx2</span> <span class="o">-</span> <span class="n">tx1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ty2</span> <span class="o">-</span> <span class="n">ty1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">area</span> <span class="o">-</span> <span class="n">iw</span> <span class="o">*</span> <span class="n">ih</span><span class="p">)</span>   <span class="c1"># 并集的面积
</span>                    <span class="n">ov</span> <span class="o">=</span> <span class="n">iw</span> <span class="o">*</span> <span class="n">ih</span> <span class="o">/</span> <span class="n">ua</span> <span class="c1">#iou between max box and detection box    IoU
</span>
                    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># linear
</span>                        <span class="k">if</span> <span class="n">ov</span> <span class="o">&gt;</span> <span class="n">Nt</span><span class="p">:</span>  
                            <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ov</span>    <span class="c1"># IoU较大，给与较小的权重
</span>                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>         <span class="c1"># IoU较小，给与权重为1
</span>                    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># gaussian
</span>                        <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">ov</span> <span class="o">*</span> <span class="n">ov</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span>   <span class="c1"># 指数衰减方式得到权重
</span>                    <span class="k">else</span><span class="p">:</span> <span class="c1"># original NMS
</span>                        <span class="k">if</span> <span class="n">ov</span> <span class="o">&gt;</span> <span class="n">Nt</span><span class="p">:</span>   <span class="c1"># 原始方式，IoU大于阈值，则抑制pos处的相应框（保留当前框），否则保留pos处的相应框
</span>                            <span class="n">weight</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># 抑制pos处的相应框
</span>                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># 保留pos处的相应框
</span>
                    <span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span><span class="o">*</span><span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>   <span class="c1"># 更新pos处框的分值
</span>                                
                    <span class="c1"># if box score falls below threshold, discard the box by swapping with last box
</span>                    <span class="c1"># update N
</span>                    <span class="k">if</span> <span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>  <span class="c1"># pos处框的分值小于阈值，则把最后一个box的信息更新到pos处，同时减少框的数量，并更新pos
</span>                        <span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                        <span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
                        <span class="n">boxes</span><span class="p">[</span><span class="n">pos</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
                        <span class="n">N</span> <span class="o">=</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span>   <span class="c1"># 减少框的数量
</span>                        <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># 因为都在while循环里面，替换boxes[N-1]到boxes[pos]后，需要重新比较pos处的框，因而此处pos-1，下面pos+1后，重新比较pos处的框
</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">keep</span>
</pre></table></code></div></div></details></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div class="post-tags"> <span>标签(Tags)</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a href="/tags/deep-learning/" class="post-tag no-text-decoration" >deep learning</a> <a href="/tags/algorithm/" class="post-tag no-text-decoration" >algorithm</a> <a href="/tags/detection/" class="post-tag no-text-decoration" >detection</a> <a href="/tags/detection/" class="post-tag no-text-decoration" >detection</a></div></div><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/UbuntuAgent/">Ubuntu使用代理</a><li><a href="/posts/SunloginDisconnectWin10/">windows10使用向日葵访问ubuntu 20.04显示连接已断开</a><li><a href="/posts/TimeWin10Ubuntu/">windows10和ubuntu双系统的时间差</a><li><a href="/posts/markdown/">markdown基本语法</a><li><a href="/posts/MountDriverInWin10Ubuntu/">windows10的ubuntu子系统挂载移动硬盘</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/deep-learning/">deep learning</a> <a class="post-tag" href="/tags/detection/">detection</a> <a class="post-tag" href="/tags/normalization/">normalization</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/transformers/">transformers</a> <a class="post-tag" href="/tags/demo/">demo</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h6 align="left"><br>未设置提醒，因而不一定能看到回复，见谅</h6><div class="post-navigation d-flex justify-content-between"> <a href="/posts/DETR/" class="btn btn-outline-primary" prompt="Older"><p>DETR End-to-End Object Detection with Transformers</p></a> <a href="/posts/SSD/" class="btn btn-outline-primary" prompt="Newer"><p>SSD Single Shot MultiBox Detector</p></a></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script> <script src="https://code.jquery.com/jquery-3.2.0.min.js"></script> <script>AV.initialize("7DUQTBuCCKLjnutJOa6ko5cn-MdYXbMMI", "lxmthTQ8ESa2HrVQiIVyXtYo");</script> <script> //新增访问次数 function addCount(Counter) { // 页面（博客文章）中的信息：leancloud_visitors // id为page.url， data-flag-title为page.title var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(Counter); // 只根据文章的url查询LeanCloud服务器中的数据 query.equalTo("post_url", url); query.find({ success: function(results) { if (results.length > 0) {//说明LeanCloud中已经记录了这篇文章 var counter = results[0]; counter.fetchWhenSave(true); counter.increment("visited_times");// 将点击次数加1 counter.save(null, { success: function(counter) { var $element = $(document.getElementById(url)); var newTimes = counter.get('visited_times'); $element.find('.leancloud-visitors-count').text(newTimes); }, error: function(counter, error) { console.log('Failed to save Visitor num, with error message: ' + error.message); } }); } else { // 执行这里，说明LeanCloud中还没有记录此文章 var newcounter = new Counter(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); newcounter.setACL(acl); /* End Set ACL */ newcounter.set("post_title", title);// 把文章标题 newcounter.set("post_url", url); // 文章url newcounter.set("visited_times", 1); // 初始点击次数：1次 newcounter.save(null, { // 上传到LeanCloud服务器中 success: function(newcounter) { var $element = $(document.getElementById(url)); var newTimes = newcounter.get('visited_times'); $element.find('.leancloud-visitors-count').text(newTimes); }, error: function(newcounter, error) { console.log('Failed to create'); } }); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); } }); } //仅根据url和title查出当前访问次数，不做+1操作 function showCount(Counter) { var $visitors = $(".leancloud_visitors"); var url = $visitors.attr('id').trim(); var title = $visitors.attr('data-flag-title').trim(); var query = new AV.Query(Counter); // 只根据文章的url查询LeanCloud服务器中的数据 query.equalTo("post_url", url); query.find({ success: function(results) { if (results.length > 0) {//说明LeanCloud中已经记录了这篇文章 var counter = results[0]; var $element = $(document.getElementById(url)); var newTimes = counter.get('visited_times'); $element.find('.leancloud-visitors-count').text(newTimes); } else { //如果表里没查到记录，那就是异常情况了 console.log('异常情况，不应该没记录的'); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); } }); } //调用API获取IP function getVisitorIpAndJudge() { var ip; var options = { type: 'POST', dataType: "json", //async: false, //jquery3中可以直接使用回调函数，不用再指定async url: "https://freegeoip.net/json/?callback=?" }; $.ajax(options) .done(function(data, textStatus, jqXHR) { if(textStatus == "success") { ip = data.ip; } judgeVisitor(ip) }); } //判断访客是否已访问过该文章，及访问时间，符合条件则增加一次访问次数 function judgeVisitor(ip) { var Counter = AV.Object.extend("visited_times"); var Visitor = AV.Object.extend("visitors_record"); var $postInfo = $(".leancloud_visitors"); var post_url = $postInfo.attr('id').trim(); var query = new AV.Query(Visitor); query.equalTo("visitor_ip", ip); query.equalTo("post_url", post_url); query.find({ success: function(results) { if (results.length > 0) { console.log('该IP已访问过该文章'); var oldVisitor = results[0]; var lastTime = oldVisitor.updatedAt; var curTime = new Date(); var timePassed = curTime.getTime() - lastTime.getTime(); if(timePassed > 1 * 60 * 1000) { console.log('距离该IP上一次访问该文章已超过了1分钟，更新访问记录，并增加访问次数'); addCount(Counter); oldVisitor.fetchWhenSave(true); oldVisitor.save(null, { success: function(oldVisitor) { }, error: function(oldVisitor, error) { console.log('Failed to save visitor record, with error message: ' + error.message); } }); } else { console.log('这是该IP 1分钟内重复访问该文章，不更新访问记录，不增加访问次数'); showCount(Counter); } } else { console.log('该IP第一次访问该文章，保存新的访问记录，并增加访问次数'); addCount(Counter); var newVisitor = new Visitor(); /* Set ACL */ var acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); newVisitor.setACL(acl); newVisitor.set("visitor_ip", ip); newVisitor.set("post_url", post_url); newVisitor.save(null, { // 上传到LeanCloud服务器中 success: function(newVisitor) { }, error: function(newVisitor, error) { console.log('Failed to create visitor record, with error message: ' + error.message); } }); } }, error: function(error) { console.log('Error:' + error.code + " " + error.message); addCount(Counter); } }); } $(function() { if ($('.leancloud_visitors').length == 1) { // 文章页面，调用判断方法，对符合条件的访问增加访问次数 getVisitorIpAndJudge(); } else if ($('.post-link').length > 1){ // 首页 暂未使用 // showHitCount(Counter); } }); </script><div> <span id="/posts/CenterNet/" class="leancloud_visitors" data-flag-title="CenterNet Objects as Points"> <a href="#">Pageviews:<span class="leancloud-visitors-count"></span> times</a></span></div><h4 align="left">用户留言：</h4><div id="comments"></div><script src='//unpkg.com/valine/dist/Valine.min.js'></script> <script> new Valine({ av: AV, el: '#comments', app_id: '7DUQTBuCCKLjnutJOa6ko5cn-MdYXbMMI', app_key: 'lxmthTQ8ESa2HrVQiIVyXtYo', placeholder: '', avatar: 'mp', notify: 'true', verify: 'true', recordIP: 'true', enableQQ: 'true', visitor: true }); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#main > div.row:first-child > div:first-child img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="">darkknightzh</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/deep-learning/">deep learning</a> <a class="post-tag" href="/tags/detection/">detection</a> <a class="post-tag" href="/tags/normalization/">normalization</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/transformers/">transformers</a> <a class="post-tag" href="/tags/demo/">demo</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://darkknightzh.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
